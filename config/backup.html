<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * "Backup / Restore" management
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var bkp_path = "/var/lib/asterisk/static-http/config/bkps/";
var bkpfile ;

function localajaxinit() {
	showdiv_statusmessage();
	setWindowTitle("Backup");
	parent.loadscreen(this);
	var d = _$('status_message'); 
	d.style.top = 100;
	d.style.left = 100;
}


function addzero(x){
if ( x < 10)
	return "0" + x;
return x;
}

function removebkpfile(){
	_$('message_text').innerHTML = "Please wait while the system <BR> Generates a Backup ... ";
	_$('status_message').style.display="block";
	//remove bkpfile on server 
	parent.astmanEngine.run_tool("/bin/rm " + bkp_path+ "conf_* -f", download_bkp );
}


function showremovebkpfile(){
	_$('status_message').style.display='none';
//	$('message_text').innerHTML =  "<A href=\"#\" onclick=\"removebkpfile()\">I have downloaded the file</A><BR><BR>" + "<A href=\"./bkps/"+ bkpfile  +"\" onclick=\"showremovebkpfile()\">ReDownload</A>";
}

function download_bkp(){

	var today=new Date()
	var year = today.getFullYear();
	var month = addzero(today.getMonth() + 1);
	var day = addzero(today.getDate());
	var hour =addzero(today.getHours());
	var minute =addzero(today.getMinutes());
	var seconds =addzero(today.getSeconds());
	bkpfile =  "conf_" + year + month + day + hour  + minute +seconds  +".tar";
	parent.astmanEngine.run_tool("/bin/tar -cf "+ bkp_path + bkpfile +" /etc/asterisk/", callback=function(){
		_$('status').innerHTML = " <I> Finished generating Backup ! </I>";
		_$('status_message').style.display="none";
		window.location.href = "./bkps/"+ bkpfile ;
		//$('message_text').innerHTML = "<A href=\"./bkps/"+ bkpfile  +"\" onclick=\"showremovebkpfile()\">Click Here to Download</A>";
	} );
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Download Configuration Backup</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr>	<td align=center height=30><BR><BR><div id="status"></div></td></tr>
	<tr>	<td valign="top" align="center">
			<BR><BR>
			<Input type="button" onclick="removebkpfile()" value="Download a Configuration backup">	
		</td>
	</tr>
	<tr>	<td valign="top" align="center">
			<BR><BR>
			<font size="-1">
			Note: Restoring a configuration backup will be added soon to this section !<BR>
			Work in Progress
			</font>
		</td>
	</tr>
</table>
</div>
</body>

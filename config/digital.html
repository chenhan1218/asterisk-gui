<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Digital Card Setup / Detection 
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Brandon Kruse <bkruse@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<style>

	.taglist {
		border: 1px solid #666666;
		margin-top:10px;
		margin-bottom:30px;
		max-width: 745;
	}

	.taglist tr.frow {
		background-color: #6b79a5;
	}

	.taglist tr.even {
		background-color: #DFDFDF;
	}

	.taglist tr.odd{
		background-color: #FFFFFF;
	}

	.taglist tr.even:hover, .taglist tr.odd:hover {
		background-color: #a8b6e5;
	}
</style>

<script>
var SPANS = {};

function hide_mymenu(){
	document.getElementById('mymenu').style.display="none"; 
}

function preparemenus(){
	/*
	var menu_div = document.getElementById('mymenu') ;
	menu_div.style.width="80";
	menu_div.style.borderColor = "#eee #bbb #bbb #ddd";
	ASTGUI.events.add( document.body , "click", function(){ _$('mymenu').style.display="none"; } );

	var menuitem1 = document.createElement('div');
	menuitem1.innerHTML = "Edit" ;
	menuitem1.onclick =  function(){ hide_mymenu( ); editSP( this.parentNode.sp_value) };
	menuitem1.onmouseover= function(){  
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF';  
	};
	menuitem1.onmouseout=function(){  
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF';  
	};
	menu_div.appendChild(menuitem1);
	*/
}


function showtable(){ // navigates through the SPANS object and presents as a table to the user
	var tbl = _$('digitalcardstable') ;

	var add_fRow = function(){
		var newRow = tbl.insertRow(-1);
		newRow.className = "frow";

		var newCell0 = newRow.insertCell(0);
		newCell0.innerHTML = "SPAN";

		var newCell1 = newRow.insertCell(1);
		newCell1.innerHTML = "ALARMS";

		var newCell2 = newRow.insertCell(2);
		newCell2.innerHTML =  "Framing/Coding";

		var newCell3 = newRow.insertCell(3);
		newCell3.innerHTML = "channels<BR>Used/Total" ;
		newCell3.align = "center";

		var newCell4 = newRow.insertCell(4);
		newCell4.innerHTML = "" ;
	};

	var addrow_totable = function(span){
		var sno = tbl.rows.length + 1;
		var newRow = tbl.insertRow(-1);
		newRow.className = ((tbl.rows.length)%2==1)?"odd":"even";

		newRow.id ="row" + span ;
		newRow["span_value"] = span;

		var newCell0 = newRow.insertCell(0);
		newCell0.innerHTML = SPANS[span]['description'] + "&nbsp;&nbsp;";
		newCell0.align = "center";
	
		var newCell1 = newRow.insertCell(1);
		newCell1.innerHTML = SPANS[span]['alarms'];
		newCell1.align = "center";

		var newCell2 = newRow.insertCell(2);
		newCell2.innerHTML =  SPANS[span]['fac'];

		var newCell3 = newRow.insertCell(3);
		var type = (SPANS[span]['totchans'] <= 24) ? "T1" : "E1";
		SPANS[span]['type'] = type;
		newCell3.innerHTML = String(SPANS[span]['usedchans']) + "/" + String(SPANS[span]['totchans']) + " " + type;
		newCell3.align = "center";


		var newCell4 = newRow.insertCell(4);
		newCell4.innerHTML = "Edit" ;
		newCell4.style.width = 90;
		newCell4.align = "center";
	};

	ASTGUI.domActions.clear_table(tbl);
	add_fRow();
	for( var k in SPANS ){ if( SPANS.hasOwnProperty(k) ){ addrow_totable(k); } }

}

function digitalparse(n){
	if( n == "ERROR: CONFIG FILE NOT FOUND"){
		alert("Please check if ztscan is installed ? \n\n /etc/asterisk/ztscan.conf not found");
		gui_feedback("Problem detecting digital cards. No Cards/Spans found !! <BR>  No Config File");
		//_$('tablecontainer').style.display="none";
		return false;
	}

	for( var l in n ){ if(n.hasOwnProperty(l)){
		if( l =='general') { 
			if(n[l]['continue'] && n[l]['continue'] == "no") {
				alert("Problem Detecting/No Cards(or spans) Found! \n\n Error: " + n[l]['error']);
				gui_feedback("Problem detecting digital cards. No Cards/Spans found !!");
				//_$('tablecontainer').style.display="none";
				return false;
			}
			if(n[l]['continue'] && n[l]['continue'] == "yes") {
				//var t = (n[l]['totalspans']) ? n[l]['totalspans'] : 'Unknown';
				if(n[l]['isnew'] && n[l]['isnew'] == "yes") {
					var uri = build_action('update', 0, 'general', 'isnew', 'no', '');
					makerequest('u','ztscan.conf', uri, function(t){ return true;} );
				}
			}
			continue;
		}
		SPANS[l] = {};
		for( var k in n[l] ){ if(n[l].hasOwnProperty(k)){ SPANS[l][k] = n[l][k]; }}
	}}
	showtable();
}

function localajaxinit(){
	setWindowTitle("Digital Setup Wizard");
	top._$('mainscreen').width= 798;
	showdiv_statusmessage(); // create status message dialog
	_$('message_text').innerHTML = "Detecting Digital Cards ... (Beta)";
	_$('status_message').style.display="block";
	setTimeout(function(){ _$('status_message').style.display='none';}, 1000);

	parent.loadscreen(this);
	parent.astmanEngine.run_tool(asterisk_guiZtscan, function(t) { // run ztscan and then try loading ztscan.conf
		setTimeout( function(){ config2json("ztscan.conf", 1, digitalparse); } , 700); // leave some time for ztscan to generate ztscan.conf
	});

}

function resetmainscreen(){ top._$('mainscreen').width= 540; }

</script>
<body onload="localajaxinit()" onunload="resetmainscreen()" bgcolor="#FFFFFF">

<div style="font-size : 12px; padding : 4px 6px 4px 6px; border-style : solid none solid none; border-top-color : #BDC7E7; border-bottom-color : #182052; border-width : 1px 0px 1px 0px; background-color : #ef8700; color : #ffffff;">
	<span style="margin-left: 4px;font-weight:bold;">Digital Card Configuration Wizard (Beta)</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>

<center><font size="+1">Digital Card Setup</font></center>

<div style="overflow:auto;left:40">
	<table class="taglist" id="digitalcardstable" cellpadding=5 cellspacing=1 border=0 align=center></table>
</div>

<div id="mymenu" class="mymenu" style="display:none"></div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 0; width:100%; height:100%;  background-color:#FFFFFF; filter:alpha(opacity=50); -moz-opacity:.50;opacity:.50; border-width: 0px; z-index:4">
</div>



</body>
</html>
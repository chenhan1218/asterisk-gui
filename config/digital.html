<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Digital Card Setup / Detection 
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Brandon Kruse <bkruse@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<style>
	.tr0 {
		background-color: #efaa50;
		color: white;
		font-weight: bold;
	}

	.tr1 {
		background-color: #6b79a5;
		color: white;
		font-weight: bold
	}

	.tr2 {
		background-color: white;
		color: black;
		text-decoration: underline;
	}

	.tr0 td, .tr1 td, .tr2 td {
		font-size: xx-small;
	}

	.taglist {
		border: 1px solid #666666;
		margin-top:40px; margin-bottom:30px;
	}
	
	.taglist tbody tr td {
		font-family: "lucida grande", verdana, sans-serif;
		font-size: 8pt;
		padding: 3px 8px;
		border-left: 1px solid #D9D9D9;
	}

	.taglist tbody tr.selected td {
		background-color: #3d80df;
		color: #ffffff;
		font-weight: bold;
		border-left: 1px solid #346DBE;
		border-bottom: 1px solid #7DAAEA;
	}

</style>

<script>

var sysinfocallbacks = new Object;
var zt_cb = new Object;
var tabs = new Array('tab1', 'tab2', 'tab3');
var divs_tohide = new Array('osversion_div', 'uptime_div', 'asterisk_div', 'today_div','hostname_div','ifconfig_div','df_div','memory_div');
var has_spans = 0; /* Count of our spans we have, incrementing each time. */
var total_spans = 0; /* Count of our spans that ztscan.conf says we have */
var old_zap = 0;
var widgets = {};
var fieldnames = [ 'active', 'alarms', 'description', 'name', 'totchans', 'fac', 'lbo' ]; 
var fieldnames_clickable = [ 'active', 'fac', 'lbo' ]; 
var fieldnames_proper = [ 'Out Of Alarm:', 'Alarms:', 'Card Description:', 'Card Name:', 'Total Channels:', 'Framing/Coding', 'Line Build Out' ]; 

/* This page is based off of sample.html, the gui tutorial on writing a page */

/* Function used in the GUI to show and hide the different tabs we defined, pretty basic. */
function show_window(x){
	for(i=0; i < tabs.length ; i++){
		_$(tabs[i]).className = "tab";
	}
	_$(tabs[x]).className = "tabselected";
	_$(tabs[x]).blur();

	/* Traverse through the tabs to see which one we want to display. */
	if(divs_tohide[x]) {
		var divs_toshow = new Array(divs_tohide[x]);
		/* Here we will declare divs to show as whatever element in the array is the tab we want to show! */
	} else { 
		return false;
		/* We did not find the tab that we were called to show. */
	}

	/* Here we will hide all of our divs that we do not want to show, and then show our last div. */
	for(var i=0; i < divs_tohide.length; i++ ) {
		_$(divs_tohide[i]).style.display = "none";
	}
	for(var i=0; i < divs_toshow.length; i++ ) {
		_$(divs_toshow[i]).style.display = "";
	}

	return true;
}

zt_cb.format = function(t) { 
	return t.fieldbyname['active']; 
};

zt_cb.loaded = function() { 
	loadCardsintoTable();
	return true;
};

function update_table() {
	
	var e = _$("cdr_content_container");
	e.innerHTML = "";
	var d = document.createElement("TABLE");
	d.style.overflow = "scroll" ;
	var tr = document.createElement("tr");
	tr.className = "tr2";
		for(var i=0;i<=records[offset].length;i++) {
			var td = document.createElement("td");
			td.appendChild(document.createTextNode(fields[i]));
			tr.appendChild(td);
		}
		d.appendChild(tr);
		for(var i=0;c--&&isset(records[i+offset]);i++) {
			var tr = document.createElement("tr");
			tr.className = "tr"+(i%2);
			var r = records[i+offset];
		
		for(var j=-1;j<r.length;j++) {

			if(r[(j + 4)])	
				var dest_context = (r[j + 4].toString().replace(/^[\"]{1}/, "").replace(/[\"]{1}$/, "")) ? r[j + 4].toString().replace(/^[\"]{1}/, "").replace(/[\"]{1}$/, "") : 'none';
			if(dest_context == "asterisk_guitools") {
				j += fields.length-3;
				/* go to next cdr record, which is exact 21 csvs away, so count the csv field names, and subtract 3, since we only added 4, and started with -1 */
				continue;
			} 
			var td = document.createElement("td");
			if (j < 0) {
				var l = offset+i+1;
			} else {
				var l = r[j].toString().replace(/^[\"]{1}/, "").replace(/[\"]{1}$/, "");
			}
			td.appendChild(document.createTextNode(l));
			tr.appendChild(td);
		}
		d.appendChild(tr);
	}
	e.appendChild(d);
}
	
function create_table_names() {
	var box = _$('digitalcardstable');
	var tr = document.createElement("tr");
	tr.className="tr1";	
	for(var i=0; i < fieldnames_proper.length; i++) {
		var td = document.createElement("td");
		td.appendChild(document.createTextNode(fieldnames_proper[i]));
		tr.appendChild(td);	
	}
	box.appendChild(tr);	
	return true;

}
function isInt(x) {
	var y=parseInt(x);
	if (isNaN(y)) return false;
		return x==y && x.toString()==y.toString();
} 

function run_zt_and_restart() {
	/* this function will run ztcfg and reload the page. */
	gui_alert("This is a place holder, if you see this its probably because you need to run ztcfg, and running it is not in this page yet.");
}

function option_clicked(a) {
	/* place holder for the option clicked callback for the event. */
	alert(a);
	return true;
}
function digitalparse(n) { 

	var l, h;
	var box = _$('digitalcardstable');
	var _class = 0;
	for( l in n ){	if(n.hasOwnProperty(l)){
		if( l =='general') { 
			if(n[l]['continue'] && n[l]['continue'] == "no") {
				_$('error_txt').style.display="";
				_$('error_txt').innerHTML="<br><br>Problem Detecting/No Cards(or spans) Found!<br><br>  Error: " + n[l]['error'];		
				has_spans=0;
				_$('tablecontainer').style.display="none";
				_$('tablecontainer').style.visibility="none";

				return false;
			}
			if(n[l]['continue'] && n[l]['continue'] == "yes") {
				total_spans = (n[l]['totalspans']) ? n[l]['totalspans'] : 'Unknown';
				has_spans=1;
				if(n[l]['isnew'] && n[l]['isnew'] == "yes") {
					var uri = build_action('update', 0, 'general', 'isnew', 'no', '');
			                makerequest('u','ztscan.conf', uri, function(t){ return true;} );
				}
				create_table_names();
			}
		}
		if(isInt(l)) { 
			var tr = document.createElement("tr");
			if(_class == 0) {
				tr.className = "tr0";
				_class = 1;
			} else {
				tr.className = "tr1";
				_class = 0;
			}
			/* if alarms is red, make cell red, else make cell green/yellow etc. */
			for(var i=0; i < fieldnames.length; i++) {
				var td = document.createElement("td");
				if(fieldnames[i] == 'lbo' && n[l][fieldnames[i]] == "NODEF") {
					old_zap = 1;	
					td.appendChild(document.createTextNode("N/A"));
					tr.appendChild(td);	
					continue;
				}
				if(fieldnames[i] == 'fac') {
					if(n[l][fieldnames[i]] == "NODEF") {
						old_zap = 1;	
						td.appendChild(document.createTextNode("N/A"));
						tr.appendChild(td);	
						continue;
					}
					var framing = n[l][fieldnames[i]].split("/");
					if(framing[0] == "ESF" || framing[0] == "D4") {
						td.appendChild(document.createTextNode(n[l][fieldnames[i]] + " (T1)"));
						td.setAttribute("id", l + '-' + fieldnames[i]);
						tr.appendChild(td);	
						continue;
					} else {
						td.appendChild(document.createTextNode(n[l][fieldnames[i]] + " (E1)"));
						td.setAttribute("id", l + '-' + fieldnames[i]);
						tr.appendChild(td);	
						continue;
					}
				}
				if(fieldnames[i] == 'alarms') {
					if(n[l][fieldnames[i]] == "UNCONFIGURED") {
						gui_alert("Span " + (i+1) + " is unconfigured, running ztscan.");
						run_zt_and_restart();
					}
				}
				td.appendChild(document.createTextNode(n[l][fieldnames[i]]));
				td.setAttribute("id", l + '-' + fieldnames[i]);
				tr.appendChild(td);	
			}
			box.appendChild(tr);	
		}
	}}
	if(old_zap == 1) {	
		gui_alert("To have the ability to see your cards current configuration/framing/coding/line build out, please install rev: 2986 or higher of the 1.4 branch of zaptel!");
		parent._$('tooltip').innerHTML = "<B>Framing/Coding/Line Build Out:</B><br>To see this requires rev: 2986 of the 1.4 branch of zaptel.";
	}

	_$('tablecontainer').style.display="";
	_$('tablecontainer').style.visibility="";


	_$('status_message').style.display='none';

	return true;
}

function addrow_totable(span_txt, span_value) {
	var _spt = _$('spanTable') ;
	var sno = _spt.rows.length + 1;
	var newRow = _spt.insertRow(-1);
	newRow.id ="row" + span_value ;
	newRow["span_value"] = span_value ;

	var newCell0 = newRow.insertCell(0);
	newCell0.innerHTML = sno;
	newCell0.style.width = 40;

	var newCell1 = newRow.insertCell(1);
	var dev_iq = (_$('devices').stored_config.catbyname[span_value].fieldbyname['fac']) ? _$('devices').stored_config.catbyname[span_value].fieldbyname['fac'] : 'N/A';
	var tmp = dev_iq.split("/");
	if(tmp[0] == "ESF" || tmp[0] == "D4" && tmp[0] != "N/A") {
		_$('id_type').innerHTML = "(T1)";
	} else { 
		_$('id_type').innerHTML = "(E1)";
	}
	newCell1.innerHTML = dev_iq;

	var newCell2 = newRow.insertCell(2);
	newCell2.innerHTML = "AHHHH";
	newCell2.align = "center";
	newCell2.style.width = 50;

	var newCell3 = newRow.insertCell(3);
	newCell3.innerHTML = "<span class=\"downmenubutton\" id='" + "span_" + span_value  + "' onclick=\"show_downmenu( '"+ span_value + "');\">Options&nbsp;&nbsp;<img src=images/1.gif></span>" ;
	newCell3.style.width = 90;
	newCell3.align = "center";

	return true;
}

function preparemenus(){
	var menu_div = document.getElementById('mymenu') ;
	menu_div.style.width="80";
	menu_div.style.borderColor = "#eee #bbb #bbb #ddd";
	ASTGUI.events.add( document.body , "click", function(){ _$('mymenu').style.display="none"; } );

	var menuitem1 = document.createElement('div');
	menuitem1.innerHTML = "Edit" ;
	menuitem1.onclick =  function(){ hide_mymenu( ); editSP( this.parentNode.sp_value) };
	menuitem1.onmouseover= function(){  
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF';  
	};
	menuitem1.onmouseout=function(){  
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF';  
	};
	menu_div.appendChild(menuitem1);

	var menuitem2 = document.createElement('div');
	menuitem2.innerHTML = "Framing/Coding" ;

	menuitem2.onclick =  function(){
		var _devices = _$('devices');
		for(var i=0; i< _devices.length; i++){
			if( this.parentNode.sp_value == _devices.options[i].value ){
				_devices.selectitem(i);
				break;
			}
		}
	};
	menuitem2.onmouseover= function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF'; 
	};
	menuitem2.onmouseout=function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF'; 
	};
	menu_div.appendChild(menuitem2);

	var menuitem4 = document.createElement('div');
	menuitem4.innerHTML = "Advanced" ;
	menuitem4.onclick =  function(){  
		alert("advanced");
		var _devices = _$('devices');
 		for(var i=0; i< _devices.length; i++){
			if( this.parentNode.sp_value == _devices.options[i].value ){
				_devices.selectitem(i);
				_$('bg_transparent').style.display = "";
				_$('custom_trunkname').value = _$('name').value ;
				_$('advanced_content').style.display = "";  
				break;
			}
		}
	};
	menuitem4.onmouseover= function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF'; 
	};
	menuitem4.onmouseout=function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF'; 
	};
	menu_div.appendChild(menuitem4);

	var menuitem3 = document.createElement('div');
	menuitem3.innerHTML = "Delete" ;
	menuitem3.onclick =  function(){  hide_mymenu( );  deleteSP( this.parentNode.sp_value );  };
	menuitem3.onmouseover= function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF'; 
	};
	menuitem3.onmouseout=function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF'; 
	};
	menu_div.appendChild(menuitem3);

}

function show_downmenu( a ) {
	var menu = document.getElementById('mymenu');
	menu.sp_value = "";
	menu.sp_value = a ;
	
	var tmp_left = _$("span_"+a).offsetLeft;
	var tmp_top = _$("span_"+a).offsetTop + _$("span_"+a).offsetHeight;
	var tmp_parent = _$("span_"+a);
	while(tmp_parent.offsetParent != document.body){
		tmp_parent = tmp_parent.offsetParent;
		tmp_left += tmp_parent.offsetLeft;
		tmp_top += tmp_parent.offsetTop;
	}

	menu.style.top =tmp_top ;
	menu.style.left = tmp_left ;
	setTimeout( function(){ _$('mymenu').style.display=""; } , 100 );
}


function update_sysinfo(){
	parent.astmanEngine.run_tool(asterisk_guiSysInfo , onSuccess = function() {
			_$('status_message').style.display='none';
			getsysinfohtml();
		}
	);
	return;
}

function loadCardsintoTable(){
        var _spt = _$('spanTable');
        for( var i=0; i <  _spt.rows.length; i++){
                _spt.deleteRow(i);
        }
        var _devices = _$('devices');

        if( _devices.length == "0" ){
                _$('table_one').style.display="none";
                var newRow = _spt.insertRow(-1);
                var newCell0 = newRow.insertCell(0);
                newCell0 .align = "center";
                newCell0 .innerHTML = "<BR>No <I>Digital Cards</I> Found<BR><BR> Please click on the 'Scan' button<BR>To scan for Digital Cards<BR><BR>" ;
                return true;
        }

        _$('table_one').style.display="";
        for(var x=0; x < _devices.length; x++){
               	addrow_totable(_devices.options[x].text, _devices.options[x].value);
        }
	return true;

}

function load_config_tool() { 
	if(!config2json("ztscan.conf", 1, digitalparse)) {
		alert("Have you properly installed ztscan?\n/etc/asterisk/ztscan.conf does not exist.");
		_$('error_txt').style.display="";
		_$('error_txt').innerHTML="<br><br>Problem Detecting/No Cards(or spans) Found!<br><br>  Error: No Config File";		
		_$('tablecontainer').style.display="none";
	} else {
		/* Our config file was found....we can parse the options into widgets and _$('devices') */
		parent.astmanEngine.config2list("ztscan.conf", _$('devices'), widgets, zt_cb);
	}
}

function localajaxinit() {
	ASTGUI.events.add(document, 'mouseover', show_tooltip);
	showdiv_statusmessage();
	_$('status_message').style.display="block";
	setTimeout("_$('status_message').style.display='none'", 5000);
	_$('message_text').innerHTML = "Detecting Digital Cards ... (Beta)";
	setWindowTitle("Digital Setup Wizard");
	parent.loadscreen(this);
	/* Give ztscan 4 seconds to detect and write to ztscan.conf */
	parent.astmanEngine.run_tool(asterisk_guiZtscan, function(t) {
		setTimeout('load_config_tool()', 4000); 
	});
	for (var x=0; x < fieldnames.length; x++ ) {
		widgets[fieldnames[x]] = _$(fieldnames[x]);
		widgets[fieldnames[x]].disabled = true;
	}
}

function free_mem(){
	if( navigator.userAgent.indexOf("MSIE") == -1 ){ return true; }
	try{
		purge( document.body );
	} catch(e){ }
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="#FFFFFF">
<div class="mainScreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Digital Card Configuration Wizard (Beta)</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<center><font id="error_txt" valign="left" style="display:none"></font></center>
<div id="tablecontainer" style="display:none;visibility:none">
<select disabled size="1" id="devices" style="display:none"></select><input type='button' id='delete' value='Delete' style="display:none">
<BR>
<center>
<font size="+1">Digital Card Setup</font>
<div style="width:500;height:250; overflow :auto;">
        <table class="taglist" id="digitalcardstable" cellpadding=2 cellspacing=1 border=0 align=center width=500></table>
</div>
<table class="table_black" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
	<tr>	<td width=20>Span</td>
		<td width="80">Framing/Coding</td>
		<td id="id_type"></td>
		<td width="90" align="center"></td>
	</tr>
</table>
<div id="spanTable_div" style="height:430px;width=100%; overflow :auto; padding : 0px 0px 0px 0px;">
<table id="spanTable" cellpadding=2 cellspacing=1 border=0 align=center width=500 bgcolor="#DEDEDE"></table>
</div>
</center>
</div>
<div id="mymenu" class="mymenu" style="display:none"></div>
<div style="display:none;visibility:hidden">
	<tr>	<td class="field_text">Active:</td>
		<td><input id="active" size=14  class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Alarms:</td>
		<td><input id="alarms" size=14  class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Description:</td>
		<td><input  id="description" size=14 class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Name:</td>
		<td><input type="text" id="name" size=14 class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Total Channels:</td>
		<td><input type="text" id="totchans" size=14 class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Used Channels:</td>
		<td><input type="text" id="usedchans" size=14 class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Framing/Coding:</td>
		<td><input type="text" id="fac" size=14 class="input8"></td>
	</tr>
	<tr>	<td class="field_text">Line Build Out:</td>
		<td><input type="text" id="lbo" size=14 class="input8"></td>
	</tr>

</div>
</body>

<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Incoming Calling Rules
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var numplan_callbacks = new Object;
var user_callbacks = new Object;
var didtrunks = new Object;
var old_incomingrule, old_fromprovider ;
var editstatus , edit_pattern, edit_DIDtrunk, edit_action, edit_priority ;
var listOfExtensions = [] ;	// to store all the list of extensions to be displayed in the select menu
var focus_fields = new Array('incomingrule','frompattern','fromprovider','toextension');

user_callbacks.format = function(t, x) {
	var tmp = asterisk_guiTDPrefix + t.name ; 
	if ( ( t.fieldbyname['context'] == tmp ) && x == undefined ) {
		didtrunks[tmp] = new Object();
		didtrunks[tmp].trunkname = t.fieldbyname['trunkname'] ; 
		return t.name;
	}
	if (t.fieldbyname['fullname'] && t.fieldbyname['fullname'].length && x == undefined && t.name != "general" ) {
		listOfExtensions.push( t.name + " -- " + t.fieldbyname['fullname'] );
	}
	return false;
}

user_callbacks.loaded = function(){
	parent.astmanEngine.config2list("extensions.conf", $('extensions'), new Array(), numplan_callbacks);
}
user_callbacks.eachline = true;
user_callbacks.includecats = true;

// parse all contexts in extensions.conf that look like [DID_trunk_x]
// and show each entry in the table
numplan_callbacks.format = function(t, x) {
	if ((t.name == specialcontext && x != undefined )){
		var p = format_extension( _$('extensions'), t, x)  ;
		if ( p != null ){ listOfExtensions.push(p); }
	}
	if ( ( t.name.substring(0,asterisk_guiTDPrefix.length) == asterisk_guiTDPrefix ) && x == undefined ){
		if(typeof didtrunks[t.name] == "undefined"){
			didtrunks[t.name] = new Object();
			didtrunks[t.name].trunkname = t.name;
		}
		return t.name;
	}
	if ( ( t.name.substring(0,asterisk_guiTDPrefix.length) == asterisk_guiTDPrefix ) && t.names[x]=='exten' ){
		//get pattern & action
		var temp = t.fields[x].split(',');
		if( temp[0] == "s" ){return false;}
		didtrunks[t.name][temp[0]] = new Object();
		didtrunks[t.name][temp[0]].priority = temp[1];
		didtrunks[t.name][temp[0]].action = temp[2];
	}
	return false;
}

numplan_callbacks.loaded = function() {
	listOfExtensions.sort();
	for(var a =0; a < listOfExtensions.length ; a++ ){
		var b = listOfExtensions[a].split(' -- ');
		//$('toextension').innerHTML = $('toextension').innerHTML + "<option value='" + b[0] + "'>" + listOfExtensions[a] + "</option>";
		  var New_OPTION = document.createElement('option');
		  New_OPTION.text = listOfExtensions[a] ;
		  New_OPTION.value = b[0] ;
		  try {
			_$('toextension').add(New_OPTION, null); // W3C way
		  }catch(ex) {
			_$('toextension').add(New_OPTION); // IE way
		  }
	}

	// load list of trunks to 'fromprovider'
	var t ;
	for ( t in didtrunks){
	if(  didtrunks.hasOwnProperty(t) ){
		  var a = document.createElement('option');
		  a.text = didtrunks[t].trunkname ;
		  a.value = t ;
		  var b = document.getElementById('fromprovider');
		  try {
			b.add(a, null); 
		  }
		  catch(ex) {
			b.add(a); 
		  }
	  }
	}
	// load the object didtrunks into the table callingRulesTable
	refreshtable();
	parent.loadscreen(this);
}

numplan_callbacks.eachline = true;
numplan_callbacks.includecats = true;

function refreshtable(){
	var crt = _$('callingRulesTable') ;
	for( var i=0; i <  crt.rows.length; ){ crt.deleteRow(i); }
	
	for ( var i in didtrunks ){ // for each trunk
		if( didtrunks.hasOwnProperty(i) ){ 
			for(var j in didtrunks[i]){ // for each pattern of the trunk
				if( didtrunks[i].hasOwnProperty(j) ){ 
					if( j == "trunkname"){ continue;}
					addrowtotable( j, i, didtrunks[i][j].action, didtrunks[i][j].priority);
				}
			}
		}
	}

	if( crt.rows.length == 0){
		_$('table_one').style.display="none";
		var newRow = crt.insertRow(-1);
		var newCell0 = newRow.insertCell(0);
		newCell0 .align = "center";
		newCell0 .innerHTML = "<BR>An <I>incoming Calling Rule</I> is not defined<BR><BR> Please click on 'Add a Incoming Rule' button<BR> to add a new incoming call rule.<BR><BR>" ;
		return true;
	}

}

function addrowtotable(a,b,c,d){	// a is pattern, b is DID_trunk, c is action, d is priority
	var crt = _$('callingRulesTable') ;
	var sno = crt.rows.length + 1;
	var newRow = crt.insertRow(-1);
	newRow.id = "row" + sno; 
	
	var newCell0 = newRow.insertCell(0);
	newCell0.innerHTML = sno ;
	newCell0.align="center";
	newCell0.width=35;

	var newCell1 = newRow.insertCell(1);
	newCell1.innerHTML =  convert_tohuman(a,b,c) ; 

	var newCell2 = newRow.insertCell(2);
	newCell2.innerHTML = "<A href=\"#\" onclick=\"edit_incomingrule('"+ a +"', '"+ b +"', '" + c + "','" + d+"')\">Edit</A>&nbsp;&nbsp;<A href=\"#\" onclick=\"delete_incomingrule('"+ a +"', '"+ b +"', '" + c + "','" + d+"')\">Delete</A>";
	newCell2.width=75;
	newCell2.align="center";
	return true;
}


function convert_tohuman(a,b,c) { // a is pattern, b is DID_trunk, c is action, 
	var trunk = b.substr(4) ;
	if( c.match("Goto") && !c.match("voicemenu-")  ){ 
		var tmp = c.split('(');
		var exten = tmp[1].split('|'); // extension is exten[1]
	}

	if( a == "_X."){ // handling all unmatched 
		return " Route all unmatched incoming calls from provider '" + trunk + "' to extension '" + exten[1] + "'" ; 
	}
	return " Route incoming calls from provider '" + trunk + "' that macth pattern '" + a + "' to extension '" + exten[1] + "'"  ; 
}


function add_incomingrule(){
	editstatus = "NEW";
	old_incomingrule = "allunmatched";
	old_fromprovider = "";
	_$('incomingrule').selectedIndex = 0;
	_$('fromprovider').selectedIndex = -1;
	_$('toextension').selectedIndex = -1;
	_$('frompattern').value = "";
	_$('save_a').disabled = true;
	_$('thatmatch').style.display = "none" ;
	_$('userscontent').style.display = "";
	_$('bg_transparent').style.display = "";
}

function edit_incomingrule(a,b,c,d){// a is pattern, b is DID_trunk, c is action, d is priority
	edit_pattern = a; 
	edit_DIDtrunk = b;
	edit_action = c; 
	edit_priority=d ;

	editstatus = "EDIT";
	if(a == "_X."){
		_$('incomingrule').selectedIndex = 0;
		_$('thatmatch').style.display = "none" ;
		old_incomingrule = "allunmatched";
	}else{
		_$('frompattern').value = a ;
		_$('incomingrule').selectedIndex = 1;
		_$('thatmatch').style.display = "" ;
		old_incomingrule = "frompattern";
	}

	var q = _$('fromprovider') ;
	for(var i=0; i < q.length ; i++){
		if(q.options[i].value == b){
			q.selectedIndex = i;		
			old_fromprovider = b;
			break;
		}
	}

	if( c.match("Goto") && !c.match("voicemenu-")  ){ 
		var tmp = c.split('(');
		var exten = tmp[1].split('|'); // extension is exten[1]
		var y = _$('toextension');
		y.selectedIndex = -1 ;
		for(var t=0; t < y.length ; t++ ){
			if( y.options[t].value == exten[1] ){
				y.selectedIndex = t;
				break;
			}
		}
	}

	_$('userscontent').style.display = "";
	_$('bg_transparent').style.display ='';
}


function save_incomingrule(){
	if(	editstatus == "NEW"){
		save_new_incomingrule();
	}else if ( editstatus == "EDIT" ){
		update_incomingrule();
	}
}


function save_new_incomingrule(){
	// field validation
	var fp = _$('frompattern') ;
	var fpv = _$('fromprovider') ;
	var ir = _$('incomingrule').value ;
	var te = _$('toextension') ;

	if( ir == "frompattern" && fp.value == "" ){
		gui_feedback("Please define an incoming call pattern !");
		fp.focus();
		fp.select();
		return false;
	}
	if( fpv.selectedIndex == -1 ){
		gui_feedback("Please select a service provider !");
		fpv.focus();
		return false;
	}
	if( te.selectedIndex == -1 ){
		gui_feedback("Please select an extension to which<BR> an incoming call should be routed to !");
		te.focus();
		return false;
	}

	if(ir == "frompattern" && fp.value.substr(0,1) != "_" ){ fp.value = "_" + fp.value ; }

	// create an entry under the selected trunk
	// $('incomingrule') == "allunmatched" or "frompattern" , $('frompattern'), $('fromprovider'), $('toextension')
	if (ir == "allunmatched" ){
		var newpattern = "_X." ;
		var temp_provider = fpv.value;
		var temp_priority = "1";
		var temp_action = "Goto(default|" + te.value + "|1)";
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		var new_exten2 = "s,1," + temp_action;
		var uri = build_action('append', 0, temp_provider ,"exten", new_exten);
		uri += build_action('append', 1, temp_provider ,"exten", new_exten2);
	}else{
		var newpattern = fp.value ;
		var temp_provider = fpv.value ;
		var temp_action = "Goto(default|" + te.value + "|1)";
		var temp_priority = "1";
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		var uri = build_action('append', 0, temp_provider ,"exten", new_exten ); 
	}

	// check whether there is an existing entry with this pattern 
	if( typeof didtrunks[temp_provider][newpattern] != "undefined" ){
		gui_feedback("An incoming call rule is already defined <BR> on this trunk for the selcted pattern !! ");
		return false;
	}
	
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 									
			// add this to the global object
			didtrunks[temp_provider][newpattern] = new Object();
			didtrunks[temp_provider][newpattern].priority = temp_priority;
			didtrunks[temp_provider][newpattern].action = temp_action ;
			//addrowtotable(newpattern,temp_provider,temp_action,temp_priority) ; // a is pattern, b is DID_trunk, c is action, d is priority
			refreshtable();
			_$('userscontent').style.display = "none";
			_$('bg_transparent').style.display ='none';
		},
		onFailure: function(t) {
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};

	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(asterisk_rawmanPath , opt);
	// 
}


function update_incomingrule(){
	// field validation
	var ir = _$('incomingrule').value ;
	var fp = _$('frompattern') ;
	var te = _$('toextension') ;
 
	if( ir == "frompattern" && fp.value == "" ){
		gui_feedback("Please define an incoming call pattern !");
		fp.focus();
		fp.select();
		return false;
	}
	if( te.selectedIndex == -1 ){
		gui_feedback("Please select an extension to which<BR> an incoming call should be routed to !");
		te.focus();
		return false;
	}

	if( ir == "frompattern" && fp.value.substr(0,1) != "_" ){ fp.value = "_" + fp.value ; }
	// old values before editing are - edit_pattern, edit_DIDtrunk, edit_action, edit_priority
	// check for duplicate other than old
	var p = 0 ;
	var uri = "" ;
	var temp_provider = _$('fromprovider').value ;
	var temp_action = "Goto(default|" + te.value + "|1)";
	var temp_priority = "1";
	var tmp_old_string = edit_pattern  + "," + edit_priority + "," + edit_action;
	uri += build_action('delete', p, edit_DIDtrunk ,"exten", "", tmp_old_string); p++;
	if(edit_pattern == "_X." ){
		var tmp2_old_string = "s," + edit_priority + "," + edit_action ;
		uri += build_action('delete', p, edit_DIDtrunk ,"exten", "", tmp2_old_string); p++;
	}

	if ( ir == "allunmatched" ){
		var newpattern = "_X." ;
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		var new_exten2 = "s," + temp_priority + "," + temp_action;
		uri += build_action('append', p , temp_provider ,"exten", new_exten ); p++ ;
		uri += build_action('append', p , temp_provider ,"exten", new_exten2 ); p++ ;
	}else{
		var newpattern = fp.value ;
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		uri += build_action('append', p , temp_provider ,"exten", new_exten ); p++ ;
	}

	if( typeof didtrunks[temp_provider][newpattern] != "undefined" && ( temp_provider != edit_DIDtrunk || newpattern != edit_pattern ) ){
		gui_feedback("An incoming call rule is already defined <BR> on this trunk for the selcted pattern !! ");
		return false;
	}

	// delete old entry and add new entry
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 									
			delete didtrunks[edit_DIDtrunk][edit_pattern] ;
			didtrunks[temp_provider][newpattern] = new Object();
			didtrunks[temp_provider][newpattern].priority = temp_priority;
			didtrunks[temp_provider][newpattern].action = temp_action ;
			_$('userscontent').style.display = "none";
			_$('bg_transparent').style.display ='none';
			refreshtable();
		},
		onFailure: function(t) {
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(asterisk_rawmanPath , opt);
}


function checksave(k){
	var ir = _$('incomingrule').value ;
	var fpv = _$('fromprovider').value ;
	if( old_incomingrule == ir && old_fromprovider == fpv ){ return true; }

	if( ir == "frompattern" ){
		_$('thatmatch').style.display = "" ;
		if(k.id=="incomingrule"){
			_$('frompattern').focus();
			_$('frompattern').select();
		}
	}else{
		_$('thatmatch').style.display = "none" ;
	}

	_$('save_a').disabled = false;
	old_incomingrule = ir ;
	old_fromprovider = fpv ;
}


function enablesave(){
	_$('save_a').disabled = false;
}


function delete_incomingrule(a,b,c,d){ // a is pattern, b is DID_trunk, c is action, d is priority
	if( !confirm("Are you sure you want to delete this Incoming Calling Rule?") ){ return true; }

	var tmp_match = a+","+d+","+c ;
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 									
			// add this to the global object
			delete didtrunks[b][a];
			refreshtable();
		},
		onFailure: function(t) {
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	var uri = build_action('delete',0, b, "exten" ,"", tmp_match);
	if( a == "_X." ){
		var tmp2_match = "s," + d + "," + c ;
		uri += build_action('delete',1,b,"exten","", tmp2_match);
	}
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(asterisk_rawmanPath , opt);
}


function localajaxinit() {
	showdiv_statusmessage();
	setWindowTitle("Incoming Calls");
	for (var x =0; x < focus_fields.length; x++ ) {
		_$(focus_fields[x]).onfocus = function(){this.className = 'input9_hilight';}
		_$(focus_fields[x]).onblur = function(){this.className = 'input9';}
	}
	parent.astmanEngine.config2list("users.conf", _$('users'), new Array(), user_callbacks);
}


function free_mem( ){
	if( navigator.userAgent.indexOf("MSIE") == -1 ){ return true; }
	try{
		purge( document.body );
	}catch(e){ }
}
</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF"  onunload="free_mem()">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Incoming Calls</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="mailboxcontent">
	<select id="extensions" style="display:none"></select>
	<select id="users" style="display:none"></select>
	<BR>
	<CENTER><font size="+1">Incoming Call Rules</font></CENTER>
	<table class="table_blacksm" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
		<tr>	<td width=35>S.No</td>
			<td> Incoming Rule </td>
			<td width=75 align=center>Options</td>
		</tr>
	</table>
	<div id="callingRulesTable_div" style="height:250px;width=100%; overflow :auto; padding : 0px 0px 0px 0px;">
		<table id="callingRulesTable" cellpadding=2 cellspacing=1 border=0 align=center width=500></table>
	</div>
	<center><input type="button" id="adddid" value="Add a Incoming Rule" onclick="add_incomingrule();" onmouseover="show_tooltip('en', 'incoming',0);"></center>
	<div id="userscontent" STYLE="display:none; position: absolute; left: 20; top: 40; width:475; height:190; background-color:#F4EFE5; border-width: 1px; border-color: #7E5538; border-style: solid;z-index:5">
	<table width="100%" cellpadding=0 cellspacing=0 onmousedown="startDrag(event , 'userscontent');">
		<TR bgcolor="#7E5538"  style="background-image:url('images/title_gradient.gif');">
			<TD Height="20" align="right" style="cursor: move">
				<A href="#" onclick="$('cancel_a').click();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
			</TD>
			<TD width=4></TD>
		</TR>
	</table>
	<TABLE align=center cellpadding=2 cellspacing=2 border=0 width="100%">
		<TR>	<TD height=10></TD>	</TR>
		<TR>	<TD align=center>
			<NOBR>Route <select id="incomingrule"  onclick="checksave(this)" class="input9">
				<option value="allunmatched">All Unmatched incoming calls</option>
				<option value="frompattern">incoming calls that match </option>
				</select>
				<span id="thatmatch" onmouseover="show_tooltip('en', 'incoming', 1);">pattern 
				<input type="text" id="frompattern" size=12  onchange="enablesave();"  onkeyup="enablesave();"  class="input9">
				</span>
			</NOBR>
			</TD>
		</TR>
		<TR>	<TD align=center>
			from provider <select id="fromprovider" onclick="checksave(this)"  class="input9"></select>
			</TD>
		</TR>
		<TR>	<TD align=center>
			to extension <select id="toextension" onchange="enablesave();"  onkeyup="enablesave();"  class="input9"></select>
			</TD>
		</TR>
		<TR>	<TD align=center height=50 valign=middle>  
			<input type="button" id="save_a" value="Save" onclick="save_incomingrule();">&nbsp;&nbsp;
			<input type="button" id="cancel_a" value="Cancel" onclick="$('userscontent').style.display='none'; $('bg_transparent').style.display ='none';" >
			</TD>
		</TR>
	</TABLE>
	</div>
</div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 24; width:100%; height:100%;  background-color:#EFEFEF; -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #EFEFEF; border-style: solid; z-index:4">
</div>
</body>
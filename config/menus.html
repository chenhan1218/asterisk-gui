<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Users" generally
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->

<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
	var widgets = new Array;
	var adstatus;
	var menuscallbacks = new Object;
	var extencallbacks = new Object;
	var usercallbacks = new Object;
	var fieldnames = new Array('delete', 'status', 'new','save','cancel');
	var voicemenusdata = new Object;
	var current_context;
	var keys = new Array('0','1','2','3','4','5','6','7','8','9','*','#','t','i');
	var extensions_array = new Array;
	var answer_call_string = "s,1,Answer";


function format_step(this_step){
	var temp = this_step.split(',');

	if( temp[2].match("Answer") )
		return "Answer the Call";
	if( temp[2].match("Background") ){
		// Background('') - whatever in the brackets
		temp[2] = temp[2].replace(/Background\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Play '" + temp[2] + "' & Listen for KeyPress";
	}
	if( temp[2].match("SetMusicOnHold") ){
		// Background('') - whatever in the brackets
		temp[2] = temp[2].replace(/SetMusicOnHold\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Music on Hold  -  '" + temp[2] + "'";
	}
	if( temp[2].match("DigitTimeout") ){
		temp[2] = temp[2].replace(/DigitTimeout\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Wait '"+ temp[2] +"' sec for KeyPress";
	}
	if( temp[2].match("ResponseTimeout") ){
		temp[2] = temp[2].replace(/ResponseTimeout\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Response Timeout to '" + temp[2] + "' sec";
	}
	if( temp[2].match("Playback") ){
		temp[2] = temp[2].replace(/Playback\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Play '" + temp[2] + "' & Donot Listen for KeyPress";
	}
	if( temp[2].match("Wait") ){
		temp[2] = temp[2].replace(/Wait\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Wait '"+ temp[2] + "' sec";
	}
	if( temp[2].match("Hangup") )
		return "Hangup";

 return this_step;
}

function load_extensions(my_field_options){
		$(my_field_options).options.length=0;
		for(x=0; x< extensions_array.length; x++){
				var newoption = document.createElement("option"); 
				newoption.text = extensions_array[x] ; 
				newoption.value = extensions_array[x] ;
				$(my_field_options).options.add(newoption);
		}
}

function load_menus(my_field_options){
		$(my_field_options).options.length=0;
		for(x=0; x< $('vmenus').length; x++){
				if($('vmenus').options[x].text != "New Entry" ){
					var newoption = document.createElement("option"); 
					newoption.text = voicemenusdata[$('vmenus').options[x].value].comment ; 
					newoption.value = $('vmenus').options[x].value ;
					$(my_field_options).options.add(newoption);
				}
		}
}

function select_menu (my_field_options, menustring){
		var tmp = menustring.split('(');
		var tmp1 = tmp[1].split('|');
		for(y=0; y < $(my_field_options).options.length; y++ ){
			if( $(my_field_options).options[y].value == tmp1[0]){
				$(my_field_options).options[y].selected = true;
				return true;
			}
		}
		// if not in the current list of voicemenus/extensions then add it to the menu
		var newoption = document.createElement("option"); 
		newoption.text = tmp1[0] ; 
		newoption.value = tmp1[0] ;
		$(my_field_options).options.add(newoption);
		$(my_field_options).options[y].selected = true;
}


function  key_action(a, field){
	my_field_text = 'keypress_'+ field + '_text' ;
	my_field_menus = 'keypress_'+ field + '_menus' ;
	my_field_exts = 'keypress_'+ field + '_exts' ;

	$('savevmenu').disabled = false;
	$('cancel').disabled = false;
	if(a=='gotomenu'){
		//show menus dropdown
		$(my_field_menus).style.display = "";
		$(my_field_text).style.display = "none";
		$(my_field_exts).style.display = "none";
	}
	if(a=='gotoextension'){
		//show extensions dropdown
		$(my_field_exts).style.display = "";
		$(my_field_text).style.display = "none";
		$(my_field_menus).style.display = "none";
	}
	if(a=='Custom'){
		//show a  text box
		$(my_field_exts).style.display = "none";
		$(my_field_menus).style.display = "none";
		$(my_field_text).style.display = "";
		$(my_field_text).focus();
	}
	if(a=='disabled' || a=='Hangup' || a=='PlayInvalid'){
		//show nothing
		$(my_field_text).style.display = "none";
		$(my_field_exts).style.display = "none";
		$(my_field_menus).style.display = "none";
	}
}

function sortNumber(a,b){
	return a - b ;
}

function add_newstep(){

	if( !$('newstep_action').value ){
		alert("Please select an action for this step");
		$('newstep_action').focus();
		return;
	}

	if( $('newstep_action').value != "Answer" &&   $('newstep_action').value != "Hangup" && !$('newstep_var').value ){
		alert("Please enter a value for '" + $('newstep_action').value +"'");
		$('newstep_var').focus();
		return;
	}

	// prepare a request to add the new step to the voicemenu
	// make a request to append
	var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
				// if request successfull then add this to the steps select box
				var newoption = document.createElement("option"); 
				newoption.text = format_step(action_string ); 
				newoption.value = action_string ;
				$('steps').options.add ( newoption );
				// and also add the information to the voicemenus data
				if(voicemenusdata[$('vmenus').value].extensions['s']){
					voicemenusdata[$('vmenus').value].extensions['s'].push(action_string);
				}else{
					voicemenusdata[$('vmenus').value].extensions['s'] = new Array;
					voicemenusdata[$('vmenus').value].extensions['s'][0] = action_string;
				}
				// empty this textbox & disable this button, select the newly added item to the steps options box
				$('newstep_action').selectedIndex = 0;
					$('deletestep').disabled = false;
				$('newstep_var').value= "";
				$('steps').selectedIndex = $('steps').length - 1 ;
				$('status').innerHTML = "<i>New step added !</i>";
			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			},
	};
	var uri = "";
	var action_string = "";
	var priorities = new Array;

	// algorithm 4 calculate new priority
	if(voicemenusdata[$('vmenus').value].extensions['s'] && voicemenusdata[$('vmenus').value].extensions['s'].length > 0 ){
		for( var p=0; p < voicemenusdata[$('vmenus').value].extensions['s'].length; p ++){
			var temp  = voicemenusdata[$('vmenus').value].extensions['s'][p].split(',');			
			priorities.push(temp[1]);
		}
		priorities = priorities.sort(sortNumber);
		newpriority = parseInt(priorities[priorities.length - 1]) + 1;
	}else{
		newpriority = 1;
	}

	if( $('newstep_action').value == 'Answer' ){
		action_string = "s,"+ newpriority+ ",Answer";
	}else if ( $('newstep_action').value == 'Background'  ){
		action_string = "s,"+ newpriority+ ",Background(" + $('newstep_var').value + ")";
	}else if ( $('newstep_action').value == 'SetMusicOnHold'  ){
		action_string = "s,"+ newpriority+ ",SetMusicOnHold(" + $('newstep_var').value + ")";
	}else if ( $('newstep_action').value == 'DigitTimeout'  ){
		action_string = "s,"+ newpriority+ ",DigitTimeout(" + $('newstep_var').value + ")";
	}else if ( $('newstep_action').value == 'ResponseTimeout'  ){
		action_string = "s,"+ newpriority+ ",ResponseTimeout(" + $('newstep_var').value + ")";
	}else if ( $('newstep_action').value == 'Playback'  ){
		action_string = "s,"+ newpriority+ ",Playback(" + $('newstep_var').value + ")";
	}else if ( $('newstep_action').value == 'Wait'  ){
		action_string = "s,"+ newpriority+ ",Wait(" + $('newstep_var').value + ")";
	}else if ( $('newstep_action').value == 'Hangup'  ){
		action_string = "s,"+ newpriority+ ",Hangup";
	}

	uri += build_action('append', 0, $('vmenus').value,"exten", action_string ); 
	opt.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	tmp = new Ajax.Request('../../rawman', opt);

}



function next_freevmenu(){	 // return the next smallest available voicemenu name
	var current_names = new Array;
	for(var i=0; i < $('vmenus').length; i++ ){
		if ( $('vmenus').options[i].value.match('voicemenu-custom-') )
			current_names.push( $('vmenus').options[i].value.replace( /voicemenu-custom-/ ,"") );
	}
	if ( current_names.length ){
		for(var i=0; i<current_names.length-1; i++){
			if( current_names[i+1] -  current_names[i] > 1 )
				break;
		}
		var temp =  parseInt(current_names[i]) +1;
		return 'voicemenu-custom-' + temp ;
	}
	return 'voicemenu-custom-1' ;
}



function save_vmenu(){
	var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
					$('status').innerHTML = "<i>Updated.</i>";
					$('savevmenu').disabled = true;
					$('save').disabled = true;
					$('cancel').disabled = true;
					
					if( $('vmenus').options[$('vmenus').selectedIndex].innerHTML=='New Entry' ){ // (if new Voicemenu 
							voicemenusdata[current_vmenu] = new Object();
							voicemenusdata[current_vmenu].comment =  $('comment').value;
							voicemenusdata[current_vmenu].extensions = new Object();
							// add the "s,1,Answer" data to voicemenus data
							voicemenusdata[current_vmenu].extensions['s'] = new Array();
							voicemenusdata[current_vmenu].extensions['s'][0] = answer_call_string;
							for (var k=0; k< keys.length; k++){
								if( buildstring[keys[k]] ){
									voicemenusdata[current_vmenu].extensions[keys[k]] = new Array();
									voicemenusdata[current_vmenu].extensions[keys[k]][0] = buildstring[keys[k]] ;
								}
							}
							// update vmenus
							$('vmenus').options[$('vmenus').selectedIndex].text = "VoiceMenu - " + $('comment').value;
							$('vmenus').options[$('vmenus').selectedIndex].value = current_vmenu;

					}else{ // if editing existing keypress options
							for (var k=0; k< keys.length; k++){
									if( buildstring[keys[k]] ){
										voicemenusdata[current_vmenu].extensions[keys[k]] = new Array();
										voicemenusdata[current_vmenu].extensions[keys[k]][0] = buildstring[keys[k]] ;
									}else{
										if( voicemenusdata[current_vmenu].extensions[keys[k]] ){
											voicemenusdata[current_vmenu].extensions[keys[k]] = [];
										}
									}
							}							
					}

			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			},
	};
	var uri = "" ;
	var p =0 ;
	var buildstring = new Object ;

	if( $('vmenus').options[$('vmenus').selectedIndex].innerHTML=='New Entry' ){
			var current_vmenu = next_freevmenu();
			uri += build_action('newcat', p, current_vmenu,"", ""); p = p+1;
			uri += build_action('append', p, current_vmenu,"comment", $('comment').value); p = p+1;
			uri += build_action('append', p, current_vmenu,"exten", answer_call_string); p = p+1;
	}else{
			// Updating existing Voicemenu
			var current_vmenu = $('vmenus').value;
			if(  voicemenusdata[current_vmenu].comment != $('comment').value ){
					uri += build_action('update', p, current_vmenu ,"comment", $('comment').value ); p = p+1;
			}
			for (var k=0; k< keys.length; k++){
				if(voicemenusdata[current_vmenu].extensions[keys[k]]){
					uri += build_action('delete', p, current_vmenu,"exten", "", voicemenusdata[current_vmenu].extensions[keys[k]][0] ); p = p+1;
				}
			}
	}

	// Build exten strings for enabled keys and append/update the 
	for (var k=0; k< keys.length; k++){
			var current_key_action='keypress_'+ keys[k] + '_action';
			var current_key_text='keypress_'+ keys[k] + '_text';
			var current_key_exts='keypress_'+ keys[k] + '_exts';
			var current_key_menus='keypress_'+ keys[k] + '_menus';
		
			if( $(current_key_action).value == "disabled")
				continue;
			else if( $(current_key_action).value == "gotomenu" )
					buildstring[keys[k]] = keys[k] + ",1,Goto("+ $(current_key_menus).value + "|s|1)" ;					
			else if( $(current_key_action).value == "gotoextension" )
					buildstring[keys[k]] = keys[k] + ",1,Goto("+ $(current_key_exts).value + "|1)" ;					
			else if( $(current_key_action).value == "Custom" ) 
					buildstring[keys[k]] = keys[k] + ",1,"+ $(current_key_text).value ;
			else if( $(current_key_action).value == "Hangup" )
					buildstring[keys[k]] = keys[k] + ",1,"+ "Hangup" ;					
			else if( $(current_key_action).value == "PlayInvalid" ) 
					buildstring[keys[k]] = keys[k] + ",1,"+ "Playback(invalid)" ;
						
			uri += build_action('append', p, current_vmenu,"exten", buildstring[keys[k]]); p = p+1;
	}

	opt.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	// send the request
	tmp = new Ajax.Request('../../rawman', opt);
}


function  enable_savecancel(){
		$('savevmenu').disabled = false;
		$('cancel').disabled = false;
}


function generate_fields(key){
			document.write('<select  style="font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"   id=\'keypress_'+ key + '_action\' onchange="key_action(this.value, \'' + key + '\')">\n');
			document.write('<option value="disabled">Disabled</option>\n');
			document.write('<option value="gotomenu">Goto Menu</option>\n');
			document.write('<option value="gotoextension">Goto Extension</option>\n');
			document.write('<option value="Custom">Custom</option>\n');
			document.write('<option value="Hangup">Hangup</option>\n');
			document.write('<option value="PlayInvalid">Play Invalid</option>\n');
			document.write('</select>&nbsp;<input type="text"  size=16 style="display:none;font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;" id="keypress_' + key+ '_text" onchange="enable_savecancel()">\n');
			document.write('<select  style="display:none; font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"  id="keypress_'+ key + '_menus" onchange="enable_savecancel()"></select>\n');
			document.write('<select  style="display:none; font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"  id="keypress_'+ key + '_exts" onchange="enable_savecancel()"></select>\n');
}

function step_onselect(){
	// enable delete button
	if($('steps').value){
		$('deletestep').disabled = false;
	}

	// enable Up/Down buttons accordingly
	update_updown();
}

function update_updown(){
	if( !$('steps').selectedIndex == 0){
		$('stepUp').disabled = false;
	}else{
		$('stepUp').disabled = true;
	}

	if( $('steps').selectedIndex != ($('steps').length-1) ){
		$('stepDown').disabled = false;
	}else{
		$('stepDown').disabled = true;
	}

}


function step_up(){
	// Swap x, x-1
	swap_step($('steps').selectedIndex, $('steps').selectedIndex-1);
}


function step_down(){
	//swap x, x+1
	swap_step($('steps').selectedIndex, $('steps').selectedIndex+1 );
}


function swap_step(a,b){
	// get prioirty of a
	// get priority of b
	var tmp1 = $('steps').options[a].value.split(",") ;
	var priority_1 = tmp1[1];

	var tmp2 = $('steps').options[b].value.split(",") ;
	var priority_2 = tmp2[1];

	//alert("Change priority of " + $('steps').options[a].value +" to that of "+ priority_2);
	//alert("Change priority of "+ $('steps').options[b].value +" to that of "+ priority_1);

	tmp1.splice(1,1,priority_2);
	tmp2.splice(1,1,priority_1);

	var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
					// update voicemenusdata
					for(var p=0; p< voicemenusdata[$('vmenus').value].extensions['s'].length; p++){
							if( voicemenusdata[$('vmenus').value].extensions['s'][p] == $('steps').options[a].value )
							voicemenusdata[$('vmenus').value].extensions['s'][p] = tmp1.join();
							else if (voicemenusdata[$('vmenus').value].extensions['s'][p] == $('steps').options[b].value  ) 
							voicemenusdata[$('vmenus').value].extensions['s'][p] = tmp2.join();
					}
					// swap select values of a to b
					$('steps').options[a].value = tmp2.join();
					$('steps').options[b].value = tmp1.join();
					var buffer = $('steps').options[a].text;
					$('steps').options[a].text = $('steps').options[b].text;
					$('steps').options[b].text = buffer;
					$('steps').selectedIndex = b;
					$('status').innerHTML = "<i>Step Priority Updated!</i>";
					update_updown();

					// some thing is not ok here .. check
			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			},
	};	
	var uri = "";

	// ok find $('steps').options[a].value in extensions.conf and replace it with tmp1.join() and also replace $('steps').options[b].value with tmp2.join()	
	uri += build_action('update', 0, $('vmenus').value ,"exten",tmp1.join(), $('steps').options[a].value);
	uri += build_action('update', 1, $('vmenus').value ,"exten",tmp2.join(), $('steps').options[b].value);
	opt.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	tmp = new Ajax.Request('../../rawman', opt);
}



function delete_step(){
	// delete the selected step and update voicemenusdata
	// and update 'select' object - steps
	var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
						// Update voicemenusdata
						for(var p=0; p< voicemenusdata[$('vmenus').value].extensions['s'].length; p++){
							if( voicemenusdata[$('vmenus').value].extensions['s'][p] == $('steps').value )
								voicemenusdata[$('vmenus').value].extensions['s'].splice(p,1);
						}

						$('steps').remove( $('steps').selectedIndex);
						$('status').innerHTML = "<i>Step Deleted !</i>";
						$('deletestep').disabled = true;

			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			},
	};	
	var uri = "";
	uri += build_action('delete', 0, $('vmenus').value,"exten", "", $('steps').value); 
	opt.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	tmp = new Ajax.Request('../../rawman', opt);
}




menuscallbacks.postselect = function() {
	// show al lthe //s, lines in the select box - 
	if($('vmenus').selectedIndex	==-1){ return true;}
	current_context = $('vmenus').value;
	var x, y, tmp;
	var priority_1, priority_2, buffer;

	//$('keypressoptions').innerHTML = "";
	$('steps').options.length =0;
	$('comment').value = voicemenusdata[current_context].comment;

	if(voicemenusdata[current_context].extensions['s']){
		for (x=0;x<voicemenusdata[current_context].extensions['s'].length ; x++ ){
			var newoption = document.createElement("option");
			newoption.text = format_step(voicemenusdata[current_context].extensions['s'][x]);
			newoption.value = voicemenusdata[current_context].extensions['s'][x];
			$('steps').options.add ( newoption );
		}
	}

	// I know .. bubble sort really sucks ... but something for now.
	for (x = ($('steps').length - 1); x >= 0; x--){
				for (y = 1; y <= x; y++){
					tmp = $('steps').options[y].value.split(",") ;
					priority_1 = tmp[1];
					tmp = $('steps').options[y-1].value.split(",") ;
					priority_2 = tmp[1];

					  if (priority_2 > priority_1){
							buffer = $('steps').options[y-1].value;
							$('steps').options[y-1].value = $('steps').options[y].value;
							$('steps').options[y].value = buffer;
							buffer = $('steps').options[y-1].text;
							$('steps').options[y-1].text = $('steps').options[y].text;
							$('steps').options[y].text = buffer;
					  }
				}
	}

	$('steps').disabled = false;
	$('comment').disabled = false;
	$('newstep_action').disabled = false;
	$('newstep_var').disabled = false;
	$('addstep').disabled = false;
	$('allowexten').disabled = false;
	$('keypressoptions').style.display = "";
	$('deletestep').disabled = true;
	$('stepDown').disabled = true;
	$('stepUp').disabled = true;

	for (y=0; y<keys.length ; y++ ){
			current_key_action='keypress_'+ keys[y] + '_action';
			current_key_text='keypress_'+ keys[y] + '_text';
			current_key_exts='keypress_'+ keys[y] + '_exts';
			current_key_menus='keypress_'+ keys[y] + '_menus';

			if(voicemenusdata[current_context].extensions[keys[y]]){
					// Load the appropriate Key menu according to the voicemenusdata[current_context].extensions[y][x]
					// actually we are assuming that there is only voicemenusdata[current_context].extensions[y][0]
					tmp = voicemenusdata[current_context].extensions[keys[y]][0].split(',');

					if( tmp[2].match("Goto") && tmp[2].match("voicemenu-") ){ //  if "is a voicemenu"
							$(current_key_action).options[1].selected = true;
							$(current_key_menus).style.display = "";
							$(current_key_text).style.display = "none";
							$(current_key_exts).style.display = "none";
							select_menu (current_key_menus, tmp[2]);
					}else  if( tmp[2].match("Goto") && !tmp[2].match("voicemenu-") ){ // //  if "goto an extension " (no 'voicemenu-')
							$(current_key_action).options[2].selected = true;
							$(current_key_exts).style.display = "";
							$(current_key_text).style.display = "none";
							$(current_key_menus).style.display = "none";
							select_menu(current_key_exts, tmp[2]); // select_menu common for exts and menus
					}else if(tmp[2].match("Hangup") ){ // if HangUp
							$(current_key_action).options[4].selected = true;
							$(current_key_text).style.display = "none";
							$(current_key_menus).style.display = "none";
							$(current_key_exts).style.display = "none";							
					}else if( tmp[2].match('Playback') &&  tmp[2].match( "(invalid)" ) ){
							$(current_key_action).options[5].selected = true;
							$(current_key_text).style.display = "none";
							$(current_key_menus).style.display = "none";
							$(current_key_exts).style.display = "none";												
					}else{ // if custom (no 'goto')
							$(current_key_action).options[3].selected = true;
							$(current_key_text).style.display = "";
							$(current_key_text).value = tmp[2];
							$(current_key_exts).style.display = "none";
							$(current_key_menus).style.display = "none";
					}
			}else{	// Key_action is disabled => hide the text & options (which already are)
							$(current_key_action).options[0].selected = true;
							$(current_key_text).style.display = "none";
							$(current_key_menus).style.display = "none";
							$(current_key_exts).style.display = "none";
			}
	}
}


menuscallbacks.format = function(t, x) {
		var tmp = t.name.split('general');
		var exten_fields;

		if(tmp.length>1)
				return false;
		else if ( t.name.substr(0,10) == 'voicemenu-' && x==undefined ){	 				// if is a category
				current_context = t.name;
				voicemenusdata[current_context] = new Object();
				return t.name ;
		}else if(t.name.substr(0,10) == 'voicemenu-' ) {											// if is a subcategory 
				if (t.names[x]=='comment'){
					voicemenusdata[current_context].comment =  t.fields[x];
					voicemenusdata[current_context].extensions = new Object();
					return false;
				}
				if (t.names[x]=='exten'){
					exten_fields = t.fields[x].split (',');
					if(!voicemenusdata[current_context].extensions[exten_fields[0]]){
						voicemenusdata[current_context].extensions[exten_fields[0]] = new Array();
					}
					voicemenusdata[current_context].extensions[exten_fields[0]].push( t.fields[x] ) ;
				}
				return false;
		}else{	
			return false;
		}
}



menuscallbacks.loaded = function(){
			for (x=0;x<$('vmenus').options.length ; x++ ){
					$('vmenus').options[x].text = "VoiceMenu - " + voicemenusdata[$('vmenus').options[x].value].comment;
			}
			// Load the menus and extensions into corresponding fields
			for (y=0;y<keys.length; y++){
				current_key_exts='keypress_'+ keys[y] + '_exts';
				current_key_menus='keypress_'+ keys[y] + '_menus';
				load_extensions(current_key_exts);
				load_menus(current_key_menus);
			}
			
}



menuscallbacks.identifier = "extension";

menuscallbacks.eachline = true;

menuscallbacks.includecats = true;

menuscallbacks.cancelnewcategory =function(){
	$('comment').disabled = true;
	$('keypressoptions').style.display = "none";
}

menuscallbacks.cancelchanges =function(){
	$('savevmenu').disabled = true;
}

menuscallbacks.newcategory = function(t) {
	// 1. Reset all Keyoptions
		// Load the menus and extensions into corresponding fields
		for (y=0;y<keys.length; y++){
			current_key_exts='keypress_'+ keys[y] + '_exts';
			current_key_menus='keypress_'+ keys[y] + '_menus';
			current_key_text = 'keypress_'+ keys[y] + '_text' ;
			current_key_action='keypress_'+ keys[y] + '_action';

			load_extensions(current_key_exts);
			load_menus(current_key_menus);
			$(current_key_action).selectedIndex = 0;
			$(current_key_exts).style.display = "none";
			$(current_key_menus).style.display = "none";
			$(current_key_text).style.display = "none";
		}
	// 2. Reset Steps - only 1 step -> Answer

		$('steps').options.length =0;
		var newoption = document.createElement("option");
		newoption.text = format_step(answer_call_string);
		newoption.value = answer_call_string;
		$('steps').options.add ( newoption );
	// 3. Disable Steps - Add Step , Up , Down Arrows
		$('stepUp').disabled = true;
		$('stepDown').disabled = true;
		$('allowexten').checked = false;
		$('allowexten').disabled = false;
		$('newstep_action').disabled = true;
		$('newstep_var').disabled = true;
		$('addstep').disabled = true;
		$('steps').disabled = true;
	//  4. Reset Comment
		$('keypressoptions').style.display = "";
		$('comment').disabled = false;
		$('comment').value = "";
		$('comment').focus();
}




function localajaxinit() {
		for (x =0 ; x<fieldnames.length; x++){
			widgets[fieldnames[x]] = $(fieldnames[x]);
			widgets[fieldnames[x]].disabled = true;
		}
		parent.loadscreen(this);
		parent.astmanEngine.config2list("extensions.conf", $('extensions'), new Array(), extencallbacks);
}



//extencallbacks
extencallbacks.format = function(t, x) {
	var res;
	var qname;
	if ((t.name != specialcontext))
		return null;
	res = format_extension($('extensions'), t, x);
	//if (t.subfields[x]['app'] == 'Queue') {
	//	return null;
	//}
	return res;
}

extencallbacks.loaded = function() {
	// all extensions loaded will be in the format of "ext -- name" format
	// but we need only ext
	for (var p=0; p < $('extensions').length ; p++){
		var tmp = $('extensions').options[p].text.split (" -- ");
		$('extensions').options[p].text = tmp[0];
	}

	parent.astmanEngine.config2list("users.conf", $('users'), new Array(), usercallbacks);
}

extencallbacks.eachline = true;


// user callbacks
usercallbacks.format = function (t,x){
		if ((t.name == 'general'))
			return null;
		if (t.name.substring(0,6) == 'trunk_')
			return null;
		else
			return t.name;
}

usercallbacks.identifier = "extension";

usercallbacks.loaded = function (){
	for(var p=0; p < $('extensions').length; p++){
		extensions_array.push ($('extensions').options[p].text);
	}
	for(var p=0; p < $('users').length; p++){
		extensions_array.push ($('users').options[p].text);
	}
	extensions_array = extensions_array.sort(); // or extensions_array.sort(sortNumber);
	parent.astmanEngine.config2list("extensions.conf", $('vmenus'), widgets, menuscallbacks);
}

</script>


<body id="foo" onload="localajaxinit()">

<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold">Voice Menus Configuration</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr valign="top">
		<td colspan='2'>
		Voice Menus:
		</td>
	</tr>
	<tr valign="top">
		<td>
			<select size="28" id="vmenus" style="width:180px">
			<option>Loading...</option>
			</select>
			<div style='visibility:hidden;overflow:hidden;width:0px;height:0px'><select id='extensions'></select><select id='users'></select></div>
		</td>
		<td valign=top align="right" width=390>
						<table align="center" width="390">
						<tr><td width="60" align=left>Name:</td><td align=left><input id='comment'  onKeyUp="enable_savecancel()" disabled></td></tr>
						<tr><td colspan=2>Steps:</td></tr>
						<tr><td align=center colspan=2> 
										<TABLE>
										<tr><td ><select id='steps' size=5  style="width:310px" onClick="step_onselect()" disabled></select></td>
												<td  align=center width=55 valign="middle">
														<input  style='width:45'  type="button" id="stepUp" value="Up" disabled onClick="step_up()"><BR><BR>
														<input  style='width:45' type="button" id="stepDown" value="Down" disabled onClick="step_down()">
												</td>
										</tr>
										</TABLE>
								</td>
						</tr>
						<tr><td colspan=2>Add a new Step:</td></tr>
						<tr><td colspan=2>&nbsp;&nbsp;
								<select id='newstep_action' disabled>
									<option value=""> -- Select --</option>
									<option value="Answer">Answer</option>
									<option value="Background">Background</option>
									<option value="SetMusicOnHold">SetMusicOnHold</option>
									<option value="DigitTimeout">DigitTimeout</option>
									<option value="ResponseTimeout">ResponseTimeout</option>
									<option value="Playback">Playback</option>
									<option value="Wait">Wait</option>
									<option value="Hangup">Hangup</option>
								</select>&nbsp;&nbsp;
								<input type=text id="newstep_var" size=4 disabled>
								&nbsp;<input type=button style='width:45' id='addstep' onclick="add_newstep()"  value="Add" disabled>
								&nbsp;<input type=button style='width:50' id='deletestep' onclick="delete_step()"  value="Delete" disabled>
								</td>
						</tr>
						
						<tr><td colspan=2>&nbsp;<input type=checkbox id=allowexten disabled> Allow dialing Extensions ?</td></tr>

						<tr><td colspan=2 height=15></td></tr>
						<tr><td colspan=2>'Keypress' Events</td></tr>
						<tr><td colspan=2>
										<div  style="width=390px;">
										<table cellpadding=3 cellspacing=0 width="100%">
										<TR bgcolor='#B8B8B8'>
												<TD width=35>Key</TD><TD>Action</TD>
										</TR>
										</table>
										</div>
										<div id="keypressoptions" style="height:180px;width=390px; overflow :auto;display :none">
										<table cellpadding=3 cellspacing=0 width="100%">
										<SCRIPT LANGUAGE="JavaScript">
										<!--
										for (var k=0; k< keys.length; k++){
											document.write("<TR bgcolor='#FFFFFF'>\n");
											document.write("<TD width=35 align=center><font style=\"font-size: 10pt\">"+keys[k]+"</font></TD>\n");
											document.write("<TD>");
											generate_fields( keys[k] ) ;
											document.write("\n </TD></TR>\n\n");											
										}
										//-->
										</SCRIPT>
										</table>
								
								</div>
								</td>
						</tr>
						<tr><td colspan=2 align="center">
						<div style="height:15px" id='status'></div>
								</td>
						</tr>
						</table>

		</td>
	</tr>				
	<tr>
		<td align='center'>
			<input style='width:80' type='button' id='new' value='New'>
			&nbsp;
			<input style='width:80' type='button' id='delete' value='Delete'>
			&nbsp;
		</td>
		<td align='right'><input type="hidden" id="save">
				<input style='width:80' type='button' id='savevmenu' onClick="save_vmenu()" value='Save' disabled>
				&nbsp;
				<input style='width:80' type='button' id='cancel' value='Cancel'>
				&nbsp;
		</td>
	</tr>
</table>
</div>
</body>

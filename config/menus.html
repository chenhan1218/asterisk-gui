<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Create/Manage IVR Menus
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var widgets = {};
var adstatus;
var menuscallbacks = new Object;
var extencallbacks = new Object;
var usercallbacks = new Object;
var numcallbacks = new Object;
var fieldnames = new Array('delete', 'status', 'new','save','cancel');
var voicemenusdata = new Object;
var current_context;
var keys = new Array('0','1','2','3','4','5','6','7','8','9','*','#','t','i');
var extensions_array = new Array;
var answer_call_string = "s,1,Answer";
var localextenlength ;


function format_step(this_step){
	var temp = this_step.split(',');

	if( temp[2].match("Answer") )
		return "Answer the Call";
	if( temp[2].match("Background") ){
		// Background('') - whatever in the brackets
		temp[2] = temp[2].replace(/Background\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Play '" + temp[2] + "' & Listen for KeyPress";
	}
	if( temp[2].match("DigitTimeout") ){
		temp[2] = temp[2].replace(/DigitTimeout\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Wait '"+ temp[2] +"' sec for KeyPress";
	}
	if( temp[2].match("ResponseTimeout") ){
		temp[2] = temp[2].replace(/ResponseTimeout\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Response Timeout to '" + temp[2] + "' sec";
	}
	if( temp[2].match("Playback") ){
		temp[2] = temp[2].replace(/Playback\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Play '" + temp[2] + "' & Donot Listen for KeyPress";
	}
	if( temp[2].match("WaitExten") ){
		temp[2] = temp[2].replace(/WaitExten\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "WaitExten '"+ temp[2] + "' sec";
	}else if( temp[2].match("Wait") ){
		temp[2] = temp[2].replace(/Wait\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Wait '"+ temp[2] + "' sec";
	}

	if( temp[2].match("Goto") && temp[2].match("voicemenu-")  ){
		var tmp = temp[2].split('(');
		var tmp1 = tmp[1].split('|');
		try{
			return "Goto Menu '"+  voicemenusdata[tmp1[0]].comment  + "'";
		}
		catch(e){
			return "Goto Menu '"+  tmp1[0] + "'";
		}
	}
	
	if( temp[2].match("Goto") && !temp[2].match("voicemenu-")  ){
		var tmp = temp[2].split('(');
		var tmp1 = tmp[1].split('|');
		return "Goto Exten '"+ tmp1[1] + "'";
	}
	
	if( temp[2].match("Hangup") )
		return "Hangup";

 return this_step;
}

function load_extensions(my_field_options){
	var _mo = _$(my_field_options); 
	_mo.options.length=0;
	for(var x=0; x < extensions_array.length; x++){
		var newoption = document.createElement("option"); 
		newoption.text = extensions_array[x] ; 
		newoption.value = extensions_array[x] ;
		_mo.options.add(newoption);
	}
}

function load_menus(my_field_options){
	var _mo = _$(my_field_options) ;
	var _vms = _$('vmenus') ;
	_mo.options.length=0;
	
	for(var x=0; x < _vms.length; x++){
		if( _vms.options[x].text == "New Entry" ){ continue ; }
		var newoption = document.createElement("option"); 
		newoption.text = voicemenusdata[ _vms.options[x].value].comment ; 
		newoption.value = _vms.options[x].value ;
		_mo.options.add(newoption);
	}
}

function select_menu (my_field_options, menustring, a){
	var tmp = menustring.split('(');
	var tmp1 = tmp[1].split('|');
	var _mfo = _$(my_field_options) ;

	if(a == "ismenu"){
		var check_against = tmp1[0]; 
	}else if(a == "isext"){ 
		var check_against = tmp1[1] ;
	}

	for(var y=0; y < _mfo.options.length; y++ ){
		if( _mfo.options[y].value == check_against ){
			_mfo.options[y].selected = true;
			return true;
		}
	}
	// if not in the current list of voicemenus/extensions then add it to the menu
	var newoption = document.createElement("option"); 
	newoption.text = check_against ; 
	newoption.value = check_against ;
	_mfo.options.add(newoption);
	_mfo.options[y].style.fontWeight = 'bold';
	_mfo.options[y].selected = true;
	_mfo.style.color = '#CC0000';
}

function add_newvmenu_tolistofkeymenus(){
	var _vms = _$('vmenus') ;
	var _vmsv = _vms.options[_vms.selectedIndex].value ;
	var _cv = _$('comment').value ;
	for (var k=0; k< keys.length; k++){
		var current_key_menus='keypress_'+ keys[k] + '_menus';
		var newoption = document.createElement("option"); 
		newoption.text = _cv ; 
		newoption.value = _vmsv ;
		_$(current_key_menus).options.add(newoption);
	}
	// and also add it to $('add_newstep_menus')
	var newoption = document.createElement("option"); 
	newoption.text = _cv ; 
	newoption.value = _vmsv ;
	_$('add_newstep_menus').options.add(newoption);
}


function delete_vmenu_fromlistofmenus(){
	var _cv = _$('comment').value ;
	for (var k=0; k< keys.length; k++){
		var current_key_menus='keypress_'+ keys[k] + '_menus';
		var _ckm = _$(current_key_menus);

		for(var i=0; i< _ckm.options.length; i++){
			if( _ckm.options[i].text == _cv ){
				// delete this option from the $(current_key_menus)
				var deleted_voicmenu = _ckm.options[i].value ;
				_ckm.remove(i);
				break;
			}
		}
	}
	var _anm = _$('add_newstep_menus') ;
	for(var i=0; i< _anm.options.length; i++){
		if( _anm.options[i].text == _cv ){
			_anm.remove(i);
			break;
		}
	}
	// use the deleted_voicmenu to delete the alias (if it exists) in the default
	if(_$('alias_exten').value.length > 0){
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { 									
				delete voicemenusdata[deleted_voicmenu];
			},
			onFailure: function(t) {
				gui_alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		var existing_alias_string = voicemenusdata[deleted_voicmenu].alias_exten + ",1,Goto(" + deleted_voicmenu + "|s|1)"  ;
		var uri = build_action('delete', 0, specialcontext ,"exten", "", existing_alias_string ); 
		opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
		var tmp = new Ajax.Request("../../rawman", opt);
	}
	delete voicemenusdata[deleted_voicmenu];
}


function change_vmenuname_inlistofmenus(oldname,newname){
	for (var k=0; k< keys.length; k++){
		var current_key_menus='keypress_'+ keys[k] + '_menus';
		var _ckm = _$(current_key_menus) ;
		for(var i=0; i< _ckm.options.length; i++){
			if( _ckm.options[i].text == oldname ){
				_ckm.options[i].text = newname;
				break;
			}
		}
	}
}


function  key_action(a, field){
	enable_savecancel();

	_mft = _$('keypress_'+ field + '_text' );
	_mfe = _$('keypress_'+ field + '_exts').style;
	_mfm = _$('keypress_'+ field + '_menus').style
	_mft.style.display = "none";
	_mfe.display = "none";
	_mfm.display = "none";

	if(a=='gotomenu'){ //show menus dropdown
		_mfm.display = "";
	}else if(a=='gotoextension'){ //show extensions dropdown
		_mfe.display = "";
	}else if(a=='Custom'){ //show a  text box
		_mft.style.display = "";
		_mft.focus();
	}else if(a=='disabled' || a=='Hangup' || a=='PlayInvalid'){	//show nothing

	}
}

function sortNumber(a,b){
	return a - b ;
}


function add_newstep(){
	var _vmv = _$('vmenus').value ;
	var _nsa = _$('newstep_action');
	var _nsv = _$('newstep_var') ;

	if( !_nsa.value ){
		gui_alert("Please select an action for this step");
		_nsa.focus();
		return;
	}

	if( _nsa.value != "Answer" &&   _nsa.value != "Hangup" && !_nsv .value ){
		gui_alert("Please enter a value for '" + _nsa.value +"'");
		_nsv.focus();
		return;
	}
	_$('status_message').style.display = "";
	// prepare a request to add the new step to the voicemenu
	// make a request to append
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function() { 
			setTimeout(function(){ _$('status_message').style.display = 'none'; },sc_displaytime);
			// if request successfull then add this to the steps select box
			var newoption = document.createElement("option"); 
			newoption.text = format_step(action_string ); 
			newoption.value = action_string ;
			var _steps = _$('steps') ;
			_steps.options.add ( newoption );
			// and also add the information to the voicemenus data
			if(voicemenusdata[_vmv].extensions['s']){
				voicemenusdata[_vmv].extensions['s'].push(action_string);
			}else{
				voicemenusdata[_vmv].extensions['s'] = new Array;
				voicemenusdata[_vmv].extensions['s'][0] = action_string;
			}
			// empty this textbox & disable this button, select the newly added item to the steps options box
			_nsa.selectedIndex = 0;
			_$('deletestep').disabled = false;
			_steps.selectedIndex = _steps.length - 1 ;
			_$('status').innerHTML = "<i>New step added !</i>";
			update_updown();
			_nsv.value = "";
			_nsv.style.display = "none" ;
			_$('add_newstep_extensions').style.display = "none";
			_$('add_newstep_menus').style.display = "none";
			_$('combodiv_sounds').style.display = "none" ;
			_nsvd = _$('newstep_var_digit'); 
			_nsvd.value= "";
			_nsvd.style.display= "none" ;
		},
		onFailure: function(t) {
			_$('status_message').style.display = 'none';
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	var uri = "";
	var action_string = "";
	var priorities = new Array;

	// algorithm 4 calculate new priority
	if(voicemenusdata[_vmv].extensions['s'] && voicemenusdata[_vmv].extensions['s'].length > 0 ){
		for( var p=0; p < voicemenusdata[_vmv].extensions['s'].length; p ++){
			var temp  = voicemenusdata[_vmv].extensions['s'][p].split(',');
			priorities.push(temp[1]);
		}
		priorities = priorities.sort(sortNumber);
		newpriority = parseInt(priorities[priorities.length - 1]) + 1;
	}else{
		newpriority = 1;
	}

	switch ( _nsa.value ){
	case 'Answer':
		action_string = "s,"+ newpriority+ ",Answer";
		break;
	case 'Background':
		action_string = "s,"+ newpriority+ ",Background(" + _nsv.value + ")";
		break;
	case 'DigitTimeout':
		action_string = "s,"+ newpriority+ ",DigitTimeout(" + _nsv.value + ")";
		break;
	case 'ResponseTimeout':
		action_string = "s,"+ newpriority+ ",ResponseTimeout(" + _nsv.value + ")";
		break;
	case 'Playback':
		action_string = "s,"+ newpriority+ ",Playback(" + _nsv.value + ")";
		break;
	case 'Wait':
		action_string = "s,"+ newpriority+ ",Wait(" + _nsv.value + ")";
		break;
	case 'WaitExten':
		action_string = "s,"+ newpriority+ ",WaitExten(" + _nsv.value + ")";
		break;
	case 'GotoMenu':
		action_string = "s,"+ newpriority+ ",Goto(" + _nsv.value + "|s|1)";
		break;
	case 'GotoExtension':
		action_string = "s,"+ newpriority+ ",Goto(default|" + _nsv.value + "|1)";
		break;
	case 'Hangup':
		action_string = "s,"+ newpriority+ ",Hangup";
		break;
	default : 
		action_string = "s,undefined,undefined"; 
	}

	uri += build_action('append', 0, _vmv,"exten", action_string ); 
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	tmp = new Ajax.Request('../../rawman', opt);

}



function next_freevmenu(){	 // return the next smallest available voicemenu name
	var x=1;
	while(typeof voicemenusdata['voicemenu-custom-'+x] != 'undefined' ) x++;
	return 'voicemenu-custom-'+x ;
}


function save_vmenu(){
	var _ae = _$('alias_exten') ;
	var _vms = _$('vmenus') ;
	var _ale = _$('allowexten');

	if( _ae.value.length > 0 && localextenlength !=0 && localextenlength !=  _ae.value.length){
		gui_alert("Sorry, An Extension must be  "+ localextenlength  + " digits !");
		_ae.focus();
		return false;
	}
	if (!check_patternonfields( [ 'comment', 'newstep_var_digit' ] ) ){
		return false;
	}
	_$('status_message').style.display ="" ;
	var _cmv = _$('comment').value ;

	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function() { 
			setTimeout( function(){_$('status_message').style.display="none"; },sc_displaytime );
			_$('status').innerHTML = "<i>Updated.</i>";
			_$('savevmenu').disabled = true;
			_$('save').disabled = true;
			_$('cancel').disabled = true;
			
			if( _vms.options[_vms.selectedIndex].innerHTML=='New Entry' ){ // (if new Voicemenu 
				voicemenusdata[current_vmenu] = new Object();	
				voicemenusdata[current_vmenu].comment =  _cmv ;
				voicemenusdata[current_vmenu].alias_exten =  _ae.value;
				voicemenusdata[current_vmenu].extensions = new Object();
				// add the "s,1,Answer" data to voicemenus data
				voicemenusdata[current_vmenu].extensions['s'] = new Array();
				voicemenusdata[current_vmenu].extensions['s'][0] = answer_call_string;
				for (var k=0; k< keys.length; k++){
					if( buildstring[keys[k]] ){
						voicemenusdata[current_vmenu].extensions[keys[k]] = new Array();
						voicemenusdata[current_vmenu].extensions[keys[k]][0] = buildstring[keys[k]] ;
					}
				}
				// update vmenus
				_vms.options[_vms.selectedIndex].text = "VoiceMenu - " + _cmv;
				_vms.options[_vms.selectedIndex].value = current_vmenu;
				select_vmenu();
				// add the new menu to the list of menus being displayed in the keypad options
				add_newvmenu_tolistofkeymenus();

			}else{ // if editing existing keypress options
				for (var k=0; k< keys.length; k++){
					if( buildstring[keys[k]] ){
						voicemenusdata[current_vmenu].extensions[keys[k]] = new Array();
						voicemenusdata[current_vmenu].extensions[keys[k]][0] = buildstring[keys[k]] ;
					}else{
						if( voicemenusdata[current_vmenu].extensions[keys[k]] ){
							voicemenusdata[current_vmenu].extensions[keys[k]] = [];
						}
					}
				}
			}

		},
		onFailure: function(t) {
			_$('status_message').style.display='none';
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	var uri = "" ;
	var p = 0 ;
	var buildstring = new Object ;

	if( _vms.options[_vms.selectedIndex].innerHTML=='New Entry' ){
		var current_vmenu = next_freevmenu();
		uri += build_action('newcat', p, current_vmenu,"", ""); p = p+1;
		uri += build_action('append', p, current_vmenu,"comment", _cmv ); p = p+1;
		uri += build_action('append', p, current_vmenu,"alias_exten", _ae.value); p = p+1;
		if(_ae.value.length > 0){
			// alias for this voicemenu in [default] section of extensions.conf
			var alias_string = _ae.value + ",1,Goto(" + current_vmenu + "|s|1)"  ;
			uri += build_action('append', p, specialcontext ,"exten", alias_string ); p = p+1;
		}

		if( _ale.checked){ uri += build_action('append', p, current_vmenu,"include", "default"); p = p+1; }
		uri += build_action('append', p, current_vmenu,"exten", answer_call_string); p = p+1;
	}else{
		// Updating existing Voicemenu
		var current_vmenu = _vms.value;
		if(  voicemenusdata[current_vmenu].comment != _cmv ){
			uri += build_action('update', p, current_vmenu ,"comment", _cmv); p = p+1;
			change_vmenuname_inlistofmenus(voicemenusdata[current_vmenu].comment,_cmv);
			voicemenusdata[current_vmenu].comment = _cmv;
		}
		
		if(  voicemenusdata[current_vmenu].alias_exten != _ae.value ){
			var existing_alias_string = voicemenusdata[current_vmenu].alias_exten + ",1,Goto(" + current_vmenu + "|s|1)"  ;
			if( _ae.value.length > 0 ){
				// change alias for this voicemenu in 'default' section of extensions.conf
				var new_alias_string = _ae.value + ",1,Goto(" + current_vmenu + "|s|1)"  ;
				uri += build_action('update', p, specialcontext ,"exten", new_alias_string,existing_alias_string); p = p+1;
			}else{
				// if the user is deleting the alias for this voicemenu, then delete the defined alias in the [default] extensions.conf
				uri += build_action('delete', p, specialcontext ,"exten", "",existing_alias_string); p = p+1;
			}

			uri += build_action('update', p, current_vmenu ,"alias_exten", _ae.value ); p = p+1;
			voicemenusdata[current_vmenu].alias_exten = _ae.value;
		}
		
		if( voicemenusdata[current_vmenu].include =="default" && !_ale.checked ){
			uri += build_action('delete', p, current_vmenu ,"include",""); p = p+1;
			voicemenusdata[current_vmenu].include = "" ;
		}else if ( voicemenusdata[current_vmenu].include !="default"  && _ale.checked ){
			uri += build_action('append', p, current_vmenu,"include", "default"); p = p+1;
			voicemenusdata[current_vmenu].include = "default" ;
		}else if ( !voicemenusdata[current_vmenu].include && _ale.checked ){
			uri += build_action('append', p, current_vmenu ,"include", "default"); p = p+1;
			voicemenusdata[current_vmenu].include = "default" ;
		}

		for (var k=0; k< keys.length; k++){
			if(voicemenusdata[current_vmenu].extensions[keys[k]]){
				uri += build_action('delete', p, current_vmenu,"exten", "", voicemenusdata[current_vmenu].extensions[keys[k]][0] ); p = p+1;
			}
		}
	}

	// Build exten strings for enabled keys and append/update the 
	for (var k=0; k< keys.length; k++){
		var current_key_action='keypress_'+ keys[k] + '_action';
		var current_key_text='keypress_'+ keys[k] + '_text';
		var current_key_exts='keypress_'+ keys[k] + '_exts';
		var current_key_menus='keypress_'+ keys[k] + '_menus';
	
		if( $(current_key_action).value == "disabled")
			continue;
		else if( $(current_key_action).value == "gotomenu" )
				buildstring[keys[k]] = keys[k] + ",1,Goto("+ $(current_key_menus).value + "|s|1)" ;					
		else if( $(current_key_action).value == "gotoextension" )
				buildstring[keys[k]] = keys[k] + ",1,Goto(default|"+ $(current_key_exts).value + "|1)" ;					
		else if( $(current_key_action).value == "Custom" ) 
				buildstring[keys[k]] = keys[k] + ",1,"+ $(current_key_text).value ;
		else if( $(current_key_action).value == "Hangup" )
				buildstring[keys[k]] = keys[k] + ",1,"+ "Hangup" ;					
		else if( $(current_key_action).value == "PlayInvalid" ) 
				buildstring[keys[k]] = keys[k] + ",1,"+ "Playback(invalid)" ;
					
		uri += build_action('append', p, current_vmenu,"exten", buildstring[keys[k]]); p = p+1;
	}

	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	// send the request
	tmp = new Ajax.Request('../../rawman', opt);
}


function  enable_savecancel(){
	_$('save').disabled=false;
	_$('savevmenu').disabled = false;
	_$('cancel').disabled = false;
}


function generate_fields(key){
	var t = '<select  class="input8" style="font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"   id=\'keypress_'+ key + '_action\' onchange="key_action(this.value, \'' + key + '\')">\n';
	t += '<option value="disabled">Disabled</option>\n' ;
	t += '<option value="gotomenu">Goto Menu</option>\n';
	t += '<option value="gotoextension">Goto Extension</option>\n';
	t += '<option value="Custom">Custom</option>\n';
	t += '<option value="Hangup">Hangup</option>\n';
	t += '<option value="PlayInvalid">Play Invalid</option>\n';
	t += '</select>&nbsp;<input type="text" class="input8" size=16 style="display:none;font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;" id="keypress_' + key+ '_text" onchange="enable_savecancel()">\n';
	t += '<select  style="display:none; font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"  id="keypress_'+ key + '_menus" onchange="enable_savecancel()" class="input8"></select>\n';
	t += '<select  style="display:none; font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"  id="keypress_'+ key + '_exts" onchange="enable_savecancel()" class="input8"></select>\n';
	return t;
}

function step_onselect(){
	// enable delete button
	if(_$('steps').value){
		_$('deletestep').disabled = false;
	}

	// enable Up/Down buttons accordingly
	update_updown();
}

function update_updown(){
	var _steps = _$('steps') ;
	_$('stepUp').disabled =( _steps.selectedIndex ) ? false : true ; 
	_$('stepDown').disabled = ( _steps.selectedIndex != (_steps.length-1) ) ? false: true ;
}

function step_up(){ // Swap x, x-1
	var _steps = _$('steps') ; 
	swap_step(_steps.selectedIndex, _steps.selectedIndex-1 );
}


function step_down(){	//swap x, x+1
	var _steps = _$('steps') ;
	swap_step( _steps.selectedIndex, _steps.selectedIndex+1 );
}


function swap_step(a,b){
	var _steps = _$('steps');
	var _vms_v = _$('vmenus').value ;

	var tmp1 = _steps.options[a].value.split(",") ;
	var priority_1 = tmp1[1];
	var tmp2 = _steps.options[b].value.split(",") ;
	var priority_2 = tmp2[1];

	tmp1.splice(1,1,priority_2);
	tmp2.splice(1,1,priority_1);

	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function() { 
			// update voicemenusdata
			for(var p=0; p< voicemenusdata[_vms_v].extensions['s'].length; p++){
				if( voicemenusdata[_vms_v].extensions['s'][p] == _steps.options[a].value ){
					voicemenusdata[_vms_v].extensions['s'][p] = tmp1.join();
				}else if (voicemenusdata[_vms_v].extensions['s'][p] == _steps.options[b].value  ){ 
					voicemenusdata[_vms_v].extensions['s'][p] = tmp2.join();
				}
			}
			// swap select values of a to b
			_steps.options[a].value = tmp2.join();
			_steps.options[b].value = tmp1.join();
			var buffer = _steps.options[a].text;
			_steps.options[a].text = _steps.options[b].text;
			_steps.options[b].text = buffer;
			_steps.selectedIndex = b;
			_$('status').innerHTML = "<i>Step Priority Updated!</i>";
			update_updown();

		},
		onFailure: function(t) {
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};	
	var uri = "";

	// ok find $('steps').options[a].value in extensions.conf and replace it with tmp1.join() and also replace $('steps').options[b].value with tmp2.join()	
	uri += build_action('update', 0, _vms_v ,"exten",tmp1.join(), _steps.options[a].value);
	uri += build_action('update', 1, _vms_v ,"exten",tmp2.join(), _steps.options[b].value);
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	tmp = new Ajax.Request('../../rawman', opt);
}


function delete_step(){
	// delete the selected step and update voicemenusdata and update 'select' object - steps
	_$('status_message').style.display="";
	var _vmenus = _$('vmenus');
	var _steps = _$('steps');

	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function() { 
			setTimeout(function(){ _$('status_message').style.display='none';} ,sc_displaytime);
			// Update voicemenusdata
			for(var p=0; p< voicemenusdata[_vmenus.value].extensions['s'].length; p++){
				if( voicemenusdata[_vmenus.value].extensions['s'][p] == _steps.value ){ 
					voicemenusdata[_vmenus.value].extensions['s'].splice(p,1); 
				}
			}
			_steps.remove( _steps.selectedIndex);
			_$('status').innerHTML = "<i>Step Deleted !</i>";
			_$('deletestep').disabled = true;
		},
		onFailure: function(t) {
			_$('status_message').style.display='none';
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};	
	var uri = "";
	uri += build_action('delete', 0, _vmenus.value,"exten", "", _steps.value); 
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	tmp = new Ajax.Request('../../rawman', opt);
}


function update_newstep_var(){
	var _nsv = _$('newstep_var') ;
	var _nsa = _$('newstep_action');
	var _ane = _$('add_newstep_extensions') ;
	var _anm = _$('add_newstep_menus') ;

	_nsv.value = "";
	_nsv.style.display = "none";
	_$('newstep_var_digit').style.display= "none" ;
	_$('combodiv_sounds').style.display = "none" ;
	_ane.style.display = "none";
	_anm.style.display = "none";

        if( _nsa.value== "" || _nsa.value== "Answer"  || _nsa.value== "Hangup"  ){

        }else if( _nsa.value== "Background"  || _nsa.value== "Playback" ){
                _nsv.style.display = "";
                _nsv.size= 12;
        }else if( _nsa.value== "DigitTimeout"  || _nsa.value== "ResponseTimeout" ||  _nsa.value== "Wait"  ||  _nsa.value== "WaitExten" ){
                _$('newstep_var_digit').style.display= "" ;
        }else if(_nsa.value== "GotoMenu"  ){
		_nsv.value = _anm.value;
		_anm.style.display = "";
        }else if(_nsa.value== "GotoExtension"  ){
		_nsv.value = _ane.value;
		_ane.style.display = "";
        }
}


function select_vmenu(){
	// show all the //s, lines in the select box -
	if(_$('vmenus').selectedIndex ==-1){ return true;}

	var _steps = _$('steps');
	current_context = _$('vmenus').value;
	var x, y, tmp;
	var priority_1, priority_2, buffer;
	
	_$('allowexten').checked = (voicemenusdata[current_context].include == "default") ? true : false ;
 	//$('keypressoptions').innerHTML = "";
	_steps.options.length =0;
	_$('comment').value = voicemenusdata[current_context].comment;
	_$('alias_exten').disabled = false;
 	_$('alias_exten').value = ( voicemenusdata[current_context].alias_exten  ) ? voicemenusdata[current_context].alias_exten : "" ;

	if(voicemenusdata[current_context].extensions['s']){
		for (var x=0;x<voicemenusdata[current_context].extensions['s'].length ; x++ ){
			var newoption = document.createElement("option");
			newoption.text = format_step(voicemenusdata[current_context].extensions['s'][x]);
			newoption.value = voicemenusdata[current_context].extensions['s'][x];
			_steps.options.add ( newoption );
		}
	}

	// To be done: replace the following bubble sort with js native sort method
	for (var x = (_steps.length - 1); x >= 0; x--){
		for (var y = 1; y <= x; y++){
			tmp = _steps.options[y].value.split(",") ;
			priority_1 = tmp[1];
			tmp = _steps.options[y-1].value.split(",") ;
			priority_2 = tmp[1];
			if (priority_2 - priority_1 > 0){
				buffer = _steps.options[y-1].value;
				_steps.options[y-1].value = _steps.options[y].value;
				_steps.options[y].value = buffer;
				buffer = _steps.options[y-1].text;
				_steps.options[y-1].text = _steps.options[y].text;
				_steps.options[y].text = buffer;
			}
		}
	}

	_steps.disabled = false;
	_$('addstep').disabled = false;
	_$('allowexten').disabled = false;
	_$('comment').disabled = false;
	_$('deletestep').disabled = true;
	_$('delete').disabled = false;
	_$('newstep_action').disabled = false;
	_$('newstep_var').disabled = false;
	_$('keypressoptions').style.display = "";
	_$('stepDown').disabled = true;
	_$('stepUp').disabled = true;
	_$('savevmenu').disabled = true;

	for (y=0; y<keys.length ; y++ ){
		current_key_action='keypress_'+ keys[y] + '_action';
		current_key_text='keypress_'+ keys[y] + '_text';
		current_key_exts='keypress_'+ keys[y] + '_exts';
		current_key_menus='keypress_'+ keys[y] + '_menus';

		_$(current_key_action).options.selectedIndex = 0;
		_$(current_key_menus).style.display = "none";
		_$(current_key_text).style.display = "none";
		_$(current_key_exts).style.display = "none";

		if(voicemenusdata[current_context].extensions[keys[y]]){
			// Load the appropriate Key menu according to the voicemenusdata[current_context].extensions[y][x]
			// actually we are assuming that there is only voicemenusdata[current_context].extensions[y][0]
			tmp = voicemenusdata[current_context].extensions[keys[y]][0].split(',');

			if( tmp[2].match("Goto") && tmp[2].match("voicemenu-") ){ //  if "is a voicemenu"
				_$(current_key_action).options[1].selected = true;
				_$(current_key_menus).style.display = "";
				select_menu (current_key_menus, tmp[2],"ismenu");
			}else  if( tmp[2].match("Goto") && !tmp[2].match("voicemenu-") ){ // //  if "goto an extension " (no 'voicemenu-')
				_$(current_key_action).options[2].selected = true;
				_$(current_key_exts).style.display = "";
				select_menu(current_key_exts, tmp[2],"isext"); // select_menu common for exts and menus
			}else if(tmp[2].match("Hangup") ){ // if HangUp
				_$(current_key_action).options[4].selected = true;							
			}else if( tmp[2].match('Playback') &&  tmp[2].match( "(invalid)" ) ){
				_$(current_key_action).options[5].selected = true;											
			}else{ // if custom (no 'goto')
				_$(current_key_action).options[3].selected = true;
				_$(current_key_text).style.display = "";
				_$(current_key_text).value = tmp[2];
			}
		}else{	// Key_action is disabled => hide the text & options (which already are)

		}
	}
}


menuscallbacks.postselect = function() {
	select_vmenu();
}

menuscallbacks.format = function(t, x) {
	var tmp = t.name.split('general');
	var exten_fields;

	if(tmp.length > 1 ){
		return false;
	}else if ( t.name.substr(0,10) == 'voicemenu-' && x==undefined ){	// if is a category
		current_context = t.name;
		voicemenusdata[current_context] = new Object();
		return t.name ;
	}else if(t.name.substr(0,10) == 'voicemenu-' ) { 	// if is a subcategory
		switch( t.names[x] ){
			case 'comment':
				voicemenusdata[current_context].comment =  t.fields[x];
				voicemenusdata[current_context].extensions = new Object();
				return false;
			case 'alias_exten':
				voicemenusdata[current_context].alias_exten =  t.fields[x];
				return false;
			case 'include':
				voicemenusdata[current_context].include=  t.fields[x];
				return false;
			case 'exten':
				exten_fields = t.fields[x].split (',');
				if(!voicemenusdata[current_context].extensions[exten_fields[0]]){
					voicemenusdata[current_context].extensions[exten_fields[0]] = new Array();
				}
				voicemenusdata[current_context].extensions[exten_fields[0]].push( t.fields[x] ) ;
				return false;
			default :
				return false;
		}
		return false;
	}else{
		return false;
	}
}


menuscallbacks.loaded = function(){
	var _vmenus = _$('vmenus') ;
	for (var x=0; x< _vmenus.options.length ; x++ ){
		_vmenus.options[x].text = "VoiceMenu - " + voicemenusdata[_vmenus.options[x].value].comment;
	}
	// Load the menus and extensions into corresponding fields
	for (var y=0;y < keys.length; y++){
		current_key_exts='keypress_'+ keys[y] + '_exts';
		current_key_menus='keypress_'+ keys[y] + '_menus';
		load_extensions(current_key_exts);
		load_menus(current_key_menus);
	}
	load_extensions('add_newstep_extensions');
	load_menus('add_newstep_menus');
	parent.loadscreen(this);
}

menuscallbacks.identifier = "extension";

menuscallbacks.eachline = true;

menuscallbacks.includecats = true;

menuscallbacks.cancelnewcategory =function(){
	_$('comment').disabled = true;
	_$('keypressoptions').style.display = "none";
}

menuscallbacks.oncategorydelete =function(){
	delete_vmenu_fromlistofmenus();
	_$('comment').disabled = true;
	_$('keypressoptions').style.display = "none";
	_$('savevmenu').disabled = true;
	_$('steps').options.length =0;
	_$('newstep_action').disabled = true;
	_$('newstep_var').disabled = true;
	_$('addstep').disabled = true;
	_$('steps').disabled = true;
	_$('stepUp').disabled = true;
	_$('stepDown').disabled = true;
	_$('alias_exten').value = "";
	_$('alias_exten').disabled = true;
}

menuscallbacks.cancelchanges =function(){
	_$('savevmenu').disabled = true;
}

menuscallbacks.newcategory = function(t) {
	// 1. Reset all Keyoptions
	// Load the menus and extensions into corresponding fields
	for (var y=0;y<keys.length; y++){
		current_key_exts='keypress_'+ keys[y] + '_exts';
		current_key_menus='keypress_'+ keys[y] + '_menus';
		current_key_text = 'keypress_'+ keys[y] + '_text' ;
		current_key_action='keypress_'+ keys[y] + '_action';
	
		load_extensions(current_key_exts);
		load_menus(current_key_menus);
		_$(current_key_action).selectedIndex = 0;
		_$(current_key_exts).style.display = "none";
		_$(current_key_menus).style.display = "none";
		_$(current_key_text).style.display = "none";
	}
	// 2. Reset Steps - only 1 step -> Answer
	var _steps = _$('steps') ;
	var _comment = _$('comment'); 
	var _allowexten = _$('allowexten') ;
	var _alias_exten = _$('alias_exten') ;
	_steps.options.length =0;
	var newoption = document.createElement("option");
	newoption.text = format_step(answer_call_string);
	newoption.value = answer_call_string;
	_steps.options.add ( newoption );
	// 3. Disable Steps - Add Step , Up , Down Arrows
	_$('stepUp').disabled = true;
	_$('stepDown').disabled = true;
	_allowexten.checked = false;
	_allowexten.disabled = false;
	_$('newstep_action').disabled = true;
	_$('newstep_var').disabled = true;
	_$('addstep').disabled = true;
	_steps.disabled = true;
	//  4. Reset Comment
	_$('keypressoptions').style.display = "";
	_alias_exten.disabled = false;
	_alias_exten.value = "";
	_comment.disabled = false;
	_comment.value = "";
	_comment.focus();
}


function localajaxinit() {
	showdiv_statusmessage();
	setWindowTitle("Voice Menus");
	_$('message_text').innerHTML ="Saving Changes...";
	for (x =0 ; x<fieldnames.length; x++){
		widgets[fieldnames[x]] = _$(fieldnames[x]);
		widgets[fieldnames[x]].disabled = true;
	}
	//parent.loadscreen(this);
	parent.astmanEngine.config2list("extensions.conf", _$('extensions'), new Array(), extencallbacks);
}

//extencallbacks
extencallbacks.format = function(t, x) {
	var res;
	var qname;
	if ((t.name != specialcontext))
	return null;

	// check whether the extension is an alias to a custom voice menu
	try{
		var temp = t.fields[x].split(',') ;
		if ( temp[2].match("Goto") && temp[2].match("voicemenu-custom-" )  ){ return null ; }
	}
	catch(e){

	}

	res = format_extension(_$('extensions'), t, x);
	return res;
}

extencallbacks.loaded = function() {
	parent.astmanEngine.run_tool("sh /etc/asterisk/gui_sysinfo", callback = function() { 
	var opt = { method: 'get', asynchronous: true,
		onComplete: function(originalRequest){
			_$('sysinfohtml').innerHTML = originalRequest.responseText;
			// Add Default sound files to the list of sound files
			var j = _$('sound_files').innerHTML ;
			var sndfiles = j.split("<br>") ;
			var New_OPTION = document.createElement('option');
			New_OPTION.text = "Default Sounds"  ;
			New_OPTION.value = ""  ;
			New_OPTION.style.fontWeight = "bold";
			try {
				_$('combosel_sounds').add(New_OPTION, null); // W3C way
			}catch(ex) {
				_$('combosel_sounds').add(New_OPTION); // IE way
			}
			var file_name;
			for( var i =0 ; i < sndfiles.length ; i++){
				if( typeof sndfiles[i] == "undefined"  || sndfiles[i] == "" ){
					continue;
				}
				sndfiles[i] = sndfiles[i].replace(/^\s*|\s*$/g,'') ;
				if( sndfiles[i] == "" ){ continue; }
				file_name = sndfiles[i].stripTags() ;
				file_name = file_name.substr(0,(file_name.length - 4) ) ;
				New_OPTION = document.createElement('option');
				New_OPTION.text =  file_name  ;
				New_OPTION.value = file_name ;
				try {
					_$('combosel_sounds').add(New_OPTION, null); // W3C way
				}catch(ex) {
					_$('combosel_sounds').add(New_OPTION); // IE way
				}
			}
			// Add Recorded Voiemenus to the list of sound files
			var k = _$('rec_files').innerHTML ;
			var recfiles = k.split("<br>") ;
			New_OPTION = document.createElement('option');
			New_OPTION.text = "Recorded Voicemenus"  ;
			New_OPTION.value = ""  ;
			New_OPTION.style.fontWeight = "bold";
			try {
				_$('combosel_sounds').add(New_OPTION, null); // W3C way
			}catch(ex) {
				_$('combosel_sounds').add(New_OPTION); // IE way
			}
			var file_name;
			for( var i =0 ; i < recfiles.length ; i++){
				if( typeof recfiles[i] == "undefined"  || recfiles[i] == "" ){
					continue;
				}
				recfiles[i] = recfiles[i].replace(/^\s*|\s*$/g,'') ;
				if( recfiles[i] == "" ){ continue; }
				file_name = recfiles[i].stripTags() ;
				file_name = file_name.substr(0,(file_name.length - 4) ) ;
				New_OPTION = document.createElement('option');
				New_OPTION.text =  file_name  ;
				New_OPTION.value = file_name ;
				try {
					_$('combosel_sounds').add(New_OPTION, null); // W3C way
				}catch(ex) {
					_$('combosel_sounds').add(New_OPTION); // IE way
				}
			}
			parent.astmanEngine.config2list("users.conf", _$('users'), new Array(), usercallbacks);
		},
		onFailure: function(t) { alert("Config Error: " + t.status + ": " + t.statusText); }
	};
	opt.parameters="";
	var tmp = new Ajax.Request("./bkps/sysinfo_output.html", opt);
	});
}

extencallbacks.eachline = true;

// user callbacks
usercallbacks.format = function (t,x){
	if ((t.name == 'general')){
		if (t.fieldbyname['localextenlength'] && t.fieldbyname['localextenlength'].length){
			localextenlength =  t.fieldbyname['localextenlength'] ;
		}else{
			localextenlength =  4 ;
		}
		return null;
	}

	//if (t.name.substring(0,6) == 'trunk_')
	//	return null;
	if ( t.fieldbyname['context'] == asterisk_guiTDPrefix + t.name ) {
		return null;
	}else{
		return t.name;
	}
}

usercallbacks.identifier = "extension";

usercallbacks.loaded = function (){
	var _exts = _$('extensions') ;
	var _users = _$('users') ;

	for(var p=0; p < _exts.length; p++){
		var tmp = _exts.options[p].text.split (" -- ");
		extensions_array.push (tmp[0]);
	}
	for(var p=0; p < _users.length; p++){
		extensions_array.push (_users.options[p].text);
	}
	extensions_array = extensions_array.sort(); // or extensions_array.sort(sortNumber);
	parent.astmanEngine.config2list("extensions.conf", _$('vmenus'), widgets, menuscallbacks);
}

function free_mem(){
	if( navigator.userAgent.indexOf("MSIE") == -1 ){ return true; }
	try{
		widgets['save'].hostselectbox = null ;
		widgets['cancel'].hostselectbox = null ;
		widgets['new'].hostselectbox = null ;
		widgets['delete'].hostselectbox = null ;
		purge( document.body );
	} catch(e){ }
}
</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF" onunload="free_mem()">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Voice Menus Configuration</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr valign="top">
		<td colspan='2'> Voice Menus: </td>
	</tr>
	<tr valign="top">
		<td>	<select size="25" id="vmenus" style="width:180px;" class="input10"><option>Loading...</option></select>	</td>
		<td valign=top align="right" width=346 height=415>
			<select id='extensions' style='display:none;width:0px;height:0px'></select><select id='users' style='display:none;width:0px;height:0px'></select><select id='recorded_files' style='display:none;width:0px;height:0px'></select>
			<table align="center" width="346">
			<tr>
				<td width="50" align=left class="field_text" onmouseover="show_tooltip('en', 'menus', 0);">Name:</td>
				<td align=left class="field_text">
					<input id='comment'  size=15 onKeyUp="enable_savecancel()"  pattern='^[a-zA-Z_0-9 ]*$' disabled  class="input8">&nbsp;
					<span onmouseover="show_tooltip('en', 'menus', 5);">
					Extension: <input id="alias_exten"  onKeyUp="enable_savecancel()"  size=4 disabled class="input8" onmouseover="show_tooltip('en', 'menus', 5);">
					</span>
				</td>
			</tr>
			<tr onmouseover="show_tooltip('en', 'menus', 1);">
				<td class="field_text">Steps:<BR>
					<input  style='width:45'  type="button" id="stepUp" value="Up" disabled onClick="step_up()" class="buttonbold"><BR><BR>
					<input  style='width:45' type="button" id="stepDown" value="Down" disabled onClick="step_down()" class="buttonbold">
				</td>
				<td rowspan=2><select id='steps' size=5  style="width:280px;" onClick="step_onselect()" disabled class="input8"></select></td>
			</tr>
			<tr  onmouseover="show_tooltip('en', 'menus',2);"><td colspan=2 class="field_text" height=4></td></tr>
			<tr  onmouseover="show_tooltip('en', 'menus',2);"><td colspan=2 class="field_text">Add a new Step:</td></tr>
			<tr><td colspan=2>

				<NOBR>
				<select id='newstep_action' disabled onChange="update_newstep_var()" class="input8">
					<option value=""> -- Select --</option>
					<option value="Answer">Answer</option>
					<option value="Background">Background</option>
					<!-- <option value="SetMusicOnHold">SetMusicOnHold</option> -->
					<option value="DigitTimeout">DigitTimeout</option>
					<option value="ResponseTimeout">ResponseTimeout</option>
					<option value="Playback">Playback</option>
					<option value="Wait">Wait</option>
					<option value="WaitExten">WaitExten</option>
					<option value="GotoMenu">Goto Menu</option>
					<option value="GotoExtension">Goto Extension</option>
					<option value="Hangup">Hangup</option>
				</select>&nbsp;
				<input type=text id="newstep_var" style="display:none" size=4 disabled class="input8">
				<select id='add_newstep_extensions' style="display:none"   onChange=" $('newstep_var').value = $('add_newstep_extensions').value;"   class="input8"></select>
				<select id='add_newstep_menus' style="display:none"    onChange=" $('newstep_var').value = $('add_newstep_menus').value;"   class="input8"></select>
				<div id="combodiv_sounds">
					<select size=5 id="combosel_sounds" style="font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;" class="input8"></select>
				</div>
				<input type=text id="newstep_var_digit" size=3 style="display:none;" onChange=" $('newstep_var').value = $('newstep_var_digit').value;"  pattern='^\d*$' class="input8">&nbsp;
				<SCRIPT LANGUAGE="JavaScript">combo_box('newstep_var', "combodiv_sounds","combosel_sounds"); </SCRIPT>
				<input type=button style='width:45' id='addstep' onclick="add_newstep()"  value="Add" disabled  class="buttonbold">
				&nbsp;<input type=button style='width:50' id='deletestep' onclick="delete_step()"  value="Delete" disabled  class="buttonbold">
				</NOBR>
			</td>
			</tr>
			<tr onmouseover="show_tooltip('en', 'menus', 3);">
				<td colspan=2 class="field_text">
				<label FOR="allowexten">
					&nbsp;<input type=checkbox id=allowexten disabled onclick="enable_savecancel()"> Dial other Extensions?
				</label>&nbsp;</td>
			</tr>
			<tr>	<td colspan=2 height=6></td></tr>
			<tr onmouseover="show_tooltip('en', 'menus', 4);">
				<td colspan=2 class="field_text">'Keypress' Events</td>
			</tr>
			<tr><td colspan=2>
				<div  style="width=340px;">
					<table cellpadding=3 cellspacing=0 width="100%">
					<TR bgcolor='#B8B8B8'>
						<TD width=35 class="field_text">Key</TD><TD class="field_text">Action</TD>
					</TR>
					</table>
				</div>
				<div id="keypressoptions" style="height:155px;width=340px; overflow :auto;display :none;">
					<table cellpadding=3 cellspacing=0 width="100%">
					<script>
					for (var k=0; k< keys.length; k++){
						var p =  generate_fields( keys[k] )  ; 
						switch(keys[k]){
							case 't': var omo =  "onmouseover=\"show_tooltip('en', 'menus', 6 );\" " ; break;
							case 'i': var omo =  "onmouseover=\"show_tooltip('en', 'menus', 7 );\" " ; break;
							default: var omo =  "" ;
						}
						document.write("<TR bgcolor='#FFFFFF' " + omo + ">\n"
						+ "<TD width=35 align=center><font style=\"font-size: 10pt\">"+keys[k]+"</font></TD>\n"
						+ "<TD>" 
						+ p
						+ "\n </TD></TR>\n\n" );
					}
					</script>
					</table>
				</div>
				</td>
			</tr>
			<tr>	<td colspan=2 align="center">
				<div style="height:15px" id='status'></div>
				</td>
			</tr>
			</table>
		</td>
	</tr>
	<tr>
	<td align='center'>
		<input style='width:80' type='button' id='new' value='New' class="buttonbold">&nbsp;
		<input style='width:80' type='button' id='delete' value='Delete' class="buttonbold">&nbsp;
	</td>
	<td align='right'>
		<input type="hidden" id="save">
		<input type='button' id='savevmenu' onClick="save_vmenu()" value='Save' disabled class="buttonbold">&nbsp;
		<input type='button' id='cancel' value='Cancel' class="buttonbold">&nbsp;
	</td>
	</tr>
</table>
</div>
<div id="sysinfohtml" style="display:none"></div>
</body>
<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "MeetMe Extensions"
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var trunks_desc = new Object;
var trunkcallbacks = new Object;
var numplan_callbacks = new Object;
var default_numberplan = 0;
var default_np_rules = new Array;
var default_np_comments = new Array;
var default_np_data = new Object;
var isnewrule ;
var iscustom ;
var pattern_beingedited ;
var pattern_beingedited_priority ;
var oldselect;

function addthe_default_callingplan(){
	t=confirm("A default Dial Plan is not found. \n" + " Do you want to create a default Dial Plan ");
	if(t == false){ 
		$('status').innerHTML = "A default DialPlan is not found !! "
		+ "<BR> <A href=\"#\" onclick=\"addthe_default_callingplan()\">click here</A> to create a default Dial plan";
		$('addrule').disabled = 1;
		return true; 				
	}
	var default_planname = 'numberplan-custom-1' ;
	var uri = build_action('newcat', 0, default_planname ,"", "");
	uri += build_action('append', 1, default_planname,"plancomment", "DialPlan1"); 
	uri += build_action('append', 2, default_planname,"include", "default"); 
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { location.reload(); },
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters= "action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request("../../rawman", opt);
}




trunkcallbacks.format = function(t) {
	if (t.name.substr(0,6) != 'trunk_')
		return null;
	if (t.fieldbyname['trunkname'] && t.fieldbyname['trunkname'].length) {
		trunks_desc[t.name] = new Object();
		trunks_desc[t.name].comment = t.fieldbyname['trunkname'] ;
		return t.fieldbyname['trunkname'];
	} else{
		trunks_desc[t.name] = new Object();
		trunks_desc[t.name].comment = t.name ;
		return t.name;
	}
}

trunkcallbacks.loaded = function(){
	$('trunks').addEventListener('click',hackenablesave,false);
	parent.astmanEngine.config2list("extensions.conf", $('extensions'), new Array(), numplan_callbacks);
}

function hackenablesave(){
	if( oldselect != $('trunks').value ){
		enablesave();
	}
}

numplan_callbacks.format = function(t, x) {
		var exten_fields;
		if(t.name == "numberplan-custom-1" && x == undefined ){ 
			default_numberplan = 1;
		}else if(t.name == "numberplan-custom-1" && t.names[x]=='exten' ){ 
			default_np_rules.push( t.fields[x] );
		}else if(t.name == "numberplan-custom-1" && t.names[x]=='comment' ){ 
			var tmp = t.fields[x].split(",");
			if( tmp.length > 1 ){
				default_np_comments.push( t.fields[x] );
			}
		}

	return false;
}

numplan_callbacks.loaded = function() {
	parent.loadscreen(this);
	if(!default_numberplan){
			// Redirect To creating a default Number Plan
			addthe_default_callingplan();
			return true;
	}
	for( var i=0; i < default_np_rules.length; i++){
				var temp = default_np_rules[i].split(","); // temp[0] is the pattern, temp[1] is the priority,temp[2] is 'Macro(trunkdial', temp[3] is ${trunkname}/${EXTEN:1})
				var temp1 = temp[3].split("{");
				var temp2 = temp1[1].split("}");
				var temp3 = temp1[2].split("}");
				var temp4 = temp3[0].split(":");
				temp[4] = temp2[0] ; // temp[4] is trunkname
				temp[5] = temp4[1] ; // temp[5] is the #digits to strip in the front
				if ( typeof default_np_data[temp[0]] == 'undefined' ) {
					default_np_data[temp[0]] = new Object();
				}
				default_np_data[temp[0]][temp[1]] = new Object();
				default_np_data[temp[0]][temp[1]].trunk = temp[4] ;
				default_np_data[temp[0]][temp[1]].digits2strip = temp[5] ;
	}
	for ( var i =0; i < default_np_comments.length ; i++){
			var temp = default_np_comments[i].split(",");
			default_np_data[temp[0]][temp[1]].rulename = temp[2] ;
			if(temp[3] !="custom"){
				default_np_data[temp[0]][temp[1]].ruledesc = parsepattern(temp[0],0) ;
			}else{
				default_np_data[temp[0]][temp[1]].ruledesc = "custom" ;
			}
	}
	// now show this object in a table.
	var rules_nosp = new Array ;
	for( var x in  default_np_data ){	// x is the pattern
			// sort the priorities
			if ( x == "extend"){ break;}
			var sorted_priorities = [];
			for ( var y in default_np_data[x] ){
				if ( y == "extend"){break;}
				sorted_priorities.push(y);
			}
			sorted_priorities.sort();
			// done sorting priorities
			// show fields in a table in the order of sorted priorities
			for( var z=0; z < sorted_priorities.length ; z++ ){
				//check if the trunk defined is actually an existing trunk
				var trunk_exists = 0;
				for(var i=0; i < $('trunks').length ; i++ ){
						if( $('trunks').options[i].value == default_np_data[x][sorted_priorities[z]].trunk ){
							trunk_exists = 1;
							break;
						}
				}				
				if ( default_np_data[x][sorted_priorities[z]].trunk  == "" ){
						rules_nosp.push(default_np_data[x][sorted_priorities[z]].rulename) ;
						//editcallingrule(x , sorted_priorities[z]);
						//return true;
						addrowtotable( x , sorted_priorities[z] , "undefined" , default_np_data[x][sorted_priorities[z]].digits2strip );
				}else if(trunk_exists == 0){
							rules_nosp.push(default_np_data[x][sorted_priorities[z]].rulename) ;
							//alert("Note: Calling Rule ("+default_np_data[x][sorted_priorities[z]].rulename+") has an invalid Service Provider\n");
							$('trunks').selectedIndex = -1;							
						addrowtotable( x , sorted_priorities[z] , "invalid" , default_np_data[x][sorted_priorities[z]].digits2strip );							
				}else{
						addrowtotable( x , sorted_priorities[z] , default_np_data[x][sorted_priorities[z]].trunk , default_np_data[x][sorted_priorities[z]].digits2strip );
				}
			}
	} 
	if(rules_nosp.length > 0 ){
		$('status').innerHTML = "Note: A Service Provider is not defined for the Rules <BR>" + rules_nosp ;
		$('trunks').selectedIndex = -1;
	}
}

numplan_callbacks.eachline = true;
numplan_callbacks.includecats = true;

function addrowtotable(a,b,c,d){	// a is pattern, b is priority, c is trunk, d is digits2strip

		var sno = $('callingRulesTable').rows.length + 1;
		var newRow = $('callingRulesTable').insertRow(-1);
		newRow.id = "row" + sno; 
		
		var newCell0 = newRow.insertCell(0);
		newCell0.innerHTML = sno ;
		newCell0.width=35;
		newCell0.align="center";

		var newCell1 = newRow.insertCell(1);
		newCell1.innerHTML =  default_np_data[a][b].rulename ; 
		newCell1.width=90;

		var newCell2 = newRow.insertCell(2);
		newCell2.innerHTML =  default_np_data[a][b].ruledesc ; 


		if(c == "invalid" || c== "undefined"  ){
			var newCell3 = newRow.insertCell(3);
			newCell3.innerHTML = "<B><font color=red>" + c + " trunk </font></B>"  ;
			newCell3.width=85;
		}else{
			var newCell3 = newRow.insertCell(3);
			newCell3.innerHTML = trunks_desc[c].comment  ;
			newCell3.width=85;
		}

		var newCell4 = newRow.insertCell(4);
		newCell4.innerHTML = "<A href=\"#\" onclick=\"editcallingrule('"+ a +"', '"+ b +"')\">Edit</A>&nbsp;&nbsp;<A href=\"#\" onclick=\"deletecallingrule('"+ a +"', '"+ b +"')\">Delete</A>";
		newCell4.width=75;
		newCell4.align="center";
		return true;
}

function deletecallingrule(a,b){
		t=confirm("Are you sure ?")
		if(t == false)
			return true;
		delete_callingrule(a,b, oncomplete = function(){location.reload();} )  ;
}

function delete_callingrule(a,b,oncomplete){
		if(default_np_data[a][b].ruledesc == 'custom'){
			var commentstring = "custom";
		}else{
			var commentstring = "standard";
		}

		var rule_string = a + ',' + b + ',Macro(trunkdial,${' + default_np_data[a][b].trunk + '}/${EXTEN:' + default_np_data[a][b].digits2strip + '})' ;
		var uri = build_action('delete', 0, "numberplan-custom-1" ,"exten", "", rule_string ); 
		commentstring = a + ',' + b + ',' + default_np_data[a][b].rulename + ',' + commentstring ;
		uri += build_action('delete', 1 , "numberplan-custom-1" ,"comment","", commentstring );

		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { oncomplete(); },
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		opt.parameters= "action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
		$('userscontent').style.display="none";
		$('bg_transparent').style.display ='none';
		$('status_message').style.display="block";
		var tmp = new Ajax.Request("../../rawman", opt);
}




function editcallingrule(a,b){
	pattern_beingedited = a ;
	pattern_beingedited_priority = b ;
	oldselect = $('trunks').value;
	isnewrule = false;
	$('rulename').value = default_np_data[a][b].rulename;
	$('trunks').selectedIndex = -1 ;
	for(var i=0; i < $('trunks').length ; i++ ){
			if( $('trunks').options[i].value == default_np_data[a][b].trunk ){
			$('trunks').selectedIndex = i ;
			break;
			}
	}
	$('pattern').value = a;
	$('strip').value = default_np_data[a][b].digits2strip;
	$('save_a').disabled = 1;

	if(default_np_data[a][b].ruledesc == 'custom' ){
		// if this is a custom pattern then donot try to parse the pattern
		iscustom = true;
		$('define_advanced').style.display="";
		$('define_usual').style.display="none";
	}else{
		// if this is standard pattern then parse the pattern into 'beginswith', 'followedby'
		var temp = parsepattern(a,1);
		iscustom = false;
		$('define_advanced').style.display="none";
		$('define_usual').style.display="";
	}

	$('userscontent').style.display="";
	$('bg_transparent').style.display ='';
	$('addrule').disabled =1;
}

function parsepattern(a,e){
	returnstring="";
	// Parsing into fields
	// if first character is underscore (always) - remove it 
	var temp = a.substr(1);
	// if there is a dot at the end 
	//		check ormore and remove the trailing dot
	if( temp.substr(-1,1) == "." ){
		temp = temp.slice(0, -1);
		returnstring = "or more";
		if(e == 1)
		$('ormore').checked = true;
	}
	var posofx = temp.indexOf('X');
	//alert("position of X in " + temp + " is " + posofx );
	// if X does not occur anywhere followedby is = 0
	// if X happens somewhere then beginswith = string till somewhere
	//		and followedby = length of string from somewhere till end
	if(posofx == -1){ 	
			if(returnstring == "or more"){
				returnstring = "Begins with " + temp + " and followed by 0 or more digits" ;
			}else{
				returnstring = "Exactly macthes " + temp  ;
			}
			if(e == 1){
				$('beginswith').value = temp;
				$('followedby').value = 0;
			}
	}else{
			if(returnstring == "or more"){
				returnstring = "Begins with " + temp.substr(0,posofx) + " and followed by "+(temp.length - posofx)+" or more digits" ;
			}else{
				returnstring = "Begins with " + temp.substr(0,posofx) + " and followed by "+(temp.length - posofx) + " digits";
			}
			if(e == 1){
				$('beginswith').value = temp.substr(0,posofx);
				$('followedby').value = (temp.length - posofx);
			}
	}

return returnstring;
}

function ownpattern(){
		iscustom = true;
		$('define_advanced').style.display="";
		$('define_usual').style.display="none";
}

function enablesave(){
	$('save_a').disabled = 0;
	return true;
}

function add_callingrule(){
	isnewrule = true;
	$('rulename').value = "";
	$('trunks').selectedIndex = -1 ;
	$('pattern').value = "";
	$('strip').value = "0" ;
	$('save_a').disabled = 1;
	$('define_advanced').style.display="none";
	$('define_usual').style.display="";
	$('userscontent').style.display="";
	$('bg_transparent').style.display ='';
	$('addrule').disabled =1;
	$('beginswith').value = "";
	$('followedby').value ="";
	$('ormore').checked = false;
}



function add_rule_fromeditform( this_priority, oncomplete ){
					if(	iscustom ){ // custom - take pattern as is
						var commentstring = "custom";
					}else{
						var commentstring = "standard";
						//build a pattern into $('pattern').value
						buildpatternstring();
					}
						
					var rule_string = $('pattern').value + ',' + this_priority + ',Macro(trunkdial,${' + $('trunks').value + '}/${EXTEN:' + $('strip').value + '})' ;
					var uri = build_action('append', 0 , "numberplan-custom-1" ,"exten", rule_string );
					commentstring = $('pattern').value + ',' + this_priority + ',' + $('rulename').value + "," + commentstring ;
					uri += build_action('append', 1 , "numberplan-custom-1" ,"comment", commentstring );

					var opt = {
						method: 'get',
						asynchronous: true,
						onSuccess: function(t) { oncomplete(); },
						onFailure: function(t) {
							alert("Config Error: " + t.status + ": " + t.statusText);
						}
					};
					opt.parameters= "action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
					$('userscontent').style.display="none";
					$('bg_transparent').style.display ='none';
					$('status_message').style.display="block";
					var tmp = new Ajax.Request("../../rawman", opt);
}


function saverule(){
	 if(isnewrule){ // add this rule to the default plan and reload the page
					var newpriority=1;
					if( typeof default_np_data[$('pattern').value] !="undefined" ){
						for ( var y in default_np_data[$('pattern').value] ){
							if ( y == "extend"){break;}
							newpriority++;
						}
					}
					add_rule_fromeditform( newpriority, oncomplete = function(){location.reload();}  );
	 }else{	// update exiting rule
			// delete existing rule
			// add rule with new values
			delete_callingrule(pattern_beingedited,pattern_beingedited_priority, oncomplete = function(){location.reload();} )  ;
			add_rule_fromeditform( pattern_beingedited_priority, oncomplete = function(){location.reload();}  );		

			//$('userscontent').style.display='none';
			//$('addrule').disabled =0;
			//return true;
	 }
}

function	buildpatternstring(){
	var pattern = $('beginswith').value;
	// Add an underscore
	pattern = "_" + pattern;
	// append 'followedby' number of X's 
	for (var r=0; r < $('followedby').value ; r++){
		pattern = pattern + "X" ;
	}
	// append a '.' if 'ormore' is checked
	if( $('ormore').checked ){
			pattern = pattern + "." ;
	}
	// assign this to the field 'pattern'
	$('pattern').value = pattern;
}

function localajaxinit(){
	$('message_text').innerHTML ="Saving Changes...";
	parent.astmanEngine.config2list("users.conf", $('trunks'), new Array(), trunkcallbacks);
}
</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Calling Rules</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="mailboxcontent">
		<select id="extensions" style="display:none"></select>
		<BR>
		<CENTER><font size="+1">List of Calling Rules </font><BR>
						in default dial plan - 'DialPlan1'
		</CENTER>
			<table class="table_blacksm" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
				<tr>	<td width=35>S.No</td>
						<td width=90>RuleName</td>
						<td>Dial Pattern</td>
						<td width=85 align=center>Call Using</td>
						<td width=75 align=center>Options</td>
				</tr>
			</table>
			<div id="callingRulesTable_div" style="height:250px;width=100%; overflow :auto; padding : 0px 0px 0px 0px;">
			<table id="callingRulesTable" cellpadding=2 cellspacing=1 border=0 align=center width=500></table>
			</div>
		</font>

		<center><div style="height:25px;color: #FF0000;" id='status'  class="field_text9"></div></center>
		<BR>
		<center><input type="button" id="addrule" value="Add a Calling Rule" onclick="add_callingrule();"></center>
		
		<div id="userscontent" STYLE="display:none; position: absolute; left: 20; top: 40; width:500; height:290;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid; z-index:5">
		<table width="100%" cellpadding=0 cellspacing=0  onmousedown="startDrag(event , 'userscontent');">
		<TR bgcolor="#7E5538" ><TD Height="20" align="right" style="cursor: move">
					<A href="#" onclick="$('cancel_a').click();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
				</TD>
				<TD width=4></TD>
		</TR>
		</table>

		<TABLE	align=center cellpadding=2 cellspacing=2 border=0 width="480">
		<TR>
			<TD align="right" width=175>Rule Name:</TD>
			<TD><input type="text" id="rulename" size="" onChange="enablesave();" onkeyup="enablesave();"></TD>
		</TR>
		<TR>
			<TD  align="right" height=40> Place this call through :</TD>
			<TD><select id="trunks"></select></TD>
		</TR>
		<TR id="define_usual" height=100>
			<TD valign="top" align=right>Dialing Rules :</TD>
			<TD valign="top"> If the number begins with <input id="beginswith" type='text' size=6 onChange="enablesave();" onkeyup="enablesave();"> and 
					followed by <input id="followedby" type='text' size=1> digits <input type="checkbox" id="ormore" onChange="enablesave();"> or more <BR>
					<A href="#" onclick="ownpattern();">(define a custom pattern)</A>
			</TD>
		</TR>
		
		<TR id="define_advanced"  height=100>
			<TD valign="top" align=right>
				Custom Pattern:
			</TD>
			<TD valign=top>
					<input type="text" id="pattern" size="" onChange="enablesave();" onkeyup="enablesave();"><BR>
					<table align='left' cellpadding=0 cellspacing=0>
						<tr><td class="field_text"><b>N&nbsp;&nbsp;</b></td><td class="field_text">Any digit from 2 to 9</td></tr>
						<tr><td class="field_text"><b>X&nbsp;&nbsp;</b></td><td class="field_text">Any digit from 0 to 9</td></tr>
						<tr><td class="field_text"><b>.&nbsp;&nbsp;</b></td><td class="field_text">Any number of additional digits</td></tr>
					</table>
			</TD>
		</TR>

		<TR>
			<TD colspan=2 align=center>Strip <input type="text" id="strip" size="1"  onChange="enablesave();" onkeyup="enablesave();"> digits from the front before dialing:</TD>
		</TR>
		<TR>
			<TD colspan=2 align=center height=50 valign=middle>  
					<input type="button" id="save_a" value="Save" onclick="saverule();">&nbsp;&nbsp;
					<input type="button" id="cancel_a" value="Cancel" onclick="$('userscontent').style.display='none'; $('bg_transparent').style.display ='none'; $('addrule').disabled =0;">
			</TD>
		</TR>
		</TABLE>

		</div>

</div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 24; width:100%; height:100%;  background-color:#FFFFFF; filter:alpha(opacity=50); -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #7E5538; border-style: solid; z-index:4">
</div>
<SCRIPT LANGUAGE="JavaScript">
<!--
showdiv_statusmessage();
//-->
</SCRIPT>
</body>
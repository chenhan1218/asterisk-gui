<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "MeetMe Extensions"
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var widgets = new Array;
var numplan_callbacks = new Object;
var trunkcallbacks = new Object;
var numberplansdata = new Object;
var current_context;
var fieldnames = new Array('name','comment','include','delete', 'status', 'new','save','cancel');



trunkcallbacks.format = function(t) {
	if (t.name.substr(0,6) != 'trunk_')
		return null;
	if (t.fieldbyname['trunkname'] && t.fieldbyname['trunkname'].length) {
		return t.fieldbyname['trunkname'];
	} else
		return t.name;
}

trunkcallbacks.loaded = function(){
	parent.astmanEngine.config2list("extensions.conf", $('extensions'), widgets, numplan_callbacks);
}


function next_freenp(){	 // return the next smallest available NumberPlan name
	x = 1;
	while(numberplansdata['numberplan-custom-' + x]) x++;
	return 'numberplan-custom-' + x;
}



numplan_callbacks.format = function(t, x) {
		var exten_fields;

		if ( t.name.substr(0,11) == 'numberplan-' && x==undefined ){	 				// if is a category
				current_context = t.name;
				numberplansdata[current_context] = new Object();
				return t.name ;
		}else if(t.name.substr(0,11) == 'numberplan-' ) {											// if is a subcategory 
				if(typeof numberplansdata[current_context].extensions == "undefined" ){
						numberplansdata[current_context].extensions = new Object();
				}
				if (t.names[x]=='comment'){
					numberplansdata[current_context].comment =  t.fields[x];
					return false;
				}
				if (t.names[x]=='include'){
					numberplansdata[current_context].include=  t.fields[x];
					return false;
				}
				if (t.names[x]=='exten'){
					exten_fields = t.fields[x].split (',');
					if(!numberplansdata[current_context].extensions[exten_fields[0]] ){
						numberplansdata[current_context].extensions[exten_fields[0]] = new Array();
					}
					numberplansdata[current_context].extensions[exten_fields[0]].push( t.fields[x] ) ;
				}
				return false;
		}else{	
			return false;
		}
}

numplan_callbacks.checkparams = function(box) {
	if(!$('comment').value.length){
		alert("Please enter a name for this Dial Plan");
		$('comment').focus();
		return true;
	}
}


numplan_callbacks.loaded = function(){
	if ($('new').addEventListener){
		$('new').addEventListener("click", showNPdetails, false); 
	} else if ($('new').attachEvent){
		$('new').attachEvent('onclick', showNPdetails );
	}
	loadNumberPlansintotable();
	parent.loadscreen(this);
}

numplan_callbacks.delchanges = function(box, value) {
	delete numberplansdata[value];
	 loadNumberPlansintotable();
}

numplan_callbacks.savechanges = function() {

	if(typeof numberplansdata[$('name').value] == "undefined" ){
			numberplansdata[$('name').value] = new Object();
	}
	numberplansdata[$('name').value].comment = $('comment').value; 
	numberplansdata[$('name').value].include= $('include').value;

	hideNPdetails();
	loadNumberPlansintotable();
}

numplan_callbacks.cancelnewcategory = function(){
	hideNPdetails();
}

numplan_callbacks.cancelchanges = function(){
	hideNPdetails();
}

//numplan_callbacks.identifier = "extension";
numplan_callbacks.eachline = true;
numplan_callbacks.includecats = true;


function localajaxinit(){
		$('message_text').innerHTML ="Saving Changes...";
		for (x =0 ; x< fieldnames.length; x++){
			widgets[fieldnames[x]] = $(fieldnames[x]);
			widgets[fieldnames[x]].disabled = true;
		}
	parent.astmanEngine.config2list("users.conf", $('trunks'), new Array(), trunkcallbacks);
}

















function loadNumberPlansintotable(){
		for( var i=0; i <  $('callingRulesTable').rows.length; ){
				 $('callingRulesTable').deleteRow(i);
		}

		if($('extensions').length == "0" ){
			$('table_one').style.display="none";
			var newRow = $('callingRulesTable').insertRow(-1);
			var newCell0 = newRow.insertCell(0);
			newCell0 .align = "center";
			newCell0 .innerHTML = "<BR>A <I>Calling Plan </I> is not defined<BR><BR> Please click on the 'Add New Calling Plan' button<BR> to add a Calling Plan<BR><BR>" ;
			return true;
		}
		$('extensions').selectitem(0);
		$('table_one').style.display="";
		for(i=0; i< $('extensions').length; i++){
			addrow_totable($('extensions').options[i].text);
		}
}


function addrow_totable(np_name){
		var sno = $('callingRulesTable').rows.length + 1;
		var newRow = $('callingRulesTable').insertRow(-1);
		newRow.id = "row" + np_name; 

		var newCell0 = newRow.insertCell(0);
		newCell0.innerHTML = sno ;
		newCell0.style.width = 40;

		var newCell1 = newRow.insertCell(1);
		newCell1.innerHTML =  numberplansdata[np_name].comment ; 
		newCell1.style.width = 200;

		var newCell2 = newRow.insertCell(2);
		newCell2.innerHTML = "<A href=\"#\" onclick=\"editNP('"+ np_name +"');\" class=\"field_text9\">Edit</A>&nbsp;&nbsp;&nbsp;&nbsp;<A href=\"#\" onclick=\"deleteNP('"+ np_name +"');\"  class=\"field_text9\">Delete</A>" ;
		newCell2.style.width = 120;
		newCell2.align = "center";

}


function editNP(np_name){
	current_context = np_name;
	for(var i=0; i< $('extensions').length; i++){
			if(np_name == $('extensions').options[i].text){
					$('extensions').selectitem(i);
					showNPdetails();
					break;
			}
	}
}

function deleteNP(np_name){
	current_context = np_name;
	for(var i=0; i< $('extensions').length; i++){
			if(np_name == $('extensions').options[i].text){
					$('extensions').selectitem(i);
					$('delete').disabled = 0;
					if( !$('delete').click() )
						return;
					break;
			}
	}

}

function showNPdetails(){
		$('cancel').disabled = false;
		$('userscontent').style.display = "block";

		if($('extensions').options[$('extensions').selectedIndex].text=="New Entry"){
			$('name').value = next_freenp();
			$('comment').value = "";
			$('include').value = "default";
			return true;
		}
		
		// If existing Entry then parse the exten fields to show the Rules
		for ( name in numberplansdata[current_context].extensions ){
				if (name!="extend"){
					alert(numberplansdata[current_context].extensions[name].length );
				}
		}



}

function hideNPdetails(){
		$('userscontent').style.display = "none";
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Calling Rules</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>

<div class="mainscreenContentBox" id="mailboxcontent">
		<select id="extensions"></select><select id="trunks"></select>
		<BR>
		<center>
			<font size="+1">List of Custom Plans</font>
			<table class="table_black" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
				<tr>	<td width=40>S.No</td>
						<td width="200">Plan Name</td>
						<td width="120" align="center">Options</td>
				</tr>
			</table>
			<table id="callingRulesTable" cellpadding=2 cellspacing=1 border=0 align=center width=500>
			</table>
			<div style="height:25px;color: #FF0000;" id='status'  class="field_text9"></div>
			<input type='button' id='new' value='Add New Calling Plan'>
		</center>
</div>

<div id="userscontent" STYLE="display:none; position: absolute; left: 20; top: 40; width:500; height:400;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid;">
	<table width="100%" cellpadding=0 cellspacing=0>
		<TR bgcolor="#7E5538" ><TD Height="20" align="right">
					<A href="#" onclick="$('cancel').click();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
				</TD>
				<TD width=4></TD>
		</TR>
	</table>

	<table align="center" cellpadding=1 cellspacing=2 border=0>
	<tr>	<td>Calling Plan Name:</td>
			<td><input id="comment" size=16><input id="name" style="display:none"></td>
	</tr>
	<tr>	<td>include:</td>
			<td><input id="include"  size=16></td>
	</tr>


	<tr>	<td><input type="button" id='delete' style="display:none"></td>
			<td>	<input type="button" id='save'  value="Save">	&nbsp;&nbsp;<input type="button" id='cancel' value="Cancel"></td>
	</tr>
	</table>
</div>
<SCRIPT LANGUAGE="JavaScript">
<!--
showdiv_statusmessage();
//-->
</SCRIPT>
</body>
<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Users" generally
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var widgets = new Array;
var fieldnames = new Array('bindaddr','bindport');
var widgets2  = new Array;
var fieldnames2 = new Array('httptimeout');
var current_username = parent.document.getElementById('login_name').value;
var httpconf_callbacks = new Object;
var managerconf_callbacks = new Object;
var default_bindaddress, default_port, default_httptimeout;


function cancel_guisettings(){
	$('bindaddr').value = default_bindaddress ; $('bindport').value =default_port ; $('httptimeout').value = default_httptimeout ;
	$('save').disabled=true;
	$('cancel').disabled=true;
}

function	update_guisettings_manager(){
		if($('bindaddr').value==""){
			alert("Please enter a Bind Address");
			$('bindaddr').focus();
			return true;
		}
		if($('bindport').value==""){
			alert("Please enter a Port number");
			$('bindport').focus();
			return true;
		}
		if($('httptimeout').value==""){
			alert("Please enter Http TimeOut in seconds");
			$('httptimeout').focus();
			return true
		}

		$('status_message').style.display="block";
		setTimeout("$('status_message').style.display='none'",3000);
	var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
				update_guisettings_http();
			},
			onFailure: function(t) {
				$('status_message').style.display='none';
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		opt.parameters ="action=updateconfig&reload=yes&srcfilename=manager.conf&dstfilename=manager.conf&Action-000000=update&Cat-000000=general&Var-000000=httptimeout&Value-000000="+ encodeURIComponent($('httptimeout').value);
		var tmp = new Ajax.Request("../../rawman", opt);
		return;
}


function update_guisettings_http(){
		var opt = {
				method: 'get',
				asynchronous: true,
				onSuccess: function() { 
							$('status_message').style.display='none';
							$('status').innerHTML = " <I> Configuration Saved ! </I>";
							$('save').disabled=true;
							$('cancel').disabled=true;
							if( default_bindaddress != $('bindaddr').value || default_port != $('bindport').value ){
								alert("Port/IP settings of the GUI have been updated !! \n\n You will now be redirected to the new IP/Port ");
								var previousurl =  parent.window.location.href.split("/");
								parent.window.location.href = location.protocol + "//" + $('bindaddr').value + ":" + $('bindport').value + "/asterisk/static/config/" + previousurl[previousurl.length-1] ;
							}
							default_port = $('bindport').value ;
				},
				onFailure: function(t) {
					alert("Config Error: " + t.status + ": " + t.statusText);
				}
		};
		opt.parameters ="action=updateconfig&reload=yes&srcfilename=http.conf&dstfilename=http.conf&Action-000000=update&Cat-000000=general&Var-000000=bindport&Value-000000="+ encodeURIComponent($('bindport').value) + "&Action-000001=update&Cat-000001=general&Var-000001=bindaddr&Value-000001=" + encodeURIComponent($('bindaddr').value );
		var tmp = new Ajax.Request("../../rawman", opt);
}


function showResponse(originalRequest)	{
		var v = originalRequest.responseText.split("Success");
		if( v.length > 1 ){
			alert("Password Updated!!  \n\n You will be now redirected to the login page \n You must relogin using your new password") ;
			window.location.href=window.location.href;
		}else{
			$('status').innerHTML= originalRequest.responseText ;
			return;
		}
}

function askforRelogin(){
			alert("Password Updated Successfully!!  \n\n You will now be redirected to the login page \n You must relogin using your new password") ;
			var opt2 = {
				method: 'get',
				asynchronous: true,
				onSuccess: function() {	 
						// reload the browser URL
						parent.window.location.href=parent.window.location.href;
				},
				onFailure: function(t) {
					alert("Config Error: " + t.status + ": " + t.statusText);
				}
			};
			opt2.parameters ="action=logoff";
			var tmp2 = new Ajax.Request("../../rawman", opt2);
}

function changepassword(){
	if( $('newpass').value!=$('newpass_rep').value ){
		alert( "Passwords do not match  !") ;
		$('newpass').focus();
		return true;
	}

	if( $('newpass').value.length < 4 ){
		alert( "Password should be at least 4 characters !") ;
		$('newpass').focus();
		return true;
	}

	var opt = {
			method: 'get',
			asynchronous: true,
			//onComplete: showResponse		// this is the better way to do it but http server is returning a 500 error
			onSuccess: function() { 
						askforRelogin();
			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		opt.parameters ="action=updateconfig&reload=yes&srcfilename=manager.conf&dstfilename=manager.conf&Action-000000=update&Cat-000000=" + current_username + "&Var-000000=secret&Value-000000="+ encodeURIComponent($('newpass').value );
		var tmp = new Ajax.Request("../../rawman", opt);
		return;
}


function compare_passwords(){
	if( $('newpass').value.length < 4 ){
		$('dopwdsmatch').style.color = "#EE0000";
		$('dopwdsmatch').innerHTML = "Password should be at least 4 characters !" ;
	}else if ( $('newpass').value==$('newpass_rep').value){
		$('dopwdsmatch').style.color = "#005D2E";
		$('dopwdsmatch').innerHTML = "Passwords Match !" ;
	}else{
		$('dopwdsmatch').style.color = "#EE0000";
		$('dopwdsmatch').innerHTML = "Passwords do not match  !" ;
	}
}

managerconf_callbacks.format = function(t) {
		var tmp = t.name.split('general');
		if(tmp.length>1)
			return t.name;
		else
			return false;
}

managerconf_callbacks.loaded = function() {
	$('hiddenfield2').selectitem(0);
	$('message_text').innerHTML = " Saving Changes ... ";
	default_bindaddress = $('bindaddr').value; default_port = $('bindport').value ; default_httptimeout = $('httptimeout').value;
	$('save').disabled=true;
	$('cancel').disabled=true;
	parent.loadscreen(this);
}

httpconf_callbacks.format = function(t) {
		var tmp = t.name.split('general');
		if(tmp.length>1)
			return t.name;
		else
			return false;
}

httpconf_callbacks.loaded = function() {
		$('hiddenfield').selectitem(0);

		for (var x =0; x < fieldnames2.length; x++) {
			widgets2[fieldnames2[x]] = $(fieldnames2[x]);
			widgets2[fieldnames2[x]].disabled = true;
		}
		parent.astmanEngine.config2list("manager.conf", $('hiddenfield2'), widgets2, managerconf_callbacks);
}


function tosetup(){
	parent.window.location.href = "./setup/install.html";
}

function localajaxinit(){
	for (var x =0; x < fieldnames.length; x++) {
		widgets[fieldnames[x]] = $(fieldnames[x]);
		widgets[fieldnames[x]].disabled = true;
	}

	// if not appliance - hide the gui_accesssettings DIV
	if ( !parent.window.location.href.match("cfgappliance.html") ){
		$('gui_accesssettings').style.display="none";
	}

	parent.astmanEngine.config2list("http.conf", $('hiddenfield'), widgets, httpconf_callbacks);
	return;
}
</script>
<body id="foo" onload="localajaxinit()" bgcolor="EFEFEF">
<div class="mainscreenTitleBar"><span style="margin-left: 4px;font-weight:bold">Admin Options</span></div>
<div class="mainscreenContentBox" id="userscontent">

<TABLE align=center width="520" cellpadding=0 cellspacing=0 style="margin: 5px 0 0 0;">
<TR>
	<TD valign="bottom" align="center"><a href="localexts.html" class="tab" style="border-bottom: 0px solid #777788; font-weight:bold; background: #DDDDEE; font-size: 11px">Local Extension settings</a></TD>
	<TD><a href="#" class="tab" style="border-bottom: 4px solid #000000; font-weight:bold; background: #FFFFFF; font-size: 13px">Change Password</a></TD>
	<TD valign="bottom" align="left"><a href="#" onclick="tosetup();" class="tab" style="border-bottom: 0px solid #777788; font-weight:bold; background: #DDDDEE; font-size: 11px">Run Setup Wizard</a></TD> 
</TR>
</TABLE>
<BR>
<table class="mainscreenTable" align="center">
	<tr valign="top" height="18">	
			<td align="center">
			</td>
	</tr>
	<tr>	<td align="center" valign="top">
					<div id="channellist" class="chanlist_small" style="width: 320px; height:100">
					<table cellpadding=2 cellspacing=2 border=0>
									<tr>	<td colspan=2 height=5></td></tr>
									<tr  onmouseover="show_tooltip('en', 'options', 1);"><td class="field_text">Enter New Password:</td><td><input type="password" id="newpass" size=16 onkeyup="compare_passwords()"  class="input8"></td></tr>
									<tr  onmouseover="show_tooltip('en', 'options', 2);"><td class="field_text">Retype New Password:</td><td><input type="password" id="newpass_rep" size=16 onkeyup="compare_passwords()"  class="input8"></td></tr>
									<tr>	<td colspan=2 align="center" height=20><div id="dopwdsmatch" style="font-size : 10px;"></div></td></tr>
									<tr>	<td align=center colspan=2><input type="button" id="pwdbutton" value="Update" onclick="changepassword()" class="buttonbold"></td></tr>
					</table>
					</div>
			</td>
	</tr>
	<tr valign="top" height="18">	<td></td></tr>
	<tr>	<td align="center" valign="top">
					<div id="gui_accesssettings" class="chanlist_small"  style="width: 320px; height:120">
					<table>	
					<TR><TD colspan=2 align=center><B>GUI - access settings: </B></TD></TR>
					<tr>	<td colspan=2 height=5></td></tr>
									<tr  onmouseover="show_tooltip('en', 'options', 3);">
											<td class="field_text">Bind Address:</td>		<td><input size=14 id='bindaddr' dfalt="127.0.0.1" onkeydown="$('save').disabled=false; $('cancel').disabled=false;"  class="input8"></td>
									</tr>
									<tr  onmouseover="show_tooltip('en', 'options', 4);"><td class="field_text">Port:</td>						<td><input size=14 id='bindport' dfalt=80  onkeydown="$('save').disabled=false; $('cancel').disabled=false;"  class="input8"></td></tr>
									<tr  onmouseover="show_tooltip('en', 'options', 5);"><td class="field_text">HTTP Timeout:</td>	<td><input size=14 id='httptimeout'  onkeydown="$('save').disabled=false; $('cancel').disabled=false;"  class="input8"></td></tr>
									<tr><td colspan=2 height=6> </td></tr>
									<tr><td colspan=2 align=center><input type=button id=save value="Save"  onclick="update_guisettings_manager()" class="buttonbold">&nbsp;<input type=button id=cancel value="Cancel" onclick="cancel_guisettings()" class="buttonbold"></td></tr>
					</table>
					<select  size="5" id="hiddenfield" style="display:none;"></select>
					<select  size="5" id="hiddenfield2" style="display:none; width:220px"></select>
					</div>
			</td>
	</tr>
	<tr><td valign="top" align=center><div  id='status'></div></td></tr>
	<tr><td></td></tr>
</table>
</div>
<SCRIPT LANGUAGE="JavaScript">
<!--
showdiv_statusmessage();
//-->
</SCRIPT>
</body>

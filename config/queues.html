<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Queue Extensions"
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->

<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
var adstatus;
var queuecallbacks = new Object;
var usercallbacks = new Object;
var extencallbacks = new Object;
var callbacks = new Object;
var widgets = new Array;
var queueagents = new  Array;
var queuenames = new Array;
var fieldnames = new Array( 'name', 'delete','save', 'status', 'new', 'cancel','fullname', 'strategy', 'timeout', 'wrapuptime','autofill','autopause','maxlen', 'joinempty',  'leavewhenempty', 'reportholdtime','agents');
var k =0;
var j = -1; 


// Queue Call Backs
queuecallbacks.format = function(t,x) {
		var tmp = t.name.split('general');
		if(tmp.length>1)
				return false;
		else if ( t.name && x==undefined ){	 				// if is a category
				k=0;
				j = j +1;
				queueagents[j] = new Array;
				queuenames[j] = t.name;
				return t.name + " -- Queue '" + t.fieldbyname['fullname'] + "'";
		}else {																// if is a subcategory 
				tmp = t.fields[x].split ('Agent/');
				if(t.names[x] == 'member' && tmp.length > 1){
					queueagents [j] [k] = tmp[1];
					k = k+1;
				}
				return false;
		}
}

queuecallbacks.postselect = function(box, val ) {
		if($('queues').selectedIndex	==-1){ 
			$('save_q').disabled=true; 
			return true; 
		} 

		// show all member entires listed under the queue member - $('queues').value
		for( k=0; k<queuenames.length; k++ ){
				if( queuenames[k] == $('queues').value ){
					j = k;
					break;
				}
		}
		for (k=0;k< $('agents').length ;k++ )
		{
			if( InArray( queueagents [j], $('agents').options[k].innerHTML.substr(0,4) ) )
				$('agents').options[k].selected = true;			
			else
				$('agents').options[k].selected = false;
		}
	$('save_q').disabled = false;
}

queuecallbacks.loaded = function() {
		parent.astmanEngine.config2list("users.conf", $('agents'), new Array(), usercallbacks);
}

queuecallbacks.newcategory = function(t) {
		var tmp = null;
		$('save_q').disabled=false;

		if ($('queues').stored_config.catbyname['general']){
			tmp = objcopy($('queues').stored_config.catbyname['general']);
		}
		tmp.name="";
return tmp;
}

queuecallbacks.checkparams = function(box) {

}

queuecallbacks.eachline = true;

queuecallbacks.includecats = true;

// User call backs
usercallbacks.format = function (t,x){
		if ((t.name == 'general'))
			return null;
		if ( t.fieldbyname['hasagent']=='yes' ) {
			return t.name + " -- " + t.fieldbyname['fullname'];
		} else
			return null;
}

usercallbacks.identifier = "extension";

usercallbacks.postselect = function (){
	
}

usercallbacks.loaded = function (){
	parent.astmanEngine.config2list("extensions.conf", $('extensions'), new Array(), extencallbacks);
}

//extencallbacks
extencallbacks.format = function(t, x) {
	var res;
	var qname;
	if ((t.name != specialcontext))
		return null;
	res = format_extension($('extensions'), t, x);
	if (t.subfields[x]['app'] == 'Queue') {
		return null;
	}
	return res;
}

extencallbacks.loaded = function() {
	parent.astmanEngine.config2list("users.conf", $('devices'), new Array(), callbacks);
}

extencallbacks.eachline = true;

// Call Backs
callbacks.format = function (t,x){
		if ((t.name == 'general'))
			return null;
		if (t.name.substring(0,6) == 'trunk_')
			return null;
		if (t.fieldbyname['fullname'] && t.fieldbyname['fullname'].length) {
			return t.name + " -- " + t.fieldbyname['fullname'];
		} else
			return t.name;
}

callbacks.identifier = "extension";

callbacks.postselect = function (){

}

callbacks.loaded = function (){
	merge_extensions($('queues'), $('extensions'));
	merge_extensions($('queues'), $('devices'));
	parent.loadscreen(this);
}

function save_status(){
	$('save_q').disabled = false;
	$('cancel').disabled = false;
}

function togglefeatures() {
	if (adstatus == "shown") {
		adstatus = "hidden";
		new Rico.Effect.Size('advancedw', null, 1, 120, 8, {complete:function() { $('advancedw').style.height=1;} } );
	} else {
		adstatus = "shown";
		$('advancedw').style.visibility = "visible";
		new Rico.Effect.Size('advancedw', null, 200, 120, 8 );
	}
}

function localajaxinit() {
	$('advancedw').style.overflow = "hidden";
	$('advancedw').style.height = 1;
	$('advancedw').style.width = $('split').width;
	$('advancedi').style.width = $('split').width - 60;

	for (var x in fieldnames) {
		widgets[fieldnames[x]] = $(fieldnames[x]);
		widgets[fieldnames[x]].disabled = true;
	}

	adstatus = "hidden";
	parent.astmanEngine.config2list("queues.conf", $('queues'), widgets, queuecallbacks);
	$('save_q').disabled = true;
	return;
}

function rename_extension(a,b){
	// rename extension 'a' in extensions.conf to 'b'
	// change 'exten => a,1,Queue' in default to 'exten => b,1,Queue'
	var opt0 = {
				method: 'get',
				asynchronous: true,
				onSuccess: function() { 
					return true;	
				},
				onFailure: function(t) {
					alert("Config Error: " + t.status + ": " + t.statusText);
					return false;
				},
	};
	uri0 = build_action('update', 0, specialcontext ,'exten', b+',1,Queue(${EXTEN})', a+',1,Queue(${EXTEN})' ); 
	opt0.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri0;
	tmp0 = new Ajax.Request('../../rawman', opt0);
}

function add_extension(a){
	// add extension 'a' in extensions.conf 
	// add 'exten => a,1,Queue' to default
	var opt0 = {
				method: 'get',
				asynchronous: true,
				onSuccess: function() { 
					return true;	
				},
				onFailure: function(t) {
					alert("Config Error: " + t.status + ": " + t.statusText);
					return false;
				},
	};
	uri0 = build_action('append', 0, specialcontext ,'exten', a+',1,Queue(${EXTEN})'); 
	opt0.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri0;
	tmp0 = new Ajax.Request('../../rawman', opt0);
}


function save_queue(){
		var p = 0;
		var fields = new Array('fullname', 'strategy', 'timeout', 'wrapuptime','autofill','autopause','maxlen', 'joinempty',  'leavewhenempty', 'reportholdtime');
		var otherfields_action, tmp;
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
					$('status').innerHTML = "<i>Updated.</i>";
					$('new').disabled = false;
					$('save_q').disabled = true;
					$('save').disabled = true;
					$('cancel').disabled = true;
					var cattmp = new Object;
					cattmp.catname = $('queues').value;

					for( k=0; k<queuenames.length; k++ ){
							if( queuenames[k] == $('queues').value ){
								j = k;
								break;
							}
					}
					// reset the array queueagents [j] to selected elements of $('agents')
					queueagents [j] = [];
					p =0;
					for (k=0;k< $('agents').length ;k++ ){
							if( $('agents').options[k].selected ){
								queueagents [j][p] = $('agents').options[k].innerHTML.substr(0,4);
								p = p+1;
							}
					}
					// also reset queuenames[j] to $('name').value
					queuenames[j] = $('name').value;
					$('queues').engine.fields2changes($('queues').widgets, $('queues').stored_config, cattmp);
					$('queues').options[$('queues').selectedIndex].innerHTML = $('name').value + " -- Queue '" + $('fullname').value +"'";
					$('queues').options[$('queues').selectedIndex].value =$('name').value;
					$('queues').options[$('queues').selectedIndex].core_name = cattmp.catname;

					for (var y = 0; y < $('queues').options.length + 1; y++) {
						if (!$('queues').options[y] || 
							do_compare($('queues'), $('queues').options[$('queues').selectedIndex], $('queues').options[y])) {
								$('queues').options.add($('queues').options[$('queues').selectedIndex], y);
								break;
						}
					}
			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			},
		};

		// before going any further check whether there is another entry with this name
		if( $('name').value != $('queues').value ){
					if ($('queues').stored_config.catbyname[$('name').value]) {
						alert("Sorry, an entry named " + $('name').value + " already exists!");
						return;
					}

					for(k=0; k<$('queues').length; k++ ){
						tmp = $('queues').options[k].innerHTML.split(' -- '); 
						if( tmp[0] ==  $('name').value   ){
							alert("Sorry, an entry named " + $('name').value + " already exists!");
							return;
						}
					}

		}
		if(!$('name').value.length){
				alert("Sorry, a Queue Name must be specified!");
				return;
		}

		p = 0;
		uri = "";
		if( $('queues').options[$('queues').selectedIndex].innerHTML=='New Entry' ){
				uri += build_action('newcat', p, $('name').value,"", ""); p = p+1;
				otherfields_action = 'append'; 			// add other fields
				add_extension( $('name').value ); // add in extensions.conf
		}else{
				if( $('name').value != $('queues').value ){
				// always do a rename cat instead of checking whether or not to do a rename cat
				uri += build_action('renamecat', p, $('queues').value ,"", $('name').value ); p = p+1;
					rename_extension($('queues').value,$('name').value ); // rename in extensions.conf
				}
				// delete existing agents
				uri += build_action('delete', p, $('name').value,"member", ""); p = p+1;
				otherfields_action = 'update'; 			// update other fields
		}

		for(k=0; k<fields.length; k++ ){
			if ( $(fields[k]).type =='checkbox'){
				tmp=( $(fields[k]).checked)? 'yes': 'no';
			}else{
				tmp = $(fields[k]).value;
			}
			uri += build_action(otherfields_action, p, $('name').value , fields[k] , tmp);
			p = p + 1;
		}

		//add agents
		for(k=0; k<$('agents').length; k++){
			if( $('agents').options[k].selected ){
			uri += build_action('append', p, $('name').value,"member", "Agent/"+$('agents').options[k].innerHTML.substr(0,4) );
			p = p+1;
			}
		}

		opt.parameters="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent("queues.conf") + "&dstfilename=" + encodeURIComponent("queues.conf") + uri;
		tmp = new Ajax.Request('../../rawman', opt);
}
</script>

<body id="foo" onload="localajaxinit()">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold">Queue Extension Configuration</span>
</div>
<div class="mainscreenContentBox" id="mailboxcontent">
<table class="mainscreenTable" align="center">
	<tr valign="top">
		<td colspan='2'>
		Call Queues:
		</td>
	</tr>
	<tr valign="top">
		<td>
		<select size="28" id="queues" style="width:220px">
		<option>Loading...</option>
		</select>
		<div style='visibility:hidden;overflow:hidden;width:0px;height:0px'><select id='extensions'></select><select id='devices'></select><select id='finalextensions'></select></div>
		</td>
		<td>
		<div id='adjustments'>
		<table cellspacing='0' cellpadding='0'>
			<tr valign="top"><td>
				<table>
				<tr><td>Queue:</td><td><input size='5' id='name'></td></tr>
				<tr><td>Full Name:</td><td><input size='24' id='fullname'></td></tr>
				<tr><td>strategy :</td><td><select id='strategy'> 
																<option value="ringall">ringall</option> 
																<option value="roundrobin">roundrobin</option> 
																<option value="leastrecent">leastrecent</option> 
																<option value="fewestcalls">fewestcalls</option> 
																<option value="random">random</option> 
																<option value="rrmemory">rrmemory</option> 
																</select>
						</td>
				</tr>
				<tr><td style='width:80px' valign='top'>Agents:</td><td><select size="6" multiple='true' id='agents' style='width:200px' onclick="save_status()"></select></td></tr>
				<tr><td colspan='2' align='center'><div style="height:15px" id='status'></div></td></tr>
				<tr><td colspan='2'></td></tr>
				</table>
			</td>
			</tr>
			<tr><td><img id="split" onClick="togglefeatures()" src="images/split-v.png"></td></tr>
			<tr><td>
						<div style="background-image:url(images/slice-v.png)" id='advancedw'>
									<table id='advancedi' align='center'>
									<tr><td>timeout:</td><td>&nbsp;<input size='2' id='timeout'></td></tr>
									<tr><td>wrapuptime:</td><td>&nbsp;<input size='2' id='wrapuptime'></td></tr>
									<tr><td>autofill:</td><td><input type=checkbox id='autofill'></td></tr>
									<tr><td>autopause:</td><td><input type=checkbox id='autopause'></td></tr>
									<tr><td>maxlen:</td><td>&nbsp;<input size='2' id='maxlen'></td></tr>
									<tr><td>joinempty:</td><td><input type=checkbox id='joinempty'></td></tr>
									<tr><td>leavewhenempty:</td><td><input type=checkbox id='leavewhenempty'></td></tr>
									<tr><td>reportholdtime:</td><td><input type=checkbox id='reportholdtime'></td></tr>
									</table>
						</div>
			</td></tr>
			<tr><td>
				<img onClick="togglefeatures()" src="images/adv-v.png">
			</td>
			</tr>
		</table>
		</div>
		</td>

	</tr><tr>
		<td align='center'>
			<table>
			<tr align='center'><td>
			<input style='width:80' type='button' id='new' value='New'>
			</td><td>
			<input style='width:80' type='button' id='delete' value='Delete'>
			</td></tr>
			</table>
		</td>
		<td align='center' colspan='2'>
				<input type=hidden id='save' value="Save">
				<input style='width:80' type='button' id='save_q' onclick="save_queue()" value='Save'>
				&nbsp;
				<input style='width:80' type='button' id='cancel' value='Cancel'>
				&nbsp;
		</td>				
	</tr>
</table>
</div>
</body>
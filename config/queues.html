<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Queue Extensions"
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->

<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/extensions.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
	var origwidth;
	var widgets = new Array;
	var adstatus;
	var queues;
	var callbacks = new Object;
	var usercallbacks = new Object;
	var fieldnames = new Array(
				'name', 'delete', 'status', 'newitem', 
				'music','menu', 'announce',
				'room','record','waitmarked','setmarked','quiet',
				'pin', 'pinadmin', 'save', 'cancel');

	function changed_extension() {
		var app;
		tmp = $('extensions').value.split(']');
		app = findapp($('extensions').stored_config.catbyname[tmp[0]].subfields[tmp[1]]['app']);
		$('name').value = $('extensions').stored_config.catbyname[tmp[0]].subfields[tmp[1]]['name'];
		$('features').value = app.name.toLowerCase();
	};

	callbacks.fields2val = function(box, subfields) {
		var flags = "d";
		var xargs="";
		var room = '${EXTEN}';
		if (subfields['music'] != 'no')
			flags += "M";
		if (subfields['menu'] != 'no')
			flags += 's';
		if (subfields['announce'] != 'no')
			flags += 'I';
		if (subfields['record'] != 'no')
			flags += 'r';
		if (subfields['waitmarked'] != 'no')
			flags += 'w';
		if (subfields['setmarked'] != 'no')
			flags += 'A';
		if (subfields['quiet'] != 'no')
			flags += 'q';
		if (subfields['room'].length > 0)
			room = subfields['room'];
		return $('name').value + ",1,Queue(" + room + "," + flags + "," + subfields['pin'] + "," + subfields['pinadmin'] + ")";
	}

	callbacks.format = function(t, x) {
		var ret;
		var tmp;
		var options = new Array;
		var tmp2, y;
		if ((t.name != specialcontext))
			return null;
		ret = format_extension($('extensions'), t, x);
		if (ret) {
			tmp = t.subfields[x].args.split(',');
			if (tmp[1]) {
				tmp2 = tmp[1].split('');
				for (y=0;y<tmp2.length;y++)
					options[tmp2[y]] = 'yes';
			}
			if (tmp[2])
				t.subfields[x].pin = tmp[2];
			else
				t.subfields[x].pin = '';
			if (tmp[3])
				t.subfields[x].pinadmin = tmp[3];
			else
				t.subfields[x].pinadmin = '';
			if (tmp[0] == '${EXTEN}')
				t.subfields[x].room = '';
			else
				t.subfields[x].room = tmp[0];
			t.subfields[x].music = options['M'];
			t.subfields[x].menu = options['s'];
			t.subfields[x].announce = options['I'];
			t.subfields[x].record = options['r'];
			t.subfields[x].waitmarked = options['w'];
			t.subfields[x].setmarked = options['A'];
			t.subfields[x].quiet = options['q'];
		}
		return ret;
	}
	
	callbacks.loaded = function() {
		merge_users($('extensions'), $('hiddenusers'));
		for (x=0;x<$('extensions').options.length;x++) {
			var tmp;
			tmp = $('extensions').options[x].value.split(']');
			if (tmp.length > 1) {
				if ($('extensions').stored_config.catbyname[tmp[0]].subfields[tmp[1]]['app'].toLowerCase() != "queue") {
					$('extensions').options[x].disabled = true;
				}
			}
		}
		$('extensions').contentEditable = 'true';
		$('extensions').disabled = 0;
		parent.loadscreen(this);
	}
	callbacks.sortfunc = function(a,b) {
		return (a.name < b.name) ? -1 : 1;
	}
	callbacks.newsubitem = function() {
		var tmp = new Object;
		var x;
		var gen;
		gen = $('hiddenusers').stored_config.catbyname['general'];
		if (gen)
			x = gen.fieldbyname['userbase'];
		if (x)
			tmp['name'] = first_free_exten($('extensions'), x);
		tmp['pin'] = '';
		tmp['pinadmin'] = '';
		tmp['music'] = 'yes';
		tmp['menu'] = 'no';
		tmp['announce'] = 'yes';
		tmp['room'] = '';
		tmp['>'] = true;
		return new Array(specialcontext, 'exten', tmp);
	}
	callbacks.newcategory = function() {
		var tmp = null;
		var x;
		if ($('extensions').stored_config.catbyname['general'])
			tmp = objcopy($('extensions').stored_config.catbyname['general']);
		if (tmp) {
			x = tmp.fieldbyname['userbase'];
			if (x) {
				while($('extensions').stored_config.catbyname[x]) x++;
				tmp.name = x;
			}
		}
		return tmp;
	}
	callbacks.identifier = "extension";
	callbacks.eachline = true;
	
	usercallbacks.format = function(t) {
		if ((t.name == 'general'))
			return null;
		if (t.name.substring(0,6) == 'trunk_')
			return null;
		if (t.fieldbyname['fullname'] && t.fieldbyname['fullname'].length) {
			return t.name + " -- " + t.fieldbyname['fullname'];
		} else
			return t.name;
	}
	usercallbacks.loaded = function() {
		parent.astmanEngine.config2list("extensions.conf", $('extensions'), widgets, callbacks);
	}

	function togglefeatures() {
		if (adstatus == "shown") {
			adstatus = "hidden";
			new Rico.Effect.Size('advancedw', null, 1, 120, 8, {complete:function() { $('advancedw').style.height=1;} } );
		} else {
			adstatus = "shown";
			$('advancedw').style.visibility = "visible";
			new Rico.Effect.Size('advancedw', null, 240, 120, 8 );
		}
	}
	function localajaxinit() {
		$('advancedw').style.overflow = "hidden";
		$('advancedw').style.height = 1;
		$('advancedw').style.width = $('split').width;
		$('advancedi').style.width = $('split').width - 60;
		adstatus = "hidden";
		$('extensions').contentEditable = 'false';
		for (var x in fieldnames) {
			widgets[fieldnames[x]] = $(fieldnames[x]);
			widgets[fieldnames[x]].disabled = true;
		}
		parent.astmanEngine.config2list("users.conf", $('hiddenusers'), new Array(), usercallbacks);
	}
</script>


<body id="foo" onload="localajaxinit()">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold">Queue Extension Configuration</span>
</div>
<div class="mainscreenContentBox" id="mailboxcontent">
<table class="mainscreenTable" align="center">
	<tr valign="top">
		<td colspan='2'>
		Extensions:
		</td>
	</tr>
	<tr valign="top">
		<td>
		<select disabled size="28" id="extensions" style="width:220px">
		<option>Loading...</option>
		</select>
		</td>
		<td>
		<div id='adjustments'>
		<table cellspacing='0' cellpadding='0'>
			<tr valign="top"><td>
				<table>
				<tr><td>Extension:</td><td><input size='5' id='name'  onkeypress="return OnlyNumbers(event)"></td></tr>
				<tr><td>PIN Code:</td><td><input size='5' id='pin'  onkeypress="return OnlyNumbers(event)"></select></td></tr>
				<tr><td>Administrator PIN Code:</td><td><input size='5' id='pinadmin'  onkeypress="return OnlyNumbers(event)"></select></td></tr>
				<tr><td>Play hold music for first caller</td><td><input type='checkbox' id='music'></select></td></tr>
				<tr><td>Enable caller menu</td><td><input type='checkbox' id='menu'></select></td></tr>
				<tr><td>Announce callers</td><td><input type='checkbox' id='announce'></select></td></tr>
				<tr><td colspan='2' align='center'><div style="height:15px" id='status'></div></td></tr>
				<tr><td colspan='2'></td></tr>
				</table>
			</td>
			</tr>
			<tr><td><img id="split" onClick="togglefeatures()" src="images/split-v.png"></td></tr>
			<tr><td>
				<div style="background-image:url(images/slice-v.png)" id='advancedw'>
				<table id='advancedi' align='center'><tr><td>
				<tr><td>Room Override:</td><td><input size='5' id='room'  onkeypress="return OnlyNumbers(event)"></td></tr>
				<tr><td>Record conference</td><td><input type='checkbox' id='record'></select></td></tr>
				<tr><td>Quiet Mode</td><td><input type='checkbox' id='quiet'></select></td></tr>
				<tr><td>Wait for marked user</td><td><input type='checkbox' id='waitmarked'></select></td></tr>
				<tr><td>Set marked user</td><td><input type='checkbox' id='setmarked'></select></td></tr>
				</td></tr></table>
				</div>
			</td></tr>
			<tr><td>
				<img onClick="togglefeatures()" src="images/adv-v.png">
			</td>
			</tr>
		</table>
		</div>
		</td>

	</tr><tr>
		<td align='center'>
			<table>
			<tr align='center'><td>
			<input style='width:80' type='button' id='newitem' value='New'>
			</td><td>
			<input style='width:80' type='button' id='delete' value='Delete'>
			</td></tr>
			</table>
		</td>
		<td align='center' colspan='2'>
				<input style='width:80' type='button' id='save' value='Save'>
				&nbsp;
				<input style='width:80' type='button' id='cancel' value='Cancel'>
				&nbsp;
		<div style='visibility:hidden;overflow:hidden;width:0px;height:0px'>
			<select id='hiddenusers'>
			</select>
		</div>
		</td>				
	</tr>
</table>
</div>
</body>

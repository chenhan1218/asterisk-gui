<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Records a voicemenu from a user selected device
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
var callbacks = new Object;
var rfilescallbacks = new Object;
var custom_voicemenusfile = "gui_custommenus.conf";
var focus_fields = new Array('newvmenu_name','newvmenu_ext');

function play_existing(filename){
	var extension = prompt("Please enter an Extension on which you want to listen to the file",""); 
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 
			_$('status').innerHTML = " <I> Play Request Successfull ! </I>";
		},
		onFailure: function(t) {
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters ="action=originate&channel=Local/"+extension + "&context="+asterisk_guitools+"&exten=play_file&priority=1&Variable=var1%3d"+ encodeURIComponent( filename );
	var tmp = new Ajax.Request("../../rawman", opt);
}

function delete_sounds(filename){
	if ( confirm("Delete recorded file "+ filename +" ?") ){
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { 
				_$('status').innerHTML = " <I> Delete Request Successfull ! </I>";
				// remove file name from stored config file
				var opt2 = {
					method: 'get',
					asynchronous: true,
					onSuccess: function() { 
						// Remove this TR
						var delete_id = "delete_" + filename;
						var tableRow = _$(delete_id).parentNode.parentNode; //gets TR object
						 var _trf = _$('table_recordefileslist');
						for( var i=0; i <  _trf. rows.length; i++){
							if  ( _trf. rows[i].id == tableRow.id){
								_trf.deleteRow(i);
								break;
							}
						}
						_$('maintable').style.display = ( _trf. rows.length == 0) ? 'none' : '' ;
						_$('no_rvmns').style.display = ( _trf. rows.length == 0) ? '': 'none' ;
					},
					onFailure: function(t) {
						_$('status_message').style.display='none';
						gui_alert("Config Error: " + t.status + ": " + t.statusText);
					}
				};	
				var uri = build_action('delcat', 0, filename,"", ""); 
				opt2.parameters = "action=updateconfig&srcfilename=" + encodeURIComponent(custom_voicemenusfile) + "&dstfilename=" + encodeURIComponent(custom_voicemenusfile) + uri;
				var tmp2 = new Ajax.Request('../../rawman', opt2);
			},
			onFailure: function(t) {
				gui_alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		opt.parameters="action=originate&channel=" + encodeURIComponent("Local/removefile@"+asterisk_guitools) + "&Variable=var1%3d"+ encodeURIComponent("/var/lib/asterisk/sounds/" + filename )+"&application=noop&timeout=60000";
		var tmp = new Ajax.Request("../../rawman", opt);
	}
	else{
		//
	}
}


function save_recordedvmenuname( filename_torecord ){
	// open custom_voicemenusfile
	var opt2 = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) {	 
			addrow_totable(filename_torecord);
			var _trf = _$('table_recordefileslist'); 
			$('maintable').style.display = ( _trf.rows.length == 0) ? 'none' : '';
			$('no_rvmns').style.display = ( _trf.rows.length == 0) ? '':'none';
		},
		onFailure: function(t) {
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};

	var uri = build_action('newcat', 0, filename_torecord ,"", ""); 
	opt2.parameters ="action=updateconfig&srcfilename=" + encodeURIComponent(custom_voicemenusfile) + "&dstfilename=" + encodeURIComponent(custom_voicemenusfile) + uri;
	var tmp2 = new Ajax.Request("../../rawman", opt2);
}

function originate_recordrequest(should_save, newvmenu_ext, filename_torecord){
	_$('status_message').style.display="";
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 
			setTimeout( function(){ $('status_message').style.display='none'; },sc_displaytime);
			if ( t.responseText.indexOf("Originate successfully queued") == -1 ){
					// Request Failed
			}else{
				// save the filename in a seperate file so that we can display the list of "Recorded file"
				if(should_save =="YES"){
					_$('status').innerHTML = " <I> Configuration Saved ! </I>";
					_$("newvmenu_name").value="";
					_$("format").selectedIndex =0;
					_$("newvmenu_ext").selectedIndex= -1;
					save_recordedvmenuname( filename_torecord);
				}
			}				
		},
		onFailure: function(t) {
			_$('status_message').style.display='none';
			gui_alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters ="action=originate&channel=Local/"+newvmenu_ext + "&context="+asterisk_guitools+"&exten=record_vmenu&priority=1&Variable=var1%3d"+ encodeURIComponent( filename_torecord );

	var tmp = new Ajax.Request("../../rawman", opt);
}

function record_new(){
	var _nm_n = _$('newvmenu_name');
	var _nm_e = _$('newvmenu_ext');
 
	if( _nm_n.value == "" ){ 
		gui_alert("Please Enter a name for the new Voice Menu");
		_nm_n.focus();
		return true;
	}
	if ( _nm_e.value == ""){
		gui_alert("Please Select an extension to record the VoiceMenu");
		_nm_e.focus();
		return true;
	}

	var filename_torecord = _nm_n.value + "." + _$('format').value;
	originate_recordrequest("YES", _nm_e.value, filename_torecord);
	hide_record();
}

function record_existing(filename){
	if(!confirm("Are you sure you want to Record over an existing Voicemenu?")){ return true; }
	var extension = prompt("Please enter an Extension to call ","");
	if(!extension){ return false; }
	originate_recordrequest("NO", extension, filename);
}

function addrow_totable(filename){
	var newRow = _$('table_recordefileslist').insertRow(-1);
	newRow.id = "row" + filename; 

	var newCell1 = newRow.insertCell(0);
	newCell1 .innerHTML = filename ;

	var newCell2 = newRow.insertCell(1);
	newCell2 .innerHTML = "<input "+ "type=\"button\"" + " id=\"recordover_" + filename +"\""+ " value='Record Again'"+  " onclick='record_existing(\"" + filename + "\")'>" 
	+ "&nbsp;"+ "<input type=button id=\"play_"+filename+"\""+ " value='Play'" + " onclick='play_existing(\"" + filename.substr(0,(filename.length - 4) )+ "\")'>" 
	+ "&nbsp;"+ "<input type=\"button\" id='delete_" + filename + "' onclick='delete_sounds(\""+ filename + "\")'  value=\"Delete\">" ;
}

callbacks.format = function(t) {
	if ((t.name == 'general'))
		return null;

	if ( t.fieldbyname['context'] == asterisk_guiTDPrefix + t.name ) {
		return null;
	}
	if (t.fieldbyname['fullname'] && t.fieldbyname['fullname'].length) {
		return t.name + " -- " + t.fieldbyname['fullname'];
	} else
	return t.name;
}

callbacks.loaded = function(){
	parent.loadscreen(this);
}

rfilescallbacks.format = function(t) {
	return t.name;
}

rfilescallbacks.loaded= function() {
	var _rf = _$('recorded_files');
	for (var i=0; i < _rf.length; i++){
		addrow_totable( _rf.options[i].value);
	}
	_$('maintable').style.display = ( _rf.length == 0) ? 'none' : '';
	_$('no_rvmns').style.display = ( _rf.length == 0) ? '' : 'none' ;
}

function show_record(){
	_$('bg_transparent').style.display = "";
	_$('recordnew_content').style.display = "";
	_$('newvmenu_name').focus();
}

function hide_record(){
	_$('bg_transparent').style.display = "none";
	_$('recordnew_content').style.display = "none";
}

function localajaxinit() {
	showdiv_statusmessage();
	setWindowTitle("Record a Menu");
	for (var x =0; x < focus_fields.length; x++ ) {
		_$(focus_fields[x]).onfocus = function(){this.className = 'input8_hilight';}
		_$(focus_fields[x]).onblur = function(){this.className = 'input8';}
	}

	var opt = { method: 'get', asynchronous: true, onComplete: check_filexists };
	opt.parameters="action=getconfig&filename="+ custom_voicemenusfile ;
	var tmp = new Ajax.Request("../../rawman", opt);
}

function check_filexists(originalRequest){
	if( originalRequest.responseText.indexOf("Config file not found") != -1 ){
		parent.astmanEngine.run_tool("/bin/touch /etc/asterisk/"+custom_voicemenusfile ,	function(){	 load_page();  } );
		return;
	}
	load_page();
}

function load_page(){
	parent.astmanEngine.config2list(custom_voicemenusfile, _$('recorded_files'), new Array, rfilescallbacks);
	parent.astmanEngine.config2list("users.conf", _$('newvmenu_ext'), new Array, callbacks);
	_$('message_text').innerHTML = "Please wait while the system <BR> Calls the specified Extension ... ";
}

function free_mem(){
	if( navigator.userAgent.indexOf("MSIE") == -1 ){ return true; }
	try{
		purge( document.body );
	} catch(e){ }
}
</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF"  onunload="free_mem()">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Record a Custom VoiceMenu</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr><td valign="top" align="center">
			<BR>
			<table id="maintable" cellpadding=3 cellspacing=0 border=0 width=400 style="border-width: 1px 1px 1px 1px; border-style: solid; border-color: #7E7E7E; ">
				<tr><td colspan=2 align=center class="field_text"><B>List of recorded voicemenus</B><select id='recorded_files' style="display:none"></select></td></tr>
				<tr bgcolor="#FFFFFF"><td><font color="#2D4E93" width="300">File Name</font></td><td  color="#2D4E93" ></td></tr>
				<tr><td colspan=2>
						<div style="height:125px;width=400px; overflow :auto;">
						<table id="table_recordefileslist"  cellpadding=3 cellspacing=0 border=0 width="100%"  class="field_text"></table>
						</div>
						</td>
				</tr>
			</table>

			<table width="500" cellspacing="1" cellpadding="2" border="0" align="center" id="no_rvmns" style="display: none"  bgcolor="#C2C2C2">
				<tr>
				<td align="center" bgcolor="#FFFFFF">
				<br/>You do not have any <i>Recorded Voicemenus</i> <br/><br/>
				Please click on the 'Record a new Voice Menu' button<br/> 
				to record a new Voicemenu.<br/><br/>
				</td>
				</tr>
			</table>
			<BR><BR>
			<div id="status"></div>
			<BR><BR>
			<input type="button" id="vvv" value="Record a new Voice Menu" onclick="show_record();"  onmouseover="show_tooltip('en', 'record', 0);">

		<div id="recordnew_content" STYLE="display:none; position: absolute; left: 20; top: 125; width:475; height:150;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid;z-index:5">
			<table width="100%" cellpadding=0 cellspacing=0 onmousedown="startDrag(event , 'recordnew_content');">
			<TR bgcolor="#7E5538"  style="background-image:url('images/title_gradient.gif');">
					<TD Height="20" align="center" style="cursor: move">
					<font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">Record a new Voicemenu</font>
					</TD>
				   <TD Height="20" align="right" style="cursor: move">
						<A href="#" onclick="hide_record();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
					</TD>
					<TD width=4></TD>
			</TR>
			</table>
			<table cellpadding=2 cellspacing=2 border=0>
				<tr>	<td colspan=2 height=15 valign=middle align=center class="field_text"></td></tr>
				<tr   onmouseover="show_tooltip('en', 'record', 1);"><td class="field_text">File Name:</td>
						<td><input id='newvmenu_name' size=24 class="input9">
								<input type="hidden" id="format" value="gsm">
						</td>
				</tr>
<!-- 				<tr><td>Format:</td>
						<td><select id='format'>
										<option value="gsm">gsm</option>
-										<option value="g723">g723</option>
										<option value="g729">g729</option>
										<option value="h623">h623</option>
										<option value="ulaw">ulaw</option>
										<option value="alaw">alaw</option>
										<option value="vox">vox</option>
										<option value="wav">wav</option>
										<option value="WAV">WAV</option> 
								</select>
						</td>
				</tr> -->
				<tr   onmouseover="show_tooltip('en', 'record', 2);">	<td class="field_text">Extension used for recording:</td>
						<td><select id='newvmenu_ext' class="input9"></select></td>
				</tr>
				<tr>	<td colspan=2 align=center height=10></td></tr>
				<tr>	<td colspan=2 align=center>
						<input type="button" id='record' Value="Record" onclick="record_new()" class="buttonbold">&nbsp;&nbsp;&nbsp;
						<input type="button" Value="Cancel" onclick="hide_record();" class="buttonbold"></td></tr>
				<tr>	<td colspan=2 align=center height=10></td></tr>
			</table>
		</div>
	</td>
	</tr>
</table>
</div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 24; width:100%; height:100%;  background-color:#EFEFEF; -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #EFEFEF; border-style: solid; z-index:4">
</div>
</body>

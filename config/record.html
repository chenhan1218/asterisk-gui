<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Users" generally
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->

<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
var callbacks = new Object;
var rfilescallbacks = new Object;
var custom_voicemenusfile = "gui_custommenus.conf";
var focus_fields = new Array('newvmenu_name','newvmenu_ext');

function play_existing(filename){
	var extension = prompt("Please enter an Extension on which you want to listen to the file",""); 
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { 
							$('status').innerHTML = " <I> Play Request Successfull ! </I>";
			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		opt.parameters ="action=originate&channel=Local/"+extension + "&context="+asterisk_guitools+"&exten=play_file&priority=1&Variable=var1%3d"+ encodeURIComponent( filename );
		var tmp = new Ajax.Request("../../rawman", opt);
}

function delete_sounds(filename){
	var ans = confirm("Delete recorded file "+ filename +" ?");
	if (ans){
			var opt = {
				method: 'get',
				asynchronous: true,
				onSuccess: function(t) { 
						$('status').innerHTML = " <I> Delete Request Successfull ! </I>";
						// remove file name from stored config file
						var opt2 = {
							method: 'get',
							asynchronous: true,
							onSuccess: function() { 
								// Remove this TR
								var delete_id = "delete_" + filename;
								var tableRow = $(delete_id).parentNode.parentNode; //gets TR object
								for( var i=0; i <  $('table_recordefileslist'). rows.length; i++){
									if  ( $('table_recordefileslist'). rows[i].id == tableRow.id){
										 $('table_recordefileslist').deleteRow(i);
										 break;
									}
								}
								if( $('table_recordefileslist'). rows.length == 0){
										$('maintable').style.display = 'none';
										$('no_rvmns').style.display = '';
								}else{
										$('no_rvmns').style.display = 'none';
										$('maintable').style.display = '';
								}
							},
							onFailure: function(t) {
								$('status_message').style.display='none';
								alert("Config Error: " + t.status + ": " + t.statusText);
							}
						};	
						var uri = build_action('delcat', 0, filename,"", ""); 
						opt2.parameters = "action=updateconfig&srcfilename=" + encodeURIComponent(custom_voicemenusfile) + "&dstfilename=" + encodeURIComponent(custom_voicemenusfile) + uri;
						var tmp2 = new Ajax.Request('../../rawman', opt2);
				},
				onFailure: function(t) {
					alert("Config Error: " + t.status + ": " + t.statusText);
				}
			};
			opt.parameters="action=originate&channel=" + encodeURIComponent("Local/removefile@"+asterisk_guitools) + "&Variable=var1%3d"+ encodeURIComponent("/var/lib/asterisk/sounds/" + filename )+"&application=noop&timeout=60000";
			var tmp = new Ajax.Request("../../rawman", opt);
	}
	else{
		//
	}
}


function save_recordedvmenuname( filename_torecord ){
	// open custom_voicemenusfile
		var opt2 = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) {	 
					 addrow_totable(filename_torecord);
					// var newoption = document.createElement("option"); // realised that we'r not using this select field any where .. so no point in updating this field.
					// newoption.text = filename_torecord ;
					// newoption.value = filename_torecord ;
					// $('recorded_files').options.add ( newoption );
					if( $('table_recordefileslist'). rows.length == 0){
							$('maintable').style.display = 'none';
							$('no_rvmns').style.display = '';
					}else{
							$('no_rvmns').style.display = 'none';
							$('maintable').style.display = '';
					}
			},
			onFailure: function(t) {
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
					
		var uri = build_action('newcat', 0, filename_torecord ,"", ""); 
		opt2.parameters ="action=updateconfig&reload=yes&srcfilename=" + encodeURIComponent(custom_voicemenusfile) + "&dstfilename=" + encodeURIComponent(custom_voicemenusfile) + uri;
		var tmp2 = new Ajax.Request("../../rawman", opt2);
}


function originate_recordrequest(should_save, newvmenu_ext, filename_torecord){
		$('status_message').style.display="block";
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { 
					setTimeout("$('status_message').style.display='none'",sc_displaytime);
					if ( t.responseText.indexOf("Originate successfully queued") == -1 ){
							// Request Failed
					}else{
						// save the filename in a seperate file so that we can display the list of "Recorded file"
						if(should_save =="YES"){
							$('status').innerHTML = " <I> Configuration Saved ! </I>";
							$("newvmenu_name").value="";
							$("format").selectedIndex =0;
							$("newvmenu_ext").selectedIndex= -1;
							save_recordedvmenuname( filename_torecord);
						}
					}				
			},
			onFailure: function(t) {
				$('status_message').style.display='none';
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};
		opt.parameters ="action=originate&channel=Local/"+newvmenu_ext + "&context="+asterisk_guitools+"&exten=record_vmenu&priority=1&Variable=var1%3d"+ encodeURIComponent( filename_torecord );

		var tmp = new Ajax.Request("../../rawman", opt);
}

function record_new(){
	if($('newvmenu_name').value == "" ){ 
			alert("Please Enter a name for the new Voice Menu");
			$('newvmenu_name').focus();
			return true;
	}else if ( $('newvmenu_ext').value == ""){
			alert("Please Select an extension to record the VoiceMenu");
			$('newvmenu_ext').focus();
			return true;
	}

	var filename_torecord = $('newvmenu_name').value + "." + $('format').value;
	originate_recordrequest("YES", $('newvmenu_ext').value, filename_torecord);
	hide_record();
}

function record_existing(filename){
	t=confirm("Are you sure you want to Record over an existing Voicemenu?")
	if(t == false)
		return true;
	var extension = prompt("Please enter an Extension to call ",""); 
	if(!extension){
		return false;
	}
	originate_recordrequest("NO", extension, filename);
}

function addrow_totable(filename){
		var newRow = $('table_recordefileslist').insertRow(-1);
		newRow.id = "row" + filename; 

		var newCell1 = newRow.insertCell(0);
		newCell1 .innerHTML = filename ;

		var newCell2 = newRow.insertCell(1);
		newCell2 .innerHTML = "<input "+ "type=\"button\"" + " id=\"recordover_" + filename +"\""+ " value='Record Again'"+  " onclick='record_existing(\"" + filename + "\")'>" 
		+ "&nbsp;"+ "<input type=button id=\"play_"+filename+"\""+ " value='Play'" + " onclick='play_existing(\"" + filename.substr(0,(filename.length - 4) )+ "\")'>" 
		+ "&nbsp;"+ "<input type=\"button\" id='delete_" + filename + "' onclick='delete_sounds(\""+ filename + "\")'  value=\"Delete\">" ;
}

callbacks.format = function(t) {
	if ((t.name == 'general'))
		return null;
	//if (t.name.substring(0,6) == 'trunk_')
	//	return null;
	if ( t.fieldbyname['context'] == asterisk_guiTDPrefix + t.name ) {
			return null;
	}
	if (t.fieldbyname['fullname'] && t.fieldbyname['fullname'].length) {
		return t.name + " -- " + t.fieldbyname['fullname'];
	} else
		return t.name;
}

callbacks.loaded = function(){
	parent.loadscreen(this);
}

rfilescallbacks.format = function(t) {
		return t.name;
}

rfilescallbacks.loaded= function() {
	for (var i=0; i < $('recorded_files').length; i++){
		addrow_totable($('recorded_files').options[i].value);
	}
	if($('recorded_files').length == 0){
		$('maintable').style.display = 'none';
		$('no_rvmns').style.display = '';
	}else{
		$('no_rvmns').style.display = 'none';
		$('maintable').style.display = '';
	}
}

function show_record(){
	$('bg_transparent').style.display = "";
	$('recordnew_content').style.display = "";
	$('newvmenu_name').focus();
}

function hide_record(){
	$('bg_transparent').style.display = "none";
	$('recordnew_content').style.display = "none";
}

function localajaxinit() {
	for (var x =0; x < focus_fields.length; x++ ) {
		$(focus_fields[x]).onfocus = function(){this.className = 'input8_hilight';}
		$(focus_fields[x]).onblur = function(){this.className = 'input8';}
	}
	parent.astmanEngine.config2list(custom_voicemenusfile, $('recorded_files'), new Array, rfilescallbacks);
	parent.astmanEngine.config2list("users.conf", $('newvmenu_ext'), new Array, callbacks);
	$('message_text').innerHTML = "Please wait while the system <BR> Calls the specified Extension ... ";
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Record a Custom VoiceMenu</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr><td valign="top" align="center">
			<BR>
			<table id="maintable" cellpadding=3 cellspacing=0 border=0 width=400 style="border-width: 1px 1px 1px 1px; border-style: solid; border-color: #7E7E7E; ">
				<tr><td colspan=2 align=center class="field_text"><B>List of recorded voicemenus</B><select id='recorded_files' style="display:none"></select></td></tr>
				<tr bgcolor="#FFFFFF"><td><font color="#2D4E93" width="300">File Name</font></td><td  color="#2D4E93" ></td></tr>
				<tr><td colspan=2>
						<div style="height:125px;width=400px; overflow :auto;">
						<table id="table_recordefileslist"  cellpadding=3 cellspacing=0 border=0 width="100%"  class="field_text"></table>
						</div>
						</td>
				</tr>
			</table>

			<table width="500" cellspacing="1" cellpadding="2" border="0" align="center" id="no_rvmns" style="display: none"  bgcolor="#C2C2C2">
				<tr>
				<td align="center" bgcolor="#FFFFFF">
				<br/>You do not have any <i>Recorded Voicemenus</i> <br/><br/>
				Please click on the 'Record a new Voice Menu' button<br/> 
				to record a new Voicemenu.<br/><br/>
				</td>
				</tr>
			</table>
			<BR><BR>
			<div id="status"></div>
			<BR><BR>
			<input type="button" id="vvv" value="Record a new Voice Menu" onclick="show_record();">

		<div id="recordnew_content" STYLE="display:none; position: absolute; left: 20; top: 125; width:475; height:150;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid;z-index:5">
			<table width="100%" cellpadding=0 cellspacing=0 onmousedown="startDrag(event , 'recordnew_content');">
			<TR bgcolor="#7E5538"  style="background-image:url('images/title_gradient.gif');">
					<TD Height="20" align="center" style="cursor: move">
					<font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">Record a new Voicemenu</font>
					</TD>
				   <TD Height="20" align="right" style="cursor: move">
						<A href="#" onclick="hide_record();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
					</TD>
					<TD width=4></TD>
			</TR>
			</table>
			<table cellpadding=2 cellspacing=2 border=0>
				<tr>	<td colspan=2 height=15 valign=middle align=center class="field_text"></td></tr>
				<tr><td class="field_text">File Name:</td>
						<td><input id='newvmenu_name' size=24 class="input9">
								<input type="hidden" id="format" value="gsm">
						</td>
				</tr>
<!-- 				<tr><td>Format:</td>
						<td><select id='format'>
										<option value="gsm">gsm</option>
-										<option value="g723">g723</option>
										<option value="g729">g729</option>
										<option value="h623">h623</option>
										<option value="ulaw">ulaw</option>
										<option value="alaw">alaw</option>
										<option value="vox">vox</option>
										<option value="wav">wav</option>
										<option value="WAV">WAV</option> 
								</select>
						</td>
				</tr> -->
				<tr>	<td class="field_text">Extension used for recording:</td>
						<td><select id='newvmenu_ext' class="input9"></select></td>
				</tr>
				<tr>	<td colspan=2 align=center height=10></td></tr>
				<tr>	<td colspan=2 align=center>
						<input type="button" Value="Cancel" onclick="hide_record();" class="buttonbold">&nbsp;&nbsp;&nbsp;
						<input type="button" id='record' Value="Record" onclick="record_new()" class="buttonbold"></td></tr>
				<tr>	<td colspan=2 align=center height=10></td></tr>
			</table>
		</div>
	</td>
	</tr>
</table>
</div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 24; width:100%; height:100%;  background-color:#EFEFEF; -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #EFEFEF; border-style: solid; z-index:4">
</div>
<SCRIPT LANGUAGE="JavaScript">
<!--
showdiv_statusmessage();
//-->
</SCRIPT>
</body>

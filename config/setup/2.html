<HTML>
<HEAD>
	<TITLE> Asterisk GUI Setup Wizard</TITLE>
	<link href="setup.css" media="all" rel="Stylesheet" type="text/css" />
</HEAD>
<script src="../scripts/prototype.js"></script>
<SCRIPT LANGUAGE="JavaScript">
<!--
var rawman_url;
var sysinfocallbacks = new Object;
var today ;
var changed = 0;


function updated(){
	changed = 1;
	return true;
}


function localinit(){
	parent.$('next').disabled = false;
	parent.$('next').onclick = function(){	 
		window.location.href="3.html"; 
	};
	parent.$('back').disabled = false;
	parent.$('back').onclick  = function(){	 window.location.href="1.html"; };
	rawman_url = parent.rawman_url ;
	//parent.astmanEngine.setURL(rawman_url);
	ping();
}

function ping(){
			var opt = {
				method: 'get',
				asynchronous: true,
				onComplete: isloggedin
			};
			opt.parameters="action=ping" ;
			var tmp = new Ajax.Request(rawman_url , opt);
}

function isloggedin(originalRequest){
			if ( originalRequest.responseText.match("Error") ) {
				// User is not logged in , show him the login screen
				parent.window.location.href = parent.window.location.href ; 
			}

			if ( originalRequest.responseText.match("Pong") ) {
					//Get System Date & Time
					 update_sysinfo();
			}
}



function update_sysinfo(){
	parent.astmanEngine.run_tool("sh /etc/asterisk/gui_sysinfo", onSuccess = function() { 
			var opt = {
				method: 'get',
				asynchronous: true,
				onComplete: function(originalRequest){
					$('sysinfo').innerHTML = originalRequest.responseText;
					today = $('si_date').innerHTML;
					parent.astmanEngine.pollEvents();
					sysinfocallbacks_loaded();
				},
				onFailure: function(t) {
					alert("Config Error: " + t.status + ": " + t.statusText);
				}
			};
			opt.parameters="";
			var tmp = new Ajax.Request("../bkps/sysinfo_output.html", opt);
			return true;
	});
	return;
}


function sysinfocallbacks_loaded(){
		var temp = today.split(" ");
			if(temp[2] == ""){ temp.splice(2,1) ; }
		var dayofweek = temp[0]; // Fri
		var monthofyear = temp[1]; // Dec
		var dayofmonth = temp[2]; // 8
		var timeofday = temp[3]; // 23:59:59
		var timezone = temp[4]; // CST
		var year = temp[5]; // 2006

		for(var i=0; i < $('moy').length; i++){
			if ( $('moy').options[i].value.toLowerCase() == monthofyear.toLowerCase() ){
					$('moy').selectedIndex = i;
					break;
			}
		}

		for(var i=0; i < $('dom').length; i++){
				if ( $('dom').options[i].value == parseFloat(dayofmonth) ){
						$('dom').selectedIndex = i;
						break;
				}
		}

		var temp = timeofday.split(':');

		var hourofday = parseInt(temp[0]);
		if(hourofday <=12 ){
				if(hourofday == 0){
							$('hod').selectedIndex = 11;
							$('ampm').selectedIndex = 0;
				}else if(hourofday == 12){
							$('hod').selectedIndex = 11;
							$('ampm').selectedIndex = 1;
				}else{
							for(var i=0; i < $('hod').length; i++){
									if (  $('hod').options[i].value ==  hourofday ){
											$('hod').selectedIndex = i;
											break;
									}
							}
							$('ampm').selectedIndex = 0;
				}
		}else{
				var hourofday = parseInt(temp[0]) -12 ;
				$('ampm').selectedIndex = 1;
				for(var i=0; i < $('hod').length; i++){
						if (  $('hod').options[i].value ==  hourofday ){
								$('hod').selectedIndex = i;
								break;
						}
				}
		}
		
		for(var i=0; i < $('minute').length; i++){
					if (  $('minute').options[i].value == parseFloat(temp[1])  ){
							$('minute').selectedIndex = i;
							break;
					}
		}
		for(var i=0; i < $('second').length; i++){
					if (  $('second').options[i].value == parseFloat(temp[2])  ){
							$('second').selectedIndex = i;
							break;
					}
		}
		for(var i=0; i < $('year').length; i++){
					if (  $('year').options[i].value == parseFloat(year)  ){
							$('year').selectedIndex = i;
							break;
					}
		}
		parent.$('next').disabled = false;
		parent.$('next').onclick = function(){	 

			if(changed){
					update_systemdate();
					return true;
			}
			window.location.href="3.html"; 
		};
}

function update_systemdate(){
	var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function() { 
					window.location.href="3.html"; 
			},		
			onFailure: function(t) {
				$('status_message').style.display='none';
				alert("Config Error: " + t.status + ": " + t.statusText);
			}
		};

		// prepare commands to set the date 
		if( $('ampm').value == "AM"  ){
				if( $('hod').value == "12"  ){
					var hourofday = "00";
				}else{
					var hourofday = $('hod').value;
				}
		}else if( $('ampm').value == "PM"){
				if( $('hod').value == "12" ){
					var hourofday = parseInt( $('hod').value) ;
				}else{
					var hourofday = parseInt( $('hod').value) + 12 ;				 
				}
		}

		var newdate = $('year').value + "-" + ($('moy').selectedIndex +1) + "-" + $('dom').value + " " 
		+ hourofday + ":" + $('minute').value + ":" + $('second').value ;

		opt.parameters="action=originate&channel=" + encodeURIComponent("Local/executecommand@"+parent.asterisk_guitools ) + "&Variable=command%3d"+ encodeURIComponent("date --set='" + newdate + "'" ) + "&application=noop&timeout=60000";
		var tmp = new Ajax.Request(rawman_url, opt);
		return;
}
//-->
</SCRIPT>
<BODY bgcolor="#FFFFFF" onload="localinit()" topmargin=0 leftmargin=0>
<table width="100%" height="100%" border=0 cellpadding=0 cellspacing=0>
	<tr><td width="170" valign=top align=left>
					<div id="menu">
					<table cellpadding=3 cellspacing=2 border=0 id="sidelist">
						<tr><td width=3></td><td>Start</td></tr>
						<tr><td></td><td>Verify Analog Ports</td></tr>
						<tr><td></td><td class="slselected">Date & Time</td></tr>
						<tr><td></td><td>Local Extension Settings</td></tr>
						<tr><td></td><td>Service Providers</td></tr>
						<tr><td></td><td>Calling Rules</td></tr>
						<tr><td></td><td>VoiceMail Settings</td></tr>
						<tr><td></td><td>User Extensions</td></tr>
						<!-- <tr><td></td><td>VoiceMenus</td></tr> -->
						<tr><td></td><td>Finish</td></tr>
					</table>
					</div>
			</td>
			<td valign=top align=center>
			<!--  this page -->
				<div id='sysinfo' style="display:none"></div>
				<div class="heading">Step 2 of <script>document.write(parent.numberofsteps);</script>&nbsp;&nbsp;- Date & Time Settings</div>
				<div class="subheading">Please configure the current local system time:</div>
					 <TABLE cellpadding=6 cellspacing=1 border=0 class="timeinfo">
					 <TR>
					 	<TD>Day </TD>
					 	<TD>
						<!--  Day -->
									<select id="moy" onchange="updated();"> <option value="Jan">Jan</option><option value="Feb">Feb</option> <option value="Mar">Mar</option><option value="Apr">Apr</option>
										<option value="May">May</option><option value="Jun">Jun</option><option value="Jul">Jul</option><option value="Aug">Aug</option><option value="Sep">Sep</option>
										<option value="Oct">Oct</option><option value="Nov">Nov</option><option value="Dec">Dec</option>
								</select>
								<select id="dom" onchange="updated();">
									<SCRIPT LANGUAGE="JavaScript">
											for(var i=1; i < 32; i++){
												var x = '';
												if( i < 10) { x = '0'; }
												document.write( '<option value="' + x +i + '">' + x +i + '</option>' ); 
											}
									</SCRIPT>
								</select>
						<!--  Day -->
						</TD>
					 </TR>
					 <TR>
					 	<TD>Time</TD>
					 	<TD>
						<!-- Time -->
								<select id="hod" onchange="updated();">
								<SCRIPT LANGUAGE="JavaScript">
										for(var i=1; i < 13; i++){
											var x = '';
											if( i < 10) { x = '0' ; }
											document.write( '<option value="' + x + i + '">' + x +i + '</option>' ); 
										}
								</SCRIPT>
								</select>:<select id="minute" onchange="updated();">
								<SCRIPT LANGUAGE="JavaScript">
										for(var i=0; i < 60; i++){
											var x = '';
											if( i < 10) { x = '0' ; }
											document.write( '<option value="' + x +i + '">' + x +i + '</option>' ); 
										}
								</SCRIPT>
								</select>:<select id="second" onchange="updated();">
								<SCRIPT LANGUAGE="JavaScript">
										for(var i=0; i < 60; i++){
											var x = '';
											if( i < 10) { x = '0' ; }
											document.write( '<option value="' + x +i + '">' + x +i + '</option>' ); 
										}
								</SCRIPT>
								&nbsp;<select id="ampm" onchange="updated();"><option value="AM">AM</option><option value="PM">PM</option></select>
								</select>
						<!-- Time -->
						</TD>
					 </TR>
					 <TR style="display:none">
					 	<TD>Timezone </TD>
					 	<TD><select id="tz"><option value="CST">CST</option></select></TD>
					 </TR>
					 <TR>
					 	<TD>Year</TD>
					 	<TD>
								<select id="year" onchange="updated();">
								<SCRIPT LANGUAGE="JavaScript">
										for(var i=2006; i < 2100; i++)
											document.write( '<option value="' + i + '">' + i + '</option>' ); 
								</SCRIPT>
						</TD>
					 </TR>
					 </TABLE>
			<!--  this page -->
			</td>
		</tr>
</table>
</BODY>
</HTML>
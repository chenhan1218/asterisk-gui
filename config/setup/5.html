<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Setup WIzard/ Dialing Rules
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<HTML>
<HEAD>	<TITLE> Asterisk GUI Setup Wizard</TITLE>
	<link href="setup.css" media="all" rel="Stylesheet" type="text/css" />
</HEAD>
<script src="../scripts/prototype.js"></script>
<script src="../scripts/astman.js"></script>
<SCRIPT>
var rawman_url;
var trunks_desc = new Object;
var trunkcallbacks = new Object;
var numplan_callbacks = new Object;
var default_numberplan = 0;
var default_np_rules = new Array;
var default_np_comments = new Array;
var default_np_data = new Object;
var isnewrule ;
var iscustom ;
var pattern_beingedited ;
var pattern_beingedited_priority ;
var oldselect;

function localinit(){
	showdiv_statusmessage();
	//parent.$('next').disabled = true;
	parent._$('next').onclick = function(){ window.location.href="6.html"; };
	parent._$('back').disabled = false;
	parent._$('back').onclick  = function(){ window.location.href="4.html"; };
	rawman_url = parent.rawman_url ;
	parent.astmanEngine.setURL(rawman_url);
	ping();
}

function ping(){
	var opt = {
		method: 'get',
		asynchronous: true,
		onComplete: isloggedin
	};
	opt.parameters="action=ping" ;
	var tmp = new Ajax.Request(rawman_url , opt);
}

function isloggedin(originalRequest){
	if ( originalRequest.responseText.match("Error") ) {
		// User is not logged in , show him the login screen
		parent.window.location.href = parent.window.location.href ; 
	}

	if ( originalRequest.responseText.match("Pong") ) {
		_$('message_text').innerHTML ="Saving Changes...";
		parent.astmanEngine.config2list("users.conf", _$('trunks'), new Object(), trunkcallbacks);
	}
}

function addthe_default_callingplan(){
	gui_feedback("A default DialPlan is not found !! ", 5000 );
	_$('table_one').style.display="none";
	var newRow = _$('callingRulesTable').insertRow(-1);
	var newCell0 = newRow.insertCell(0);
	newCell0 .align = "center";
	newCell0 .style.fontSize = "14px";
	newCell0 .style.padding = "15px 0px 30px 0px";
	newCell0 .innerHTML = "the default DialPlan <B>'DialPlan1'</B> is not found !! "
	+ "<BR><BR><A href=\"#\" class=\"splbutton\" onclick=\"addthe_default_callingplan2()\">Click here</A> to create 'DialPlan1'" ;
	_$('addrule').disabled = 1;
	_$('heading2').style.display = "none";
}


function addthe_default_callingplan2(){
	var default_planname = 'numberplan-custom-1' ;
	var uri = build_action('newcat', 0, default_planname ,"", "");
	uri += build_action('append', 1, default_planname,"plancomment", "DialPlan1"); 
	uri += build_action('append', 2, default_planname,"include", "default"); 
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { location.reload(); },
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters= "action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(rawman_url, opt);
}


trunkcallbacks.format = function(t) {
	if ( t.fieldbyname['context'] != asterisk_guiTDPrefix + t.name ) {
		return null;
	}
	if (t.fieldbyname['trunkname'] && t.fieldbyname['trunkname'].length) {
		trunks_desc[t.name] = new Object();
		trunks_desc[t.name].comment = t.fieldbyname['trunkname'] ;
		return t.fieldbyname['trunkname'];
	} else{
		trunks_desc[t.name] = new Object();
		trunks_desc[t.name].comment = t.name ;
		return t.name;
	}
}

trunkcallbacks.loaded = function(){
	//_$('trunks').addEventListener('click',hackenablesave,false);
	ASTGUI.events.add( _$('trunks') , "click", hackenablesave );
	parent.astmanEngine.config2list("extensions.conf", _$('extensions'), new Object(), numplan_callbacks);
}

function hackenablesave(){
	if( oldselect != _$('trunks').value ){
		enablesave();
	}
}

numplan_callbacks.format = function(t, x) {
	var exten_fields;
	if(t.name == "numberplan-custom-1" && x == undefined ){ 
		default_numberplan = 1;
	}else if(t.name == "numberplan-custom-1" && t.names[x]=='exten' ){ 
		default_np_rules.push( t.fields[x] );
	}else if(t.name == "numberplan-custom-1" && t.names[x]=='comment' ){ 
		var tmp = t.fields[x].split(",");
		if( tmp.length > 1 ){
			default_np_comments.push( t.fields[x] );
		}
	}

	return false;
}

numplan_callbacks.loaded = function() {
	//parent.astmanEngine.pollEvents();
	if(!default_numberplan){
		// Redirect To creating a default Number Plan
		addthe_default_callingplan();
		return true;
	}
	for( var i=0; i < default_np_rules.length; i++){
		var temp = default_np_rules[i].split(","); // temp[0] is the pattern, temp[1] is the priority,temp[2] is 'Macro(trunkdial', temp[3] is ${trunkname}/${EXTEN:1})
		var temp1 = temp[3].split("{");
		var temp2 = temp1[1].split("}");
		var temp3 = temp1[2].split("}");
		var temp4 = temp3[0].split(":");
		temp[4] = temp2[0] ; // temp[4] is trunkname
		temp[5] = temp4[1] ; // temp[5] is the #digits to strip in the front
		if ( typeof default_np_data[temp[0]] == 'undefined' ) {
			default_np_data[temp[0]] = new Object();
		}
		default_np_data[temp[0]][temp[1]] = new Object();
		default_np_data[temp[0]][temp[1]].trunk = temp[4] ;
		default_np_data[temp[0]][temp[1]].digits2strip = temp[5] ;
	}
	for ( var i =0; i < default_np_comments.length ; i++){
		var temp = default_np_comments[i].split(",");
		default_np_data[temp[0]][temp[1]].rulename = temp[2] ;
		if(temp[3] !="custom"){
			default_np_data[temp[0]][temp[1]].ruledesc = parsepattern(temp[0],0) ;
		}else{
			default_np_data[temp[0]][temp[1]].ruledesc = "custom" ;
		}
	}
	// now show this object in a table.
	for( var x in default_np_data ){	// x is the pattern
		// sort the priorities
		if( !default_np_data.hasOwnProperty(x) ){ continue; }
		var sorted_priorities = [];
		for ( var y in default_np_data[x] ){
			if( default_np_data[x].hasOwnProperty(y) ){
				sorted_priorities.push(y);
			}
		}
		sorted_priorities.sort();
		// done sorting priorities
		// show fields in a table in the order of sorted priorities
		for( var z=0; z < sorted_priorities.length ; z++ ){
			//check if the trunk defined is actually an existing trunk
			var trunk_exists = 0;
			for(var i=0; i < _$('trunks').length ; i++ ){
				if( _$('trunks').options[i].value == default_np_data[x][sorted_priorities[z]].trunk ){
					trunk_exists = 1;
					break;
				}
			}

			if ( default_np_data[x][sorted_priorities[z]].trunk  == "" ){
				_$('trunks').selectedIndex = -1;
				addrowtotable( x , sorted_priorities[z] , "undefined" , default_np_data[x][sorted_priorities[z]].digits2strip );
			}else if(trunk_exists == 0){
				_$('trunks').selectedIndex = -1;
				addrowtotable( x , sorted_priorities[z] , "invalid" , default_np_data[x][sorted_priorities[z]].digits2strip );
			}else{
				addrowtotable( x , sorted_priorities[z] , default_np_data[x][sorted_priorities[z]].trunk , default_np_data[x][sorted_priorities[z]].digits2strip );
			}
		}
	}
	
	if( _$('callingRulesTable').rows.length == 0 ){
		_$('table_one').style.display="none";
		var newRow = _$('callingRulesTable').insertRow(-1);
		var newCell0 = newRow.insertCell(0);
		newCell0 .align = "center";
		newCell0 .style.fontSize = "13px";
		newCell0 .innerHTML = "<BR>A <I>Calling Rule</I> is not defined<BR><BR> Please click on the 'Add a Calling Rule' button<BR> to add a Calling Rule<BR><BR>" ;
		return true;
	}
}

numplan_callbacks.eachline = true;
numplan_callbacks.includecats = true;

function addrowtotable(a,b,c,d){	// a is pattern, b is priority, c is trunk, d is digits2strip

	var sno = _$('callingRulesTable').rows.length + 1;
	var newRow = _$('callingRulesTable').insertRow(-1);
	newRow.id = "row" + sno; 
	
	var newCell0 = newRow.insertCell(0);
	newCell0.innerHTML = sno ;
	newCell0.width=35;
	newCell0.align="center";

	var newCell1 = newRow.insertCell(1);
	newCell1.innerHTML =  default_np_data[a][b].rulename ; 
	newCell1.width=90;

	var newCell2 = newRow.insertCell(2);
	newCell2.innerHTML =  default_np_data[a][b].ruledesc ; 

	var newCell3 = newRow.insertCell(3);
	newCell3.align="center";
	newCell3.width=85;
	if(c == "invalid" || c== "undefined"  ){
		newCell3.innerHTML = "<span style='cursor:pointer; color : #0000ff;'  onclick=\"editcallingrule('"+ a +"', '"+ b +"')\">Select a ServiceProvider</span>";
	}else{
		newCell3.innerHTML = trunks_desc[c].comment  ;
	}

	var newCell4 = newRow.insertCell(4);
	newCell4.innerHTML = "<A href=\"#\" onclick=\"editcallingrule('"+ a +"', '"+ b +"')\">Edit</A>&nbsp;&nbsp;<A href=\"#\" onclick=\"deletecallingrule('"+ a +"', '"+ b +"')\">Delete</A>";
	newCell4.width=75;
	newCell4.align="center";
	return true;
}

function deletecallingrule(a,b){
	t=confirm("Are you sure ?")
	if(t == false){ return true; }
	delete_callingrule(a,b, oncomplete = function(){location.reload();} )  ;
}

function delete_callingrule(a,b,oncomplete){
	var commentstring = (default_np_data[a][b].ruledesc == 'custom')?"custom":"standard" ;
	var rule_string = a + ',' + b + ',Macro(trunkdial,${' + default_np_data[a][b].trunk + '}/${EXTEN:' + default_np_data[a][b].digits2strip + '})' ;
	var uri = build_action('delete', 0, "numberplan-custom-1" ,"exten", "", rule_string ); 
	commentstring = a + ',' + b + ',' + default_np_data[a][b].rulename + ',' + commentstring ;
	uri += build_action('delete', 1 , "numberplan-custom-1" ,"comment","", commentstring );

	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { oncomplete(); },
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters= "action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	_$('userscontent').style.display="none";
	_$('bg_transparent').style.display='none';
	_$('status_message').style.display= "";
	var tmp = new Ajax.Request(rawman_url, opt);
}

function editcallingrule(a,b){
	pattern_beingedited = a ;
	pattern_beingedited_priority = b ;
	oldselect = _$('trunks').value;
	isnewrule = false;
	_$('rulename').value = default_np_data[a][b].rulename;
	_$('trunks').selectedIndex = -1 ;
	for(var i=0; i < _$('trunks').length ; i++ ){
		if( _$('trunks').options[i].value == default_np_data[a][b].trunk ){
		_$('trunks').selectedIndex = i ;
		break;
		}
	}
	_$('pattern').value = a;
	_$('strip').value = default_np_data[a][b].digits2strip;
	_$('save_a').disabled = 1;

	if(default_np_data[a][b].ruledesc == 'custom' ){
		// if this is a custom pattern then donot try to parse the pattern
		iscustom = true;
		_$('define_advanced').style.display="";
		_$('define_usual').style.display="none";
	}else{
		// if this is standard pattern then parse the pattern into 'beginswith', 'followedby'
		var temp = parsepattern(a,1);
		iscustom = false;
		_$('define_advanced').style.display="none";
		_$('define_usual').style.display="";
	}

	_$('userscontent').style.display="";
	_$('bg_transparent').style.display='';
	_$('addrule').disabled =1;
}

function parsepattern(a,e){
	returnstring="";
	// Parsing into fields
	// if first character is underscore (always) - remove it 
	var temp = a.substr(1);
	// if there is a dot at the end 
	//		check ormore and remove the trailing dot
	if( temp.substr(-1,1) == "!" ){
		temp = temp.slice(0, -1);
		returnstring = "or more";
		if(e == 1)
		_$('ormore').checked = true;
	}
	var posofx = temp.indexOf('X');
	//alert("position of X in " + temp + " is " + posofx );
	// if X does not occur anywhere followedby is = 0
	// if X happens somewhere then beginswith = string till somewhere
	//		and followedby = length of string from somewhere till end
	if(posofx == -1){ 	
		if(returnstring == "or more"){
			returnstring = "Begins with " + temp + " and followed by 0 or more digits" ;
		}else{
			returnstring = "Exactly matches " + temp  ;
		}
		if(e == 1){
			_$('beginswith').value = temp;
			_$('followedby').value = 0;
		}
	}else{
		if(returnstring == "or more"){
			returnstring = "Begins with " + temp.substr(0,posofx) + " and followed by "+(temp.length - posofx)+" or more digits" ;
		}else{
			returnstring = "Begins with " + temp.substr(0,posofx) + " and followed by "+(temp.length - posofx) + " digits";
		}
		if(e == 1){
			_$('beginswith').value = temp.substr(0,posofx);
			_$('followedby').value = (temp.length - posofx);
		}
	}

return returnstring;
}

function ownpattern(){
	iscustom = true;
	_$('define_advanced').style.display="";
	_$('define_usual').style.display="none";
}

function enablesave(){
	_$('save_a').disabled = 0;
	return true;
}

function add_callingrule(){
	isnewrule = true;
	_$('rulename').value = "";
	_$('trunks').selectedIndex = -1 ;
	_$('pattern').value = "";
	_$('strip').value = "0" ;
	_$('save_a').disabled = 1;
	_$('define_advanced').style.display="none";
	_$('define_usual').style.display="";
	_$('userscontent').style.display="";
	_$('bg_transparent').style.display='';
	_$('addrule').disabled =1;
	_$('beginswith').value = "";
	_$('followedby').value ="";
	_$('ormore').checked = false;
}

function add_rule_fromeditform( this_priority, oncomplete ){
	if( iscustom ){ // custom - take pattern as is
		var commentstring = "custom";
	}else{
		var commentstring = "standard";
		//build a pattern into $('pattern').value
		buildpatternstring();
	}
		
	var rule_string = _$('pattern').value + ',' + this_priority + ',Macro(trunkdial,${' + $('trunks').value + '}/${EXTEN:' + $('strip').value + '})' ;
	var uri = build_action('append', 0 , "numberplan-custom-1" ,"exten", rule_string );
	commentstring = _$('pattern').value + ',' + this_priority + ',' + _$('rulename').value + "," + commentstring ;
	uri += build_action('append', 1 , "numberplan-custom-1" ,"comment", commentstring );

	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { oncomplete(); },
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters= "action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	_$('userscontent').style.display="none";
	_$('bg_transparent').style.display='none';
	_$('status_message').style.display='';
	var tmp = new Ajax.Request(rawman_url, opt);
}


function saverule(){
	if ( !checkfields() ) return false;
	 if(isnewrule){ // add this rule to the default plan and reload the page
		var newpriority=1;
		if( typeof default_np_data[$('pattern').value] !="undefined" ){
			var  t = _$('pattern').value;
			for ( var y in default_np_data[t] ){
				if(default_np_data[t].hasOwnProperty(y) ){ newpriority++; }
			}
		}
		add_rule_fromeditform( newpriority, oncomplete = function(){location.reload();}  );
	 }else{	// update exiting rule
		// delete existing rule
		// add rule with new values
		delete_callingrule(pattern_beingedited,pattern_beingedited_priority, oncomplete = function(){
		add_rule_fromeditform( pattern_beingedited_priority, oncomplete = function(){location.reload();} );
		});
		//$('userscontent').style.display='none';
		//$('addrule').disabled =0;
		//return true;
	 }
}

function	buildpatternstring(){
	var pattern = _$('beginswith').value;
	// Add an underscore
	pattern = "_" + pattern;
	// append 'followedby' number of X's 
	for (var r=0; r < _$('followedby').value ; r++){
		pattern = pattern + "X" ;
	}
	// append a '.' if 'ormore' is checked
	if( _$('ormore').checked ){
		pattern = pattern + "!" ;
	}
	// assign this to the field 'pattern'
	_$('pattern').value = pattern;
}

function checkfields(){
	if( _$('rulename').value.length == 0 ){
		alert("Please enter a Rule Name");
		_$('rulename').focus();
		return false;
	}
	if(_$('trunks').selectedIndex == -1){
		alert("Please select a service provider to place this call through");
		return false;
	}
	if(_$('define_advanced').style.display=="none" && _$('beginswith').value.length==0 ){
		alert("Please Enter the beginning pattern of the number");
		_$('beginswith').focus();
		return false;
	}
	if(_$('define_usual').style.display=="none" && _$('pattern').value.length == 0 ){
		alert("Please Enter a custom pattern");
		_$('pattern').focus();
		return false;
	}
return true;
}

</SCRIPT>
<BODY bgcolor="#FFFFFF" onload="localinit()" topmargin=0 leftmargin=0>
<table width="100%" height="100%" border=0 cellpadding=0 cellspacing=0>
<tr>
<td width="170" valign=top align=left>
	<div id="menu">
	<table cellpadding=3 cellspacing=2 border=0 id="sidelist">
		<tr><td width=3></td><td>Start</td></tr>
		<tr><td></td><td>Verify Analog Ports</td></tr>
		<!-- <tr><td></td><td>Date & Time</td></tr> -->
		<tr><td></td><td>Local Extension Settings</td></tr>
		<tr><td></td><td>Service Providers</td></tr>
		<tr><td></td><td class="slselected">Calling Rules</td></tr>
		<tr><td></td><td>VoiceMail Settings</td></tr>
		<tr><td></td><td>User Extensions</td></tr>
		<tr><td></td><td>Incoming Calls</td></tr>
		<!-- <tr><td></td><td>VoiceMenus</td></tr> -->
		<tr><td></td><td>Finish</td></tr>
	</table>
	</div>
</td>
<td valign=top align=center>
<!--  this page -->
	<select id="extensions" style="display:none"></select>
	<div class="heading">Step 4 of <script>document.write(parent.numberofsteps);</script>&nbsp;&nbsp;-  Outbound Calling Rules</div>
	<div id="heading2" style="font-size:13px; padding : 0px 0px 10px 0px;">List of Calling Rules in default dialplan - <B>DialPlan1</B> </div>
	<table class="table_blacksm" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
		<tr>	<td width=35>S.No</td>
			<td width=90>RuleName</td>
			<td>Dial Pattern</td>
			<td width=85 align=center>Call Using</td>
			<td width=75 align=center>Options</td>
		</tr>
	</table>
	
	<div id="callingRulesTable_div" style="height:250px;width=100%; overflow :auto; padding : 0px 0px 0px 0px;">
		<table id="callingRulesTable" cellpadding=2 cellspacing=1 border=0 align=center width=500></table>
	</div>

	<div style="display:none;" id='status'></div>
	<center><input type="button" id="addrule" value="Add a Calling Rule" onclick="add_callingrule();"></center>
	
	<div id="userscontent" STYLE="display:none; position: absolute; left: 225; top: 40; width:500; height:290;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid; z-index:5">
	<table width="100%" cellpadding=0 cellspacing=0 onmousedown="startDrag(event , 'userscontent');">
	<TR bgcolor="#7E5538" >
		<TD Height="20" align="right" style="cursor: move">
			<A href="#" onclick="$('cancel_a').click();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
		</TD>
		<TD width=4></TD>
	</TR>
	</table>

	<TABLE	align=center cellpadding=2 cellspacing=2 border=0 width="480">
	<TR>	<TD align="right" width=175  class="field_text">Rule Name:</TD>
		<TD><input type="text" id="rulename" size="" onChange="enablesave();" onkeyup="enablesave();"></TD>
	</TR>
	<TR>	<TD  align="right" height=40  class="field_text"> Place this call through :</TD>
		<TD><select id="trunks"></select></TD>
	</TR>
	<TR id="define_usual" height=100>
		<TD valign="top" align=right  class="field_text">Dialing Rules :</TD>
		<TD valign="top"  class="field_text">
		If the number begins with <input id="beginswith" type='text' size=6 onChange="enablesave();" onkeyup="enablesave();"> 
		and followed by <input id="followedby" type='text' size=1  onChange="enablesave();" onkeyup="enablesave();"> 
		digits <input type="checkbox" id="ormore" onChange="enablesave();"> or more 
		<BR> <A href="#" onclick="ownpattern();">(define a custom pattern)</A>
		</TD>
	</TR>
	
	<TR id="define_advanced"  height=100>
		<TD valign="top" align=right  class="field_text"> Custom Pattern: </TD>
		<TD valign=top>
			<input type="text" id="pattern" size="" onChange="enablesave();" onkeyup="enablesave();"><BR>
			<table align='left' cellpadding=0 cellspacing=0>
			<tr>	<td class="field_text"><b>N&nbsp;&nbsp;</b></td>
				<td class="field_text">Any digit from 2 to 9</td>
			</tr>
			<tr>	<td class="field_text"><b>X&nbsp;&nbsp;</b></td>
				<td class="field_text">Any digit from 0 to 9</td>
			</tr>
			<tr>	<td class="field_text"><b>.&nbsp;&nbsp;</b></td>
				<td class="field_text">Any number of additional digits</td>
			</tr>
			</table>
		</TD>
	</TR>

	<TR>	<TD colspan=2 align=center  class="field_text">
		Strip <input type="text" id="strip" size="1"  onChange="enablesave();" onkeyup="enablesave();"> 
		digits from the front before dialing:
		</TD>
	</TR>
	<TR>	<TD colspan=2 align=center height=50 valign=middle>  
			<input type="button" id="save_a" value="Save" onclick="saverule();">&nbsp;&nbsp;
			<input type="button" id="cancel_a" value="Cancel" onclick="$('userscontent').style.display='none'; $('bg_transparent').style.display='none'; $('addrule').disabled =0; " >
		</TD>
	</TR>
	</TABLE>
	</div>
<!--  this page -->
</td>
</tr>
</table>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 0; width:100%; height:100%;  background-color:#FFFFFF; filter:alpha(opacity=50); -moz-opacity:.50;opacity:.50; border-width: 0px; z-index:4">
</div>
</BODY>
</HTML>
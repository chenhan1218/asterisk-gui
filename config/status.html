<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Users" generally
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
var selectedchan = null;
var transferedchan = "";
var hungupchan = "";


function doHangup() {
	hungupchan = selectedchan;
	parent.astmanEngine.sendRequest('action=hangup&channel=' + selectedchan, afterHangup);
}

function afterHangup(){
	refreshChannelsList();
	$('status').innerHTML = "Hungup " + hungupchan;
}


function doTransfer() {
	var channel = parent.astmanEngine.channelInfo(selectedchan);
	var exten = prompt("Enter new extension for " + selectedchan);
	var altchan;
	if (exten) {
		if (channel.link) {
			if (confirm("Transfer " + channel.link + " too?"))
				altchan = channel.link;
		}
		if (altchan) {
			transferredchan = selectedchan + " and " + altchan + " to " + exten;
			parent.astmanEngine.sendRequest('action=redirect&channel=' + selectedchan + "&priority=1&extrachannel=" + altchan + "&exten=" + exten, afterTransfer);
		} else {
			transferredchan = selectedchan + " to " + exten;
			parent.astmanEngine.sendRequest('action=redirect&channel=' + selectedchan + "&priority=1&exten=" + exten, afterTransfer);
		}
	}
}

function afterTransfer(){
	refreshChannelsList();
	$('status').innerHTML = "Transferred " + transferredchan;
}

function refreshChannelsList() {
	selectedchan = null;
	$('transfer').disabled = 1;
	$('hangup').disabled = 1;
	$('status').innerHTML = "<i>Updating channel status...</i>";
	parent.astmanEngine.channelClear();
	parent.astmanEngine.sendRequest('action=status', onStatusCheck);
	updateButtons();
}	

onStatusCheck = function(msgs) {
	if (msgs[0].headers['response'] != "Success") {
		//something went wrong - may be the user is logged out or 500 or 404  or what ever
	}

	for (i=1;i<msgs.length - 1;i++) 
		parent.astmanEngine.channelUpdate(msgs[i]);
	$('channellist').innerHTML = parent.astmanEngine.channelTable(channelsCallback);
	$('status').innerHTML = "Ready";
}


function updateButtons(){
	if ($(selectedchan)) {
		$('transfer').disabled = 0;
		$('hangup').disabled = 0;
	} else {
		$('transfer').disabled = 1;
		$('hangup').disabled = 1;
		selectedchan = null;
	}
		$('refresh').disabled = 0;
}

channelsCallback = function(target) {
	selectedchan = target;
	updateButtons();
}

parent.eventeater.eventcd = function (msgs) {
		for (i=1;i<msgs.length - 1;i++) 
			parent.astmanEngine.channelUpdate(msgs[i]);
		$('channellist').innerHTML = parent.astmanEngine.channelTable(channelsCallback);
		parent.astmanEngine.pollEvents();
}


function localajaxinit(){
		setWindowTitle("Active Channels");
		refreshChannelsList() ;
		parent.astmanEngine.setEventCallback(parent.eventeater.eventcd );
		parent.loadscreen(this);
}

function localajaxend(){
		parent.astmanEngine.setEventCallback(parent.eventeater.eventcb );
		if( navigator.userAgent.indexOf("MSIE") != -1 ){ 
			try{ purge( document.body ); } catch(e){ }	
		}
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF" onunload="localajaxend()">

<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold">Channels Status</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr valign="top" height="18">
		<td>
		Active Channels: <div  id='status'></div>
		</td>
	</tr>
	<tr height=32 valign="middle">
		<td align="center">
				<input type="submit" onClick="refreshChannelsList()" id="refresh" value="Refresh"  onmouseover="show_tooltip('en', 'status', 1);"  class="buttonbold">
				<input type="submit" onClick="doTransfer()" id="transfer" value="Transfer..."  onmouseover="show_tooltip('en', 'status', 2);"  class="buttonbold">
				<input type="submit" onClick="doHangup()" id="hangup" value="Hangup"  onmouseover="show_tooltip('en', 'status', 3);"  class="buttonbold">
		</td>
	</tr>
	<tr>
			<td colspan=3 valign="top">
			<div id="channellist" class="chanlist" onmouseover="show_tooltip('en', 'status', 0);"></div>
			</td>
	</tr>
</table>
</div>
</body>
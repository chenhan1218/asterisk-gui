<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for "Users" generally
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
	var logins = new Object;
	var logoffs = new Object;
	var channels = new Object;
	var pongs = new Object;
	var loggedon = -1;
	var selectedchan = null;
	var hungupchan = "";
	var transferedchan = "";
	
	var activechannels = new Object;
	
	function loggedOn() {
		if (loggedon == 1)
			return;
		loggedon = 1;
		updateButtons();
		$('status').innerHTML = "<i>Retrieving channel status...</i>";
		parent.astmanEngine.pollEvents();
		parent.astmanEngine.sendRequest('action=status', activechannels.channels);
	}
	
	function clearChannelList() {
		$('channellist').innerHTML = "<i class='light'>Not connected</i>";
			$('transfer').disabled = 1;
			$('hangup').disabled = 1;
	}

	function loggedOff() {
		loggedon = 0;
		selectedchan = null;
		parent.astmanEngine.channelClear();
	 	clearChannelList();
	}
	
	function updateButtons()
	{
		if ($(selectedchan)) {
			$('transfer').disabled = 0;
			$('hangup').disabled = 0;
		} else {
			$('transfer').disabled = 1;
			$('hangup').disabled = 1;
			selectedchan = null;
		}
		if (loggedon) {
			$('refresh').disabled = 0;
		} else {
			$('transfer').disabled = 1;
			$('hangup').disabled = 1;
			$('refresh').disabled = 1;
		}
	}
	
	activechannels.channelCallback = function(target) {
		selectedchan = target;
		updateButtons();
	}
	
	activechannels.channels = function(msgs) {
		resp = msgs[0].headers['response'];
		if (resp == "Success") {
			loggedOn();
		} else
			loggedOff();

		for (i=1;i<msgs.length - 1;i++) 
			parent.astmanEngine.channelUpdate(msgs[i]);
		$('channellist').innerHTML = parent.astmanEngine.channelTable(activechannels.channelCallback);
		$('status').innerHTML = "Ready";
	}

	activechannels.logins = function(msgs) {
		$('status').innerHTML = msgs[0].headers['message'];
		resp = msgs[0].headers['response'];
		if (resp == "Success")
			loggedOn();
		else
			loggedOff();
	};
	
	
	activechannels.logoffs = function(msgs) {
		$('status').innerHTML = msgs[0].headers['message'];
		loggedOff();
	};

	activechannels.hungup = function(msgs) {
		$('status').innerHTML = "Hungup " + hungupchan;
	}
	
	activechannels.transferred = function(msgs) {
		$('status').innerHTML = "Transferred " + transferredchan;
	}

	function doHangup() {
		hungupchan = selectedchan;
		parent.astmanEngine.sendRequest('action=hangup&channel=' + selectedchan, activechannels.hungup);
	}

	function doStatus() {
		$('status').innerHTML = "<i>Updating channel status...</i>";
		parent.astmanEngine.channelClear();
		parent.astmanEngine.sendRequest('action=status', activechannels.channels);
	}	
		
	function doLogin() {
		$('status').innerHTML = "<i>Logging in...</i>";
		parent.astmanEngine.sendRequest('action=login&username=' + $('username').value + "&secret=" + $('secret').value, activechannels.logins);
	}
	
	function doTransfer() {
		var channel = parent.astmanEngine.channelInfo(selectedchan);
		var exten = prompt("Enter new extension for " + selectedchan);
		var altchan;
		if (exten) {
			if (channel.link) {
				if (confirm("Transfer " + channel.link + " too?"))
					altchan = channel.link;
			}
			if (altchan) {
				transferredchan = selectedchan + " and " + altchan + " to " + exten;
				parent.astmanEngine.sendRequest('action=redirect&channel=' + selectedchan + "&priority=1&extrachannel=" + altchan + "&exten=" + exten, activechannels.transferred);
			} else {
				transferredchan = selectedchan + " to " + exten;
				parent.astmanEngine.sendRequest('action=redirect&channel=' + selectedchan + "&priority=1&exten=" + exten, activechannels.transferred);
			}
		}
	}
	
	function doLogoff() {
		$('status').innerHTML = "<i>Logging off...</i>";
		parent.astmanEngine.sendRequest('action=logoff', activechannels.logoffs);
	}
	
	activechannels.pongs  = function(msgs) {
		resp = msgs[0].headers['response'];
		if (resp == "Pong") {
			loggedOn();
		} else {
			$('status').innerHTML = "<i>Please login...</i>";
			loggedOff();
		}
	}
	
	activechannels.eventcb = function(msgs) {
		var x;
		if (loggedon) {
			for (i=1;i<msgs.length - 1;i++) {
				parent.astmanEngine.channelUpdate(msgs[i]);
			}
			$('channellist').innerHTML = parent.astmanEngine.channelTable(activechannels.channelCallback);
			parent.astmanEngine.pollEvents();
		}
		updateButtons();
	}

function localajaxinit(){
		parent.astmanEngine.setEventCallback(activechannels.eventcb);
		clearChannelList();
		parent.astmanEngine.sendRequest('action=ping', activechannels.pongs);
		parent.loadscreen(this);
}
</script>
<body id="foo" onload="localajaxinit()">

<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold">Channels Status</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr valign="top" height="18">
		<td>
		Active Channels: <div  id='status'></div>
		</td>
	</tr>
	<tr height=32 valign="middle">
		<td align="center"><input type="submit" onClick="doStatus()" id="refresh" value="Refresh">
				<input type="submit" onClick="doTransfer()" id="transfer" value="Transfer...">
				<input type="submit" onClick="doHangup()" id="hangup" value="Hangup">
		</td>
	</tr>
	<tr>
			<td colspan=3 valign="top">
			<div id="channellist" class="chanlist"></div>
			</td>
	</tr>
</table>
</div>
</body>
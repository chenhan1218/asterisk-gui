<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Create/Manage Service Providers (trunks)
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
	var origwidth;
	var widgets = new Array;
	var provwidgets = new Array;
	var callbacks = new Object;
	var phonecallbacks = new Object;
	var providercallbacks = new Object;
	var globalvars = new Object;
	var fieldnames = new Array(
				'delete', 'status', 'new', 'save', 'cancel','secret', 'provider', 'zapchan',
				'trunkstyleanalog','trunkstylevoip','trunkstylecustomvoip', 'name', 'username', 'trunkname', 'callerid',
				'hasexten', 'hassip', 'hasiax','registeriax','registersip','host','dialformat','context','group',
				'insecure', 'host', 'fromuser', 'fromdomain','contact','disallow','allow');
	var provfieldnames = new Array('providerdesc', 'providerlogo');
	var focus_fields = new Array('provider','username','secret','customvoip_name','customvoip_protocol',
	'customvoip_host','customvoip_username','customvoip_secret','fromuser','contact', "insecure", "port", "callerid", "fromdomain", "fromuser", "contact","custom_trunkname");

	var isnewtrunk;
	var dids_array = [];
	var old_trunkname;


	function add_didcontext(trunk){
		var didcontext = asterisk_guiTDPrefix + trunk ;
		var uri = build_action('newcat', 0, didcontext ,"", "");
		uri += build_action('append', 1, didcontext ,"include", "default"); 
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { },
			onFailure: function(t) {
				gui_alert("Config Error: " + t.status + ": " + t.statusText + "<BR><BR>"+ "Failed to create a DID context for " + trunk );
			}
		};
		opt.parameters= "action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
		var tmp = new Ajax.Request("../../rawman", opt);
	}

	function update_didcontext(old_trunk, new_trunk){
		var old_didcontext = asterisk_guiTDPrefix + old_trunk  ;
		var new_didcontext = asterisk_guiTDPrefix + new_trunk  ;
		var uri = build_action('renamecat', 0, old_didcontext ,"", new_didcontext );
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { callbacks_savechanges_step2(); },
			onFailure: function(t) {
				gui_alert("Config Error: " + t.status + ": " + t.statusText);
				gui_alert("Failed to Rename the DID context for " + old_didcontext );
			}
		};
		opt.parameters= "action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
		var tmp = new Ajax.Request("../../rawman", opt);
	}


	function delete_didcontext(trunk){
		var didcontext = asterisk_guiTDPrefix + trunk ;
		var uri = build_action('delcat', 0, didcontext ,"", "");
		var opt = {
			method: 'get',
			asynchronous: true,
			onSuccess: function(t) { },
			onFailure: function(t) {
				gui_alert("Config Error: " + t.status + ": " + t.statusText);
				gui_alert("Failed to delete DID context for " + trunk);
			}
		};
		opt.parameters= "action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
		var tmp = new Ajax.Request("../../rawman", opt);
	}

	providercallbacks.postselect = function() {
			try{
				if( $('provider').stored_config.catbyname[ $('provider').value ].fieldbyname['regurl'] ){
					$('providerlink').href= $('provider').stored_config.catbyname[ $('provider').value ].fieldbyname['regurl'];
					$('providerlink').target = "_blank";
				}else{
					$('providerlink').href= "#";
					$('providerlink').target = "";
				}
			}catch(e){
					$('providerlink').href= "#";
					$('providerlink').target = "";
			}
	}

	providercallbacks.format = function(t) {
		return t.fieldbyname['providername'];
	}
	
	globalvars.format = function(t) {
		if ( t.name.substring(0,asterisk_guiTDPrefix.length) == asterisk_guiTDPrefix ){
			dids_array.push( t.name.substring( asterisk_guiTDPrefix.length ) );
		}
		if (t.name == "globals")
			return t.name
		return null;
	}
	
	globalvars.loaded = function() {
		parent.astmanEngine.config2list("users.conf", $('devices'), widgets, callbacks);
	}

	providercallbacks.loaded = function() {
		$('provider').altonchange = $('provider').onchange;
		$('provider').onchange = null;
		parent.astmanEngine.config2list("extensions.conf", $('hiddenglobals'), new Array, globalvars);
	}
	
	callbacks.format = function(t) {
		/*
		if ((t.name == 'general'))
			return null;
		if (t.name.substring(0,6) != 'trunk_')
			return null;
		return t.fieldbyname['trunkname'];
		*/
		// if t.name is found in dids_array
		if( InArray(dids_array, t.name) ){
			return t.fieldbyname['trunkname'];
		}
		return null;
	}

	callbacks.cancelnewcategory = function(){
		hideSPdetails();
	}

	callbacks.cancelchanges = function(){
		hideSPdetails();
	}

	callbacks.loaded = function() {
		$('devices').contentEditable = 'true';
		$('devices').disabled = 0;
		add_event( $('new') , "click", showSPdetails ) ;
		loadServiceProvidersintotable();
		preparemenus();
		parent.loadscreen(this);
	}

	callbacks.postselect = function(){

				if( $('trunkstylecustomvoip').checked ){
					// Custom VOIP
						var tmp = $('trunkname').value.split("Custom - ")  ;
						$('customvoip_name').value = tmp[1];
						$('customvoip_username').value = $('username').value;
						$('customvoip_secret').value = $('secret').value;
						if ( $('hassip').value  == "yes" ){
							$('customvoip_protocol').selectedIndex = 1;
						}else {
							$('customvoip_protocol').selectedIndex = 0;
						}
						$('customvoip_host').value = $('host').value;
						if($('registeriax').value == "yes" || $('registersip').value == "yes"){
							$('customvoip_register').checked = true;
						}else{
							$('customvoip_register').checked = false;
						}

				}else if ( $('trunkstylevoip').checked ){
					// VOIP
						$('customvoip_name').value = "";
						$('customvoip_username').value = $('username').value;
						$('customvoip_secret').value = $('secret').value;
						$('customvoip_protocol').selectedIndex = 0;
						$('customvoip_host').value ="";
				}

	}


	callbacks.delchanges = function(box, value) {
		deletesp_fromui(value);
		delete_didcontext(value);
		var oldvalue = $('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[value];
		if (oldvalue) {
			uri = build_action('delete', 0, 'globals', value, "");
			apply_uri($('hiddenglobals'), uri);
			$('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[value] = null;
			return true;
		}
	}

	callbacks.beforeSaving = function(){
			if ($('trunkstylevoip').checked && !$('username').value.length ) {
				gui_alert("When using VoIP, the username must not be empty!");
				return false;
			}
			if ($('trunkstyleanalog').checked ) {
				if( $('zapchan').options.length == 0 ){
				gui_alert("No analog line hardware installed on the system");
				return false;
				}

				if (!$('zapchan').value) {
				gui_alert("When using Analog, at least one port must be selected.");
				return false;
				}
			}
			if ($('trunkstylecustomvoip').checked ) {
				if( $('customvoip_name').value.length == 0 ){
					gui_alert("Please enter a Comment for this Service Provider");
					$('customvoip_name').focus();
					return false;
				}

				if ( !$('customvoip_host').value ) {
					gui_alert("Please enter a host name");
					$('customvoip_host').focus();
					return false;
				}
				if ( !$('customvoip_username').value ) {
					gui_alert("Please enter a Username");
					$('customvoip_username').focus();
					return false;
				}
			}
			
			if(!$('trunkstylevoip').checked && !$('trunkstyleanalog').checked && !$('trunkstylecustomvoip').checked ){
				gui_alert("A trunk must be Analog or VoIP or Custom VOIP");
				return false;
			}
			if(isnewtrunk ==1){
				try{
				provider = $('provider').stored_config.catbyname[$('provider').value];		
				if( typeof provider.fieldbyname['trunk_username'] != "undefined" && $('trunkstylevoip').checked ){
					$('name').value = provider.fieldbyname['trunk_username'];
				}
				}catch(e){

				}
				dids_array.push($('name').value );
			}else{
					old_trunkname = $('devices').value ;
					if( $('devices').value != $('name').value){ // if the trunk name is changed , change the name in dids_array
							for( var i=0 ; i < dids_array.length; i ++	){
								if( dids_array[i] == $('devices').value) { dids_array[i] = $('name').value;}
							}
					}	
			}
	}

	callbacks.savechanges = function() {
		if(isnewtrunk == 1){ //New Trunk created , add [DID_trunk_x] in extensions.conf
			add_didcontext($('name').value);
			if ($('trunkstylevoip').checked) {
				$('dialformat').value = (provider.fieldbyname['dialformat']) ? provider.fieldbyname['dialformat'] : '${EXTEN:1}';
				$('callerid').value = '';
				$('insecure').value = (provider.fieldbyname['insecure']) ? provider.fieldbyname['insecure'] : '' ;
				$('port').value = (provider.fieldbyname['port']) ? provider.fieldbyname['port'] : '' ;
				$('fromuser').value = (provider.fieldbyname['fromuser']) ? provider.fieldbyname['fromuser'] : '' ;
				if ($('fromuser').value == '<DID>') { $('fromuser').value = $('username').value; }
				$('fromdomain').value = (provider.fieldbyname['fromdomain']) ? provider.fieldbyname['fromdomain'] : '' ;
			}
			callbacks_savechanges_step2();
		}else{
			if(old_trunkname != $('name').value ){ update_didcontext(old_trunkname, $('name').value); } // rename DID if needed
		}

		return false;
	}


function callbacks_savechanges_step2(){
		saveSPdetails();
		var uri;
		var newvalue;
		var tmp = $('devices').value.split('_');

		var oldvalue = $('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[$('devices').value];
		if ($('trunkstylevoip').checked || $('trunkstylecustomvoip').checked) {
			if ($('devices').stored_config.catbyname[$('devices').value].fieldbyname['hasiax'] == 'yes')
				newvalue = "IAX2/" + $('devices').value;
			else
				newvalue = "SIP/" + $('devices').value;
		} else {
			newvalue = "Zap/g"+tmp[1];
		}

		if (newvalue != oldvalue) {
			if(old_trunkname == $('name').value ){	
				uri = build_action('update', 0, 'globals', $('devices').value, newvalue);
				apply_uri($('hiddenglobals'), uri);
				$('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[$('devices').value] = newvalue;
				return true;
			}else{
				uri = "";
				var u =0; 
				if(old_trunkname){ uri = build_action('delete', u, 'globals', old_trunkname, "","" ); u++; }
				uri += build_action('update', u , 'globals', $('name').value, newvalue); u++;
				apply_uri($('hiddenglobals'), uri);
				$('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[$('name').value] = newvalue;
				return true;
			}
		}
}


	callbacks.checkparams = function(box) {
		var needcomma = 0;
		var provider;
		var count = 0;
		$('hasexten').value = 'no';
		$('context').value =  asterisk_guiTDPrefix + $('name').value  ;
		if ($('trunkstylevoip').checked) {
							provider = $('provider').stored_config.catbyname[$('provider').value];
							$('trunkname').value = $('provider').options[$('provider').selectedIndex].innerHTML + " - " + $('username').value;
							$('hassip').value = provider.fieldbyname['hassip'];
							$('hasiax').value = provider.fieldbyname['hasiax'];
							$('registeriax').value = provider.fieldbyname['registeriax'];
							$('registersip').value = provider.fieldbyname['registersip'];
							$('host').value = provider.fieldbyname['host'];
							for (var x=0;x<$('zapchan').options.length;x++)
								$('zapchan').options[x].selected = false;
							$('zapchan').value = '';
							$('group').value = '';
		} else if ($('trunkstyleanalog').checked) {
				// Analog
						$('provider').selectedIndex  = -1;
						count = 0;
						$('trunkname').value = "";
						for (var x=0;x<$('zapchan').options.length;x++) {
							if ($('zapchan').options[x].selected) {
								if (needcomma)
									$('trunkname').value += ","
								needcomma = 1;
								$('trunkname').value += $('zapchan').options[x].value;
								count++;
							}
						}
						if (count > 1)
							$('trunkname').value = "Ports " + $('trunkname').value;
						else
							$('trunkname').value = "Port " + $('trunkname').value;
						$('callerid').value = 'asreceived';
						$('hassip').value = 'no';
						$('hasiax').value = 'no';
						$('callerid').value = 'asreceived';
						$('group').value = $('name').value.split('_')[1];
		} else if( $('trunkstylecustomvoip').checked ){
						// Custom VOIP Provider
						$('trunkname').value = "Custom - " + $('customvoip_name').value;
						provider = $('customvoip_name').value;
						$('provider').selectedIndex  = -1;
						$('username').value = $('customvoip_username').value;
						$('secret').value = $('customvoip_secret').value;
						if( $('customvoip_protocol').value == "iax" ){
							$('hassip').value = "no";
							$('hasiax').value = "yes";
						}else{
							$('hassip').value = "yes";
							$('hasiax').value = "no";				
						}
						if( $('customvoip_register').checked && $('customvoip_protocol').value == "iax"){
							$('registeriax').value = 'yes';
							$('registersip').value = 'no';
						}
						if( $('customvoip_register').checked && $('customvoip_protocol').value == "sip"){
							$('registeriax').value = 'no';
							$('registersip').value = 'yes';
						}
						if( !$('customvoip_register').checked ){
							$('registeriax').value = 'no';
							$('registersip').value = 'no';
						}
						$('host').value = $('customvoip_host').value ;
						$('dialformat').value = '${EXTEN:1}';
						$('callerid').value = '';
						$('insecure').value = '';
						$('port').value = '';
//						$('context').value = 'default';
						$('fromuser').value = '';
						$('fromdomain').value = '';
						for (var x=0;x<$('zapchan').options.length;x++)
							$('zapchan').options[x].selected = false;
						$('zapchan').value = '';
						$('group').value = '';
		}

		return false;
	}
	callbacks.newcategory = function() {
		var tmp = null;
		var x;
		if ($('devices').stored_config.catbyname['general'])
			tmp = objcopy($('devices').stored_config.catbyname['general']);
		if (tmp) {
			x = 1;
			while($('devices').stored_config.catbyname['trunk_' + x]) x++;
			tmp.name = 'trunk_' + x;
		}
		tmp.fieldbyname['hasexten'] = 'no';
		tmp.fieldbyname['context'] = asterisk_guiTDPrefix + tmp.name;
		$('customvoip_name').value = "";
		$('customvoip_username').value = "";
		$('customvoip_secret').value = "";
		$('customvoip_protocol').selectedIndex = 0;
		$('customvoip_host').value ="";
		$('analog').style.display="none";
		$('voip').style.display="none";
		$('customvoip').style.display="none";
		$('userscontent_title').innerHTML = "Add Service Provider";
		isnewtrunk = 1;
		return tmp;

	}
	callbacks.identifier = "extension";
	
	phonecallbacks.format = function(t) {
		if (t.fieldbyname['port'] == 'fxs')
			return "Analog Port #" + t.name;
		return null;
	}

	phonecallbacks.loaded = function() {
		parent.astmanEngine.config2list("providers.conf", $('provider'), provwidgets, providercallbacks);
	}
	

	function update_zapchan(){
		$('save').disabled = false;
		$('cancel').disabled = false;

		for (k=0;k< $('zapchan').length ;k++ ){
				var selectedline = "selectedline" + k;
				if( $(selectedline).checked  ){
					$('zapchan').options[k].selected = true;
				}else{
					$('zapchan').options[k].selected = false;
				}
		}
	}



	function activateanalogvoip() {
		$('analog').style.display = "none";
		$('zapchan').style.display = "none";
		$('zapchan_analoglines').style.display = "none";
		$('zapchan_analoglines').innerHTML ="";
		$('customvoip').style.display = "none" ;
		$('voip').style.display= "none";

		if ($('trunkstyleanalog').checked) {
				$('analog').style.display = "block";
				$('zapchan_analoglines').style.display = "block";
				if($('zapchan').options.length ==0){
					$('zapchan_analoglines').innerHTML = "No analog line hardware installed on the system";
				}else{
						for (k=0;k< $('zapchan').length ;k++ ){
								var selectedline = "selectedline" + k;
								if($('zapchan').options[k].selected){
									$('zapchan_analoglines').innerHTML += '<LABEL FOR="' + selectedline + '"><INPUT id="' + selectedline + '" TYPE="CHECKBOX" VALUE="'+ $('zapchan').options[k].value+ '" checked onclick="update_zapchan()">' + $('zapchan').options[k].text + '</LABEL><BR>';
								}else{
									$('zapchan_analoglines').innerHTML += '<LABEL FOR="'+ selectedline+'"><INPUT id="' + selectedline + '" TYPE="CHECKBOX" VALUE="'+ $('zapchan').options[k].value+ '" onclick="update_zapchan()">' + $('zapchan').options[k].text + '</LABEL><BR>';
								}
						}
				}
		}else if ($('trunkstylevoip').checked) {
				$('voip').style.display = "block";
				$('voip').style.height =350;
		}else if ($('trunkstylecustomvoip').checked) {
				$('customvoip').style.display = "block" ;
		}
	}
	
	function localajaxinit() {
		setWindowTitle("Service Providers");
		$('devices').contentEditable = 'false';
		$('zapchan').splitchar=',';
		$('trunkstyleanalog').altonclick = $('trunkstyleanalog').onclick;
		$('trunkstyleanalog').onclick = null;
		$('trunkstylevoip').altonclick = $('trunkstylevoip').onclick;
		$('trunkstylevoip').onclick = null;
		$('trunkstylecustomvoip').altonclick = $('trunkstylecustomvoip').onclick;
		$('trunkstylecustomvoip').onclick = null;
		add_event( $('custom_trunkname') , 'change' , function(){ $('name').value = $('custom_trunkname').value; $('save').disabled = false; }) ;

		for (var x =0; x< fieldnames.length; x++) {
			widgets[fieldnames[x]] = $(fieldnames[x]);
			widgets[fieldnames[x]].disabled = true;
		}
		for (var x =0; x < provfieldnames.length ; x++) {
			provwidgets[provfieldnames[x]] = $(provfieldnames[x]);
			provwidgets[provfieldnames[x]].disabled = true;
		}
		for (var x =0; x < focus_fields.length; x++ ) {
			$(focus_fields[x]).onfocus = function(){this.className = 'input8_hilight';}
			$(focus_fields[x]).onblur = function(){this.className = 'input8';}
		}
		parent.astmanEngine.config2list("zapscan.conf", $('zapchan'), new Array(), phonecallbacks);
	}










function loadServiceProvidersintotable(){

	for( var i=0; i <  $('serviceproviderstable').rows.length; ){
			 $('serviceproviderstable').deleteRow(i);
	}

	if($('devices').length == "0" ){
		$('table_one').style.display="none";
		var newRow = $('serviceproviderstable').insertRow(-1);
		var newCell0 = newRow.insertCell(0);
		newCell0 .align = "center";
		newCell0 .innerHTML = "<BR>A <I>Service Provider</I> is not defined<BR><BR> Please click on the 'Add Service Provider' button<BR> to add a service provider<BR><BR>" ;
		return true;
	}

	$('table_one').style.display="";	
	for(i=0; i< $('devices').length; i++){
		if($('devices').options[i].text != "New Entry")
		addrow_totable($('devices').options[i].text, $('devices').options[i].value);
	}

}



function addrow_totable(sp_text, sp_value){
		var sno = $('serviceproviderstable').rows.length + 1;
		var newRow = $('serviceproviderstable').insertRow(-1);
		newRow.id = "row" + sp_value; 
		newRow["sp_value"] = sp_value ;
		newRow.onmouseover= function(){ this.style.backgroundColor='#F9F0D1'; };
		newRow.onmouseout=function(){ this.style.backgroundColor='#FFFFFF'; };

		var newCell0 = newRow.insertCell(0);
		newCell0 .innerHTML = sno ;
		newCell0 .style.width = 40;

		var newCell1 = newRow.insertCell(1);
		newCell1 .innerHTML = sp_text ;
		newCell1 .style.width = 200;

		var newCell2 = newRow.insertCell(2);
		switch ( $('devices').stored_config.catbyname[sp_value].fieldbyname['trunkstyle'] ){
		case "customvoip":
			newCell2 .innerHTML =  "Custom Voip";
			break;
		case "analog":
			newCell2 .innerHTML =  "Analog";
			break;
		case "voip":
			newCell2 .innerHTML =  "Voip";
			break;
		default : 
			newCell2 .innerHTML =  "?";
		}

		var newCell3 = newRow.insertCell(3);
		newCell3 .innerHTML = "<A href=\"#\" onclick=\"editSP('"+ sp_value +"');\" class=\"field_text9\">Edit</A>&nbsp;&nbsp;&nbsp;&nbsp;<A href=\"#\" onclick=\"deleteSP('"+ sp_value +"');\"  class=\"field_text9\">Delete</A>" ;
		newCell3 .style.width = 120;
		newCell3 .align = "center";

		/* create menu and its actions */
		newRow.oncontextmenu = show_mymenu ;
		newRow.onclick = hide_mymenu ; 
		/*  End of creating menu */
}

function hide_mymenu( ) {
	document.getElementById('mymenu').style.display="none"; 
}

function show_mymenu(event) {
	var menu = document.getElementById('mymenu');
	menu.sp_value = "";

	if(typeof window.scrollX != "undefined"){ //FF
		var menu_top = event.clientY ;
		var menu_left = event.clientX;
		var f = event.target ; 
	}else{ // IE
			var menu_top = window.event.clientY ;
			var menu_left = window.event.clientX;
			try{ 
				var f = window.event.srcElement; 
			}catch(e){
				menu.style.display = "none";
				return false;			
			}
	}

	if(f.parentNode.sp_value){
		menu.sp_value = f.parentNode.sp_value ; 
	}else if( f.parentNode.parentNode.sp_value ){
		menu.sp_value = f.parentNode.parentNode.sp_value ; 
	}
	menu.style.top = menu_top;
	menu.style.left = menu_left;
	menu.style.display = "";
	return false;
}


function preparemenus(){
	var menu_div = document.getElementById('mymenu') ;
	menu_div.style.width="90";
	add_event( document.body , "click", function(){ document.getElementById('mymenu').style.display="none"; } );

	var menuitem1 = document.createElement('div');
	menuitem1.innerHTML = "Edit" ;
	menuitem1.onclick =  function(){ hide_mymenu( ); editSP( this.parentNode.sp_value) };
	menuitem1.onmouseover= function(){  
			document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
			this.style.backgroundColor='#EFEFEF';  
	};
	menuitem1.onmouseout=function(){  
			document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
			this.style.backgroundColor='#FFFFFF';  
	};
	menu_div.appendChild(menuitem1);

	var menuitem2 = document.createElement('div');
	menuitem2.innerHTML = "Codecs" ;
	menuitem2.onclick =  function(){  
		for(var i=0; i< $('devices').length; i++){
			if( this.parentNode.sp_value == $('devices').options[i].value ){
					$('devices').selectitem(i);
					showCodec_details();
					break;
			}
		}
	};
	menuitem2.onmouseover= function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF'; 
	};
	menuitem2.onmouseout=function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF'; 
	};
	menu_div.appendChild(menuitem2);

	var menuitem4 = document.createElement('div');
	menuitem4.innerHTML = "Advanced" ;
	menuitem4.onclick =  function(){  
		hide_mymenu( ); 
		for(var i=0; i< $('devices').length; i++){
			if( this.parentNode.sp_value == $('devices').options[i].value ){
					$('devices').selectitem(i);
					$('bg_transparent').style.display = "";
					$('custom_trunkname').value = $('name').value ;
					$('advanced_content').style.display = "";  
					break;
			}
		}
	};
	menuitem4.onmouseover= function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF'; 
	};
	menuitem4.onmouseout=function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF'; 
	};
	menu_div.appendChild(menuitem4);

	var menuitem3 = document.createElement('div');
	menuitem3.innerHTML = "Delete" ;
	menuitem3.onclick =  function(){  hide_mymenu( );  deleteSP( this.parentNode.sp_value );  };
	menuitem3.onmouseover= function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#F6E7B6';   
		this.style.backgroundColor='#EFEFEF'; 
	};
	menuitem3.onmouseout=function(){ 
		document.getElementById('row'+this.parentNode.sp_value ).style.backgroundColor='#FFFFFF';  
		this.style.backgroundColor='#FFFFFF'; 
	};
	menu_div.appendChild(menuitem3);

}

function codecs_save(){
	$('save').click( );
	$('codecs_content').style.display = "none";
	$('bg_transparent').style.display ='none';
}

function showCodec_details(){
		update_div_setordercodecs();
		$('codecs_content').style.display = "";
		$('bg_transparent').style.display ='';
}

function hide_codecs(){
		$('cancel').click( );
		$('codecs_content').style.display = "none";
		$('bg_transparent').style.display ='none';
}

function editSP(sp_value){
	isnewtrunk = 0;
	$('userscontent_title').innerHTML = "Edit Service Provider";
	for(var i=0; i< $('devices').length; i++){
			if(sp_value == $('devices').options[i].value ){
					$('devices').selectitem(i);
					showSPdetails();
					break;
			}
	}
}


// Allowed/Disallowed codescs related functions
function enable_selectedcodec(){
	// add to allowed
	selectbox_add("allowed" ,  $('disallowed').value );
	// remove selected from disallowed
	selectbox_remove("disallowed", $('disallowed').value );
	update_ordercodecs();
}
function disable_selectedcodec(){
	// add to disallowed
	selectbox_add("disallowed" ,  $('allowed').value );
	// remove selected from allowed
	selectbox_remove("allowed", $('allowed').value );
	update_ordercodecs();
}

function selectbox_add(selectbox_id, codec){
		switch(codec) {
		  case 'ulaw': addtosel("u-law","ulaw",selectbox_id) ; break;
		  case 'alaw': addtosel("a-law","alaw",selectbox_id) ; break;
		  case 'gsm': addtosel("GSM","gsm",selectbox_id) ; break ;
		  case 'ilbc': addtosel("ILBC","ilbc",selectbox_id) ; break ;
		  case 'speex': addtosel("SPEEX","speex",selectbox_id) ; break ;
		  case 'g726':  addtosel("G.726","g726",selectbox_id) ; break ;
		  case 'adpcm': addtosel("ADPCM","adpcm",selectbox_id) ; break ;
		  case 'lpc10': addtosel("LPC10","lpc10",selectbox_id) ; break ;
		  case 'g729': addtosel("G.729","g729",selectbox_id) ; break ;
		  default: break
	   }

	function addtosel(a,b,c){ // a is text, b is value, c is the select box id
	  var newoption = document.createElement('option');
	  newoption.text = a ;
	  newoption.value = b ;
	  var selectbox = document.getElementById( c );
	  try {
		selectbox.add(newoption, null); // standards compliant; doesn't work in IE
	  }catch(ex) {
		selectbox.add(newoption); // IE only
	  }
	}
}

function  selectbox_remove(selectbox_id,codec){
	for (var x=0; x < $(selectbox_id).length; x++){
		if( $(selectbox_id).options[x].value==codec ){	$(selectbox_id).remove(x);		return true;		}
	}
}
function update_ordercodecs(){ 
			$('disallow').value = "";
			$('allow').value = "";
			if($('disallow_all').checked){
					$('disallow').value = "all";
			}else{
					for (var x=0; x < $('disallowed').length ; x++){
						if(x==0){
							$('disallow').value = $('disallowed').options[x].value ;
						}else{
							$('disallow').value = $('disallow').value + "," + $('disallowed').options[x].value ;
						}
					}
			}

			for (var x=0; x < $('allowed').length ; x++){
				if(x==0){ 	
						$('allow').value = $('allowed').options[x].value ; 
				}else{
						$('allow').value = $('allow').value + "," +  $('allowed').options[x].value ; 
				}
			}
			$('save').disabled = false;
			$('cancel').disabled = false;
}

function update_div_setordercodecs(){
		$('disallowed').innerHTML=""; 	$('allowed').innerHTML="";
		if( $('disallow').value == "all" || $('disallow').value == ""){
			$('disallow_all').checked = true;
			selectbox_add("disallowed", "ulaw");
			selectbox_add("disallowed", "alaw");
			selectbox_add("disallowed", "gsm");
			selectbox_add("disallowed", "ilbc");
			selectbox_add("disallowed", "speex");
			selectbox_add("disallowed", "g726");
			selectbox_add("disallowed", "adpcm");
			selectbox_add("disallowed", "lpc10");
			selectbox_add("disallowed", "g729");
		}else{
			var tmp = $('disallow').value.split(",");
			for(var x=0; x < tmp.length; x++){
				selectbox_add("disallowed", tmp[x]);
			}
		}
		var tmp = $('allow').value.split(",");
		for(var x=0; x < tmp.length; x++){
			selectbox_add("allowed", tmp[x]);
			selectbox_remove("disallowed",tmp[x]);
		}
}

function disallow_all_refresh(){
	if( $('disallow_all').checked ){
		$('disallowed').innerHTML=""; 	$('allowed').innerHTML="";
		$('disallow').value = "all";
		$('allow').value = "";
		update_div_setordercodecs();
		$('save').disabled = false;
		$('cancel').disabled = false;
	}
}


function saveSPdetails(){
		hideSPdetails();
		loadServiceProvidersintotable();
}

function hideSPdetails(){
		$('userscontent').style.display = "none";
		$('bg_transparent').style.display ='none';
}

function showSPdetails(){
		$('cancel').disabled = false;
		$('userscontent').style.display = "block";
		$('bg_transparent').style.display ='';
		if ( isnewtrunk == 0){
			$('trunkstyleanalog').disabled = true;
			$('trunkstylevoip').disabled = true;
			$('trunkstylecustomvoip').disabled = true;
			$('provider').disabled = true;
		}
}

function deleteSP(trunk){
	for(var i=0; i< $('devices').length; i++){
				if($('devices').options[i].value == trunk){
							$('devices').selectitem(i) ;
							$('delete').disabled = 0;
							if( !$('delete').click() ){
								return;
							}
						break;
				}
	}
}

function deletesp_fromui(trunk){
		var delete_id = "row" + trunk;
		for( var i=0; i <  $('serviceproviderstable'). rows.length; i++){
			if  ( $('serviceproviderstable'). rows[i].id == delete_id  ){
				 $('serviceproviderstable').deleteRow(i);
				 loadServiceProvidersintotable();
				 break;
			}
		}
}

function flip_register(){
	$('cancel').disabled= false;
	$('save').disabled= false;
	if( $('customvoip_register').checked && $('customvoip_protocol').value == "iax"){
		$('registeriax').value = 'yes';
		$('registersip').value = 'no';
	}
	if( $('customvoip_register').checked && $('customvoip_protocol').value == "sip"){
		$('registeriax').value = 'no';
		$('registersip').value = 'yes';
	}
	if( !$('customvoip_register').checked ){
		$('registeriax').value = 'no';
		$('registersip').value = 'no';
	}
}

function free_mem( ){
	if( navigator.userAgent.indexOf("MSIE") == -1 ){ return true; }
		try{
			widgets['save'].hostselectbox = null ;
			widgets['cancel'].hostselectbox = null ;
			widgets['new'].hostselectbox = null ;
			widgets['delete'].hostselectbox = null ;
			purge( document.body );
		}catch(e){ }
}

function advanced_save(){
	$('save').disabled = false;
	$('save').click();
	$('bg_transparent').style.display = "none";
	$('advanced_content').style.display = "none";
}

function advanced_cancel(){
	$('cancel').click();
	$('bg_transparent').style.display = "none";
	$('advanced_content').style.display = "none";
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF"   onunload="free_mem()">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Service Providers</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>

<select disabled size="1" id="devices" style="display:none"></select><input type='button' id='delete' value='Delete' style="display:none">
<BR>
<center>
<font size="+1">List of Service Providers</font>
<table class="table_black" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
	<tr>	<td width=40>S.No</td>
			<td width="200">Service Provider</td>
			<td>Type</td>
			<td width="120" align="center">Options</td>
	</tr>
</table>
<div style="width:500;height:250; overflow :auto;">
<table id="serviceproviderstable" cellpadding=2 cellspacing=1 border=0 align=center width=500>
</table>
</div>
<div style="height:25px;color: #FF0000;" id='status'  class="field_text9"></div>
<input type='button' id='new' value='Add Service Provider'>
</center>
<!-- UsersContent DIV -->
<div id="userscontent" STYLE="display:none; position: absolute; left: 20; top: 40; width:500; height:400;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid; z-index:5">
	<table width="100%" cellpadding=0 cellspacing=0>
		<TR bgcolor="#7E5538" style="background-image:url('images/title_gradient.gif');">
				<TD  onmousedown="startDrag(event , 'userscontent');" id="userscontent_title" style="cursor: move;color:#FFFFFF; font-size: 12px; font-weight:bold;" align="center"></TD>
				<TD Height="20" width=15 align="center"  style="color:#FFFFFF; font-size: 12px; font-weight:bold;" onclick="$('cancel').click();">X</TD>
		</TR>
	</table>

<table align="center" width=450>
<tr>
<td onmouseover="show_tooltip('en', 'trunks', 0);"  class="field_text" width=130 valign="top" align="left">
<!-- Provider type -->
				<div id='cabinet' style='width:0;overflow:hidden'><select id='hiddenglobals'></select></div>
	<fieldset>
		<legend><B>&nbsp;Provider Type:&nbsp;</B></legend>
				<LABEL FOR="trunkstyleanalog"><input name='trunkstyle' type='radio' id='trunkstyleanalog' onclick='activateanalogvoip()' value='analog'>Analog</LABEL><BR>
				<LABEL FOR="trunkstylevoip"><input name='trunkstyle' type='radio' id='trunkstylevoip' onclick='activateanalogvoip()' value='voip'>VoIP</LABEL><BR>
				<LABEL FOR="trunkstylecustomvoip"><input name='trunkstyle' type='radio' id='trunkstylecustomvoip' onclick='activateanalogvoip()' value='customvoip'>Custom VoIP</LABEL>
	</fieldset>
				<div id="div_providername" style="display:none">
				<BR><BR>
				<B>Provider Name:</B><BR>
				<input id="name" size=10 class='input8'>
				</div>
<!-- Provider type -->
</td>
<td>
<!-- Provider options -->
			<div id='analogvoipcontainer' style='height:350;overflow:hidden' align="center">
			<div id='analog' style='overflow:hidden' align="center">
							<table align="center">
							<tr onmouseover="show_tooltip('en', 'trunks', 2);"><td style='width:80px' valign='top' class="field_text">Lines:</td>
									<td><select size="12" multiple='true' id='zapchan' style='width:200px' class="input8"></select>
											<div id="zapchan_analoglines" style='height:110px; width: 200px; overflow :auto; display:none'></div>
									</td>
							</tr>
							<tr><td colspan='2' style='width:80px' valign='top' align='center'></td></tr>
							</table>
				</div>
				<div id='voip' style='height:0;overflow:hidden' align="center">
						<table align="center">
						<tr  onmouseover="show_tooltip('en', 'trunks', 1);"><td style='width:80px' valign='top' class="field_text">Provider:</td><td><select size='6' id='provider' style='width:200px' altonchange='selectprovider()' class="input8"></select></td></tr>
						<tr><td colspan='2' align='center'><div style="height:15px" id='status'></div></td></tr>
						<tr><td colspan='2' align='center'><A href="#" id="providerlink"><img id='providerlogo' style='visibility:hidden;' border=0></A></td></tr>
						<tr><td colspan='2' align='center'><div id='providerdesc' align='left' style='width:230px;height:100px; font-size:10px'></div></td></tr>
						<tr onmouseover="show_tooltip('en', 'trunks', 3);"><td class="field_text">Username:</td><td><input size='20' id='username' class="input8"></td></tr>
						<tr onmouseover="show_tooltip('en', 'trunks', 4);"><td class="field_text">Password:</td><td><input type="password" size='20' id='secret' class="input8"></td></tr>
						</table>
				</div>
				<div id='customvoip' align="center" style='display:none' align="center">
						<table align="center" cellpadding=2 cellspacing=1>
									<input id="trunkname" type="hidden">
									<input id="hasiax" type="hidden">
									<input id="hassip" type="hidden">
									<input id="hasexten" type="hidden">
									<input id="registeriax" type="hidden">
									<input id="registersip" type="hidden">
									<input id="host" type="hidden">
									<input id="dialformat" type="hidden">
									<input id="context" type="hidden">
									<input id="group" type="hidden">
									<tr>
										<td height=10></td>
										<td></td>
									</tr>
									<tr>
										<td class="field_text">Comment:</td>
										<td><input type="text" id="customvoip_name" size=14 onkeyup=" $('cancel').disabled= false;$('save').disabled= false;"  class="input8"></td>
									</tr>
									<tr>
										<td class="field_text">Protocol:</td>
										<td><select id="customvoip_protocol" onchange=" $('cancel').disabled= false;$('save').disabled= false;"  class="input8">
												<option value="iax">IAX</option>
												<option value="sip">SIP</option>
												</select></td>
									</tr>
									<tr>
										<td class="field_text">Register:</td>
										<td><input type="checkbox" id="customvoip_register" onchange="flip_register();"  class="input8"></td>
									</tr>
									<tr>
										<td class="field_text">Host:</td>
										<td><input type="text" id="customvoip_host" size=14 onkeyup=" $('cancel').disabled= false;$('save').disabled= false;"  class="input8"></td>
									</tr>
									<tr>
										<td class="field_text">Username:</td>
										<td><input type="text" id="customvoip_username" size=14 onkeyup=" $('cancel').disabled= false;$('save').disabled= false;"  class="input8"></td>
									</tr>
									<tr>
										<td class="field_text">Password:</td>
										<td><input type="password" id="customvoip_secret" size=14 onkeyup=" $('cancel').disabled= false;$('save').disabled= false;"  class="input8"></td>
									</tr>
						</table>
				</div>
				</div>
<!-- Provider options -->
</td>
</tr>
<tr><td></td><td align="center"><input type='button' id='save' value='Save' class="buttonbold">&nbsp;<input type='button' id='cancel' value='Cancel' class="buttonbold"></td></tr>
</table>
</div>
<!-- Users content DIV -->
<!-- Codecs content DIV -->
<div id="codecs_content" STYLE="display:none; position: absolute; left: 20; top: 125; width:350;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid;z-index:5">
	<table width="100%" cellpadding=0 cellspacing=0 onmousedown="startDrag(event , 'codecs_content');">
	<TR bgcolor="#7E5538"  style="background-image:url('images/title_gradient.gif');">
			<TD Height="20" align="center" style="cursor: move"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">Codec Preferences</font></TD>
		   <TD Height="20" align="right" style="cursor: move"><A href="#" onclick="hide_codecs();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A></TD>
			<TD width=4></TD>
	</TR>
	</table>
	<table align=center>
		<tr><td><BR></td></tr>
		<tr><td class="field_text">Allowed</td>
				<td></td>
				<td class="field_text">Disallowed</td>
		</tr>
		<tr><td><select id="allowed" size=9 class="input8"></select></td>
				<td><input type="button" id="select_codec" value="<" onclick="enable_selectedcodec()"><BR><input type="button" id="deselect_codec" value=">" onclick="disable_selectedcodec()"></td>
				<td><select id="disallowed" size=9 class="input8">
						</select>
				</td>
		</tr>
		<tr><td></td>
				<td></td>
				<td class="field_text"><input id='allow' style="display:none"><input id='disallow'  style="display:none"><input type=checkbox id="disallow_all" onclick="disallow_all_refresh();">Disallow All</td>
		</tr>
		<tr><td colspan=3 align=Center>
				<input type="button" class="buttonbold" id="setordercodecs" value="update" onclick="codecs_save( )">&nbsp;&nbsp;
				<input type="button" class="buttonbold" id="cancel_setorder" value="Cancel" onclick="hide_codecs( )">
				</td>
		</tr>
		<tr><td><BR></td></tr>
	</table>
</div>
<!-- Codecs content DIV -->
<!-- Advanced content DIV -->
<div id="advanced_content" STYLE="display:none; position: absolute; left: 20; top: 125; width:350; height:197;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid;z-index:7">
	<table width="100%" cellpadding=0 cellspacing=0 onmousedown="startDrag(event , 'advanced_content');">
	<TR bgcolor="#7E5538"  style="background-image:url('images/title_gradient.gif');">
			<TD Height="20" align="center" style="cursor: move"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">Advanced Settings</font></TD>
		   <TD Height="20" align="right" style="cursor: move"><A href="#" onclick="advanced_cancel();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A></TD>
			<TD width=4></TD>
	</TR>
	</table>
	<table align=center>
		<tr>	<td class="field_text">trunkname:</td>
				<td><input id="custom_trunkname" size=14  class="input8"></td>
		</tr>
		<tr>	<td class="field_text">insecure:</td>
				<td><input id="insecure" size=14  class="input8"></td>
		</tr>
		<tr>	<td class="field_text">port:</td>
				<td><input  id="port" size=14 class="input8"></td>
		</tr>
		<tr>	<td class="field_text">Caller Id:</td>
				<td><input type="text" id="callerid" size=14 class="input8"></td>
		</tr>
		<tr>	<td class="field_text">fromdomain:</td>
				<td><input type="text" id="fromdomain" size=14 class="input8"></td>
		</tr>
		<tr>	<td class="field_text">fromuser:</td>
				<td><input type="text" id="fromuser" size=14 class="input8"></td>
		</tr>
		<tr>	<td class="field_text">contact:</td>
				<td><input type="text" id="contact" size=14 class="input8"></td>
		</tr>
		<tr><td colspan=2 align=Center>
				<input type="button" class="buttonbold" value="update" onclick="advanced_save( )">&nbsp;&nbsp;
				<input type="button" class="buttonbold" value="Cancel" onclick="advanced_cancel( )">
				</td>
		</tr>
	</table>
</div>
<!-- Advanced content DIV -->
<div id="mymenu" class="mymenu" style="display:none"></div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 24; width:100%; height:100%;  background-color:#EFEFEF; -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #EFEFEF; border-style: solid; z-index:4">
</div>
</body>

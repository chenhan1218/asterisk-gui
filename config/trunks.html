<!--
 * Asterisk -- An open source telephony toolkit.
 *
 * Configuration for Trunks generally
 *
 * Copyright (C) 1999 - 2006, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->

<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />

<script>
	var origwidth;
	var widgets = new Array;
	var provwidgets = new Array;
	var callbacks = new Object;
	var phonecallbacks = new Object;
	var providercallbacks = new Object;
	var globalvars = new Object;
	var fieldnames = new Array(
				'delete', 'status', 'new', 'save', 'cancel','secret', 'provider', 'zapchan',
				'trunkstyleanalog','trunkstylevoip', 'name', 'username', 'trunkname', 'callerid',
				'hasexten', 'hassip', 'hasiax');
				
	var provfieldnames = new Array('providerdesc', 'providerlogo');

	providercallbacks.format = function(t) {
		return t.fieldbyname['providername'];
	}
	
	globalvars.format = function(t) {
		if (t.name == "globals")
			return t.name
		return null;
	}
	
	globalvars.loaded = function() {
		parent.astmanEngine.config2list("users.conf", $('devices'), widgets, callbacks);
	}

	providercallbacks.loaded = function() {
		$('provider').altonchange = $('provider').onchange;
		$('provider').onchange = null;
		parent.astmanEngine.config2list("extensions.conf", $('hiddenglobals'), new Array, globalvars);
	}
	
	callbacks.format = function(t) {
		if ((t.name == 'general'))
			return null;
		if (t.name.substring(0,6) != 'trunk_')
			return null;
		return t.fieldbyname['trunkname'];
	}

	callbacks.loaded = function() {
		$('devices').contentEditable = 'true';
		$('devices').disabled = 0;
		parent.loadscreen(this);
	}

	callbacks.delchanges = function(value) {
		var oldvalue = $('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[value];
		if (oldvalue) {
			uri = build_action('delete', 0, 'globals', value, "");
			alert('was ' + oldvalue + '\n' + 'new uri ' + uri);
			apply_uri($('hiddenglobals'), uri);
			$('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[value] = null;
			return true;
		}
	}

	callbacks.savechanges = function() {
		var uri;
		var newvalue;
		var tmp = $('devices').value.split('_');
		var oldvalue = $('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[$('devices').value];
		if ($('trunkstylevoip').checked) {
			if ($('devices').stored_config.catbyname[$('devices').value].fieldbyname['hasiax'] == 'yes')
				newvalue = "IAX2/" + $('devices').value;
			else
				newvalue = "SIP/" + $('devices').value;
		} else {
			newvalue = "Zap/g"+tmp[1];
		}
		if (newvalue != oldvalue) {
			uri = build_action('update', 0, 'globals', $('devices').value, newvalue);
			apply_uri($('hiddenglobals'), uri);
			$('hiddenglobals').stored_config.catbyname['globals'].fieldbyname[$('devices').value] = newvalue;
			return true;
		}
		return false;
	}

	callbacks.checkparams = function(box) {
		var needcomma = 0;
		var provider;
		var count = 0;
		$('hasexten').value = 'no';
		if ($('trunkstylevoip').checked) {
			if (!$('username').value.length) {
				alert("When using VoIP, the username must not be empty!");
				return true;
			}
			provider = $('provider').stored_config.catbyname[$('provider').value];
			$('trunkname').value = $('provider').options[$('provider').selectedIndex].innerHTML + " - " + $('username').value;
			$('hassip').value = provider.fieldbyname['hassip'];
			$('hasiax').value = provider.fieldbyname['hasiax'];
			$('callerid').value = '';
			for (var x=0;x<$('zapchan').options.length;x++)
				$('zapchan').options[x].selected = false;
			$('zapchan').value = '';
		} else if ($('trunkstyleanalog').checked) {
			if (!$('zapchan').value) {
				alert("When using Analog, at least one port must be selected.");
				return true;
			}
			count = 0;
			$('trunkname').value = "";
			for (var x=0;x<$('zapchan').options.length;x++) {
				if ($('zapchan').options[x].selected) {
					if (needcomma)
						$('trunkname').value += ","
					needcomma = 1;
					$('trunkname').value += $('zapchan').options[x].value;
					count++;
				}
			}
			if (count > 1)
				$('trunkname').value = "Ports " + $('trunkname').value;
			else
				$('trunkname').value = "Port " + $('trunkname').value;
			$('callerid').value = 'asreceived';
			$('hassip').value = 'no';
			$('hasiax').value = 'no';
			$('callerid').value = 'asreceived';
		} else {
			alert("A trunk must be either Analog or VoIP.");
			return true;
		}
		return false;
	}
	callbacks.newcategory = function() {
		var tmp = null;
		var x;
		if ($('devices').stored_config.catbyname['general'])
			tmp = objcopy($('devices').stored_config.catbyname['general']);
		if (tmp) {
			x = 1;
			while($('devices').stored_config.catbyname['trunk_' + x]) x++;
			tmp.name = 'trunk_' + x;
		}
		tmp.fieldbyname['hasexten'] = 'no';
		return tmp;
	}
	callbacks.identifier = "extension";
	
	phonecallbacks.format = function(t) {
		if (t.fieldbyname['port'] == 'fxs')
			return "Analog Port #" + t.name;
		return null;
	}

	phonecallbacks.loaded = function() {
		parent.astmanEngine.config2list("providers.conf", $('provider'), provwidgets, providercallbacks);
	}
	
	function activateanalogvoip() {
		if ($('trunkstyleanalog').checked) 
			new Rico.Effect.Size('analog', null, 450, 120, 8);
		else if ($('trunkstylevoip').checked) {
			new Rico.Effect.Size('analog', null, 1, 120, 8, {complete:function() { $('analog').style.height = '0'; }});
			$('voip').style.height = 450;
		}
			
	}
	
	function localajaxinit() {
		$('devices').contentEditable = 'false';
		$('zapchan').splitchar=',';
		$('trunkstyleanalog').altonclick = $('trunkstyleanalog').onclick;
		$('trunkstyleanalog').onclick = null;
		$('trunkstylevoip').altonclick = $('trunkstylevoip').onclick;
		$('trunkstylevoip').onclick = null;
		for (var x in fieldnames) {
			widgets[fieldnames[x]] = $(fieldnames[x]);
			widgets[fieldnames[x]].disabled = true;
		}
		for (var x in provfieldnames) {
			provwidgets[provfieldnames[x]] = $(provfieldnames[x]);
			provwidgets[provfieldnames[x]].disabled = true;
		}
		parent.astmanEngine.config2list("zapscan.conf", $('zapchan'), new Array(), phonecallbacks);
	}
</script>


<body id="foo" onload="localajaxinit()">

<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold">User and Phone Configuration</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="mainscreenTable" align="center">
	<tr valign="top">
		<td colspan='2'>
		Trunks:
		</td>
	</tr>
	<tr valign="top">
		<td>
		<select disabled size="15" id="devices" style="width:220px">
		<option>Loading...</option>
		</select>
		</td>
		<td colspan='3'>
		<div id='cabinet' style='height:0;width:0;overflow:hidden'>
			<select id='hiddenglobals'></select>
		</div>
		<div id='adjustments' style='width:350'>
		<table cellspacing='0' cellpadding='0'>
			<tr><td>
				<input name='trunkstyle' type='radio' id='trunkstyleanalog' onclick='activateanalogvoip()' value='analog'>Analog
				<input name='trunkstyle' type='radio' id='trunkstylevoip' onclick='activateanalogvoip()' value='voip'>VoIP
			</td></tr>
			<tr valign="top"><td>
				<input type='hidden' id='name'>
				<input type='hidden' id='trunkname'>
				<input type='hidden' id='hasiax'>
				<input type='hidden' id='hassip'>
				<input type='hidden' id='hasexten'>
				<input type='hidden' id='callerid'>
				<div id='analogvoipcontainer' style='height:450;overflow:hidden'>
				<div id='analog' style='height:0;overflow:hidden'>
				<table>
				<tr><td style='width:80px' valign='top'>Lines:</td><td><select size="12" multiple='true' id='zapchan' style='width:200px'></select></td></tr>
				<tr><td colspan='2' style='width:80px' valign='top' align='center'>
					<div style='width:250'>
						<i>Use CTRL+click and/or SHIFT+click to select more than one port.</i>
					</div>
				</td></tr>
				</table>
				</div>
				<div id='voip' style='height:0;overflow:hidden'>
				<table>
				<tr><td style='width:80px' valign='top'>Provider:</td><td><select size='6' id='provider' style='width:200px' altonchange='selectprovider()'></select></td></tr>
				<tr><td colspan='2' align='center'><div style="height:15px" id='status'></div></td></tr>
				<tr><td colspan='2' align='center'><img id='providerlogo' style='visibility:hidden;width:230px;height:72px'></td></tr>
				<tr><td colspan='2' align='center'><div id='providerdesc' align='left' style='width:230px;height:100px'></div></td></tr>
				<tr><td>Username:</td><td><input size='20' id='username'></td></tr>
				<tr><td>Password:</td><td><input size='5' id='secret'></td></tr>
				</table>
				</div>
				</div>
			</td>
			</tr>
			</tr>
		</table>
		</div>
		</td></tr>				
		<tr>
		<td align='center'>
			<table>
			<tr align='center'><td>
			<input style='width:80' type='button' id='new' value='New'>
			</td><td>
			<input style='width:80' type='button' id='delete' value='Delete'>
			</td></tr>
			</table>
		</td>
		<td colspan='1' align='right'>
				<input style='width:80' type='button' id='save' value='Save'>
				&nbsp;
				<input style='width:80' type='button' id='cancel' value='Cancel'>
				&nbsp;
		</td>
	</tr><tr>
	</tr>
</table>
</div>
</body>
